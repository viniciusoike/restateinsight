{
  "hash": "661f369e17e0d90dc3b6d9293f30e12e",
  "result": {
    "markdown": "---\ntitle: 'Indo além: empilhando áreas'\ndate: '2023-09-07'\ncategories: ['data-visualization', 'ggplot2', 'tutorial-R']\ndescription: \"Post intermediário que ensina a fazer gráficos de área no R usando o pacote ggplot2.\"\ntitle-block-banner: true\nimage: \"/static/ggplot2_area.png\"\nimage-alt: \"/static/ggplot2_area.png\"\npage-layout: article\nexecute: \n  message: false\n  warning: false\nformat:\n  html:\n    code-fold: false\n    code-tools: true\nfreeze: true\ndraft: true\n---\n\n\n\n\n# Gráfico de Área\n\nGráficos de área ajudam a visualizar a dinâmica de um conjunto de valores ao longo do tempo. Essencialmente, um gráfico de área é criado empilhando pequenos gráficos de linha uns sobre os outros e preenchendo a área dentre as linhas com cores. Isto permite que se veja a tendência geral dos dados, assim como a contribuição de cada grupo para o resultado total.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-1-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\nNeste post, vamos discutir como montar um gráfico de área usando o pacote `ggplot2` no R. Primeiro, vamos entender os elementos básicos deste tipo de gráfico usando um exemplo com dados simulados. Depois, vamos explorar um caso aplicado, analisando as concessões de crédito imobiliário no Brasil.\n\n## ggplot2\n\nAntes de mais nada, precisamos instalar e carregar alguns pacotes. Assim como em posts anteriores, além do pacote `ggplot2` vamos utilizar alguns pacotes auxiliares para facilitar a manipulação dos dados.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Instala o pacote ggplot2 (se necessário)\ninstall.packages(c(\"dplyr\", \"tidyr\", \"ggplot2\", \"RcppRoll\", \"GetBCBData\"))\n\n# Carrega os pacotes\nlibrary(\"ggplot2\")\n# Manipulação de dados\nlibrary(\"dplyr\")\nlibrary(\"tidyr\")\nlibrary(\"RcppRoll\")\n# Importar dados da API do Banco Central do Brasil\nlibrary(\"GetBCBData\")\n```\n:::\n\n\nPrimeiro, vamos simular alguns dados para o nosso gráfico de área. No primeiro exemplo vamos montar aum base de dados (`tibble`) com os valores de uma série de vendas anuais de 2000 a 2020.\n\nA coluna `ano` é uma variável contínua de 2000 a 2005. As colunas `venda_a`, `venda_b` e `venda_c` representam números hipotéticos de venda três lojas distintas (\"a\", \"b\" e \"c\").\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntbl <- tibble(\n  ano = 2000:2005,\n  venda_1 = c(20, 24, 23, 27, 25, 26),\n  venda_2 = c(30, 22, 17, 23, 21, 18),\n  venda_3 = c(18, 19, 17, 17, 18, 19)\n)\n```\n:::\n\n\nA tabela tem a forma abaixo.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-condensed table-responsive table-hover table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:center;\"> ano </th>\n   <th style=\"text-align:center;\"> venda_1 </th>\n   <th style=\"text-align:center;\"> venda_2 </th>\n   <th style=\"text-align:center;\"> venda_3 </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> 2000 </td>\n   <td style=\"text-align:center;\"> 20 </td>\n   <td style=\"text-align:center;\"> 30 </td>\n   <td style=\"text-align:center;\"> 18 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2001 </td>\n   <td style=\"text-align:center;\"> 24 </td>\n   <td style=\"text-align:center;\"> 22 </td>\n   <td style=\"text-align:center;\"> 19 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2002 </td>\n   <td style=\"text-align:center;\"> 23 </td>\n   <td style=\"text-align:center;\"> 17 </td>\n   <td style=\"text-align:center;\"> 17 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2003 </td>\n   <td style=\"text-align:center;\"> 27 </td>\n   <td style=\"text-align:center;\"> 23 </td>\n   <td style=\"text-align:center;\"> 17 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2004 </td>\n   <td style=\"text-align:center;\"> 25 </td>\n   <td style=\"text-align:center;\"> 21 </td>\n   <td style=\"text-align:center;\"> 18 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2005 </td>\n   <td style=\"text-align:center;\"> 26 </td>\n   <td style=\"text-align:center;\"> 18 </td>\n   <td style=\"text-align:center;\"> 19 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nUsamos a função `geom_area()` para criar um gráfico de área. Esta função recebe os argumentos `x` e `y`, que mapeiam as variáveis de dados no eixo x e no eixo y do gráfico, respectivamente.\n\nO código abaixo monta um gráfico de área que mostra o número de vendas na loja 1.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = tbl) +\n  geom_area(aes(x = ano, y = venda_1))\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-5-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\nPara adicionar as vendas das outras lojas precisamos remodelar o formato dos nossos dados. Nossos dados estão em formato \"wide\", no qual cada variável (vendas) é uma coluna distinta e cada observação é uma linha. O `ggplot2` segue os princípios de `tidy data` e funciona melhor com dados em formato \"long\", onde cada linha é uma observação única.\n\nConvertemos os nossos dados para o formato \"long\" utilizando a função `pivot_longer()` da seguinte maneira:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlong <- pivot_longer(\n  tbl,\n  venda_1:venda_3,\n  names_to = \"grupo\",\n  values_to = \"total\")\n```\n:::\n\n\nAgora cada linha representa o número de vendas em uma loja específica e num ano específico.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-condensed table-responsive table-hover table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:center;\"> ano </th>\n   <th style=\"text-align:center;\"> grupo </th>\n   <th style=\"text-align:center;\"> total </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> 2000 </td>\n   <td style=\"text-align:center;\"> venda_1 </td>\n   <td style=\"text-align:center;\"> 20 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2000 </td>\n   <td style=\"text-align:center;\"> venda_2 </td>\n   <td style=\"text-align:center;\"> 30 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2000 </td>\n   <td style=\"text-align:center;\"> venda_3 </td>\n   <td style=\"text-align:center;\"> 18 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2001 </td>\n   <td style=\"text-align:center;\"> venda_1 </td>\n   <td style=\"text-align:center;\"> 24 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2001 </td>\n   <td style=\"text-align:center;\"> venda_2 </td>\n   <td style=\"text-align:center;\"> 22 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2001 </td>\n   <td style=\"text-align:center;\"> venda_3 </td>\n   <td style=\"text-align:center;\"> 19 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2002 </td>\n   <td style=\"text-align:center;\"> venda_1 </td>\n   <td style=\"text-align:center;\"> 23 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2002 </td>\n   <td style=\"text-align:center;\"> venda_2 </td>\n   <td style=\"text-align:center;\"> 17 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2002 </td>\n   <td style=\"text-align:center;\"> venda_3 </td>\n   <td style=\"text-align:center;\"> 17 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2003 </td>\n   <td style=\"text-align:center;\"> venda_1 </td>\n   <td style=\"text-align:center;\"> 27 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2003 </td>\n   <td style=\"text-align:center;\"> venda_2 </td>\n   <td style=\"text-align:center;\"> 23 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2003 </td>\n   <td style=\"text-align:center;\"> venda_3 </td>\n   <td style=\"text-align:center;\"> 17 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2004 </td>\n   <td style=\"text-align:center;\"> venda_1 </td>\n   <td style=\"text-align:center;\"> 25 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2004 </td>\n   <td style=\"text-align:center;\"> venda_2 </td>\n   <td style=\"text-align:center;\"> 21 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2004 </td>\n   <td style=\"text-align:center;\"> venda_3 </td>\n   <td style=\"text-align:center;\"> 18 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2005 </td>\n   <td style=\"text-align:center;\"> venda_1 </td>\n   <td style=\"text-align:center;\"> 26 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2005 </td>\n   <td style=\"text-align:center;\"> venda_2 </td>\n   <td style=\"text-align:center;\"> 18 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2005 </td>\n   <td style=\"text-align:center;\"> venda_3 </td>\n   <td style=\"text-align:center;\"> 19 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nAgora que temos nossos dados preparados, podemos montar nosso gráfico de área. Além dos argumentos `x` e `y`, também vamos especificar o argumento `fill` para indicar qual variável deve ser utilizada para preencher as cores entre as linhas.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = long) +\n  geom_area(aes(x = ano, y = total, fill = grupo))\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-8-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\nNo gráfico acima, as áreas são empilhadas umas sobre as outras. Tipicamente, os grupos com os valores mais altos devem estar no topo da pilha e os grupos com valores mais baixos, na parte inferior. Na prática, a ordem é determinada pela ordem da variável `fill`.\n\nVariáveis categóricas no `R` sempre devem ser do tipo `factor`. Um `factor` é um tipo especial de string que possui um ordenamento (`levels`) que define a relação hierárquica entre os grupos.\n\nImagine que você tem uma série de avaliações que podem ser \"Bom\", \"Médio\" ou \"Ruim\" armazenadas num vetor chamado `feedback`. Para estruturar esta variável como `factor` é preciso definir qual a ordem destes valores. No exemplo abaixo define-se uma relação crescente: de \"Ruim\" até \"Bom\".\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfeedback <- c(\"Bom\", \"Bom\", \"Médio\", \"Ruim\", \"Médio\", \"Médio\")\nsatisfacao <- factor(feedback, levels = c(\"Ruim\", \"Médio\", \"Bom\"))\n```\n:::\n\n\nNo caso do gráfico acima, como não definimos a ordem da variável categórica, o `ggplot2` tenta adivinha-la. De maneira geral, o `ggplot` respeita a ordem alfabética e a ordem de grandeza numérica. Por isso, no gráfico acima a ordem foi `venda_1`, `venda_2` e `venda_3`.\n\nPara definir a ordem dos grupos é preciso criar uma variável do tipo `factor` e especificar o argumento `levels`. O exemplo abaixo define uma nova ordem para os grupos o que resulta num gráfico diferente.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlong_reordenado <- long |> \n  dplyr::mutate(\n    grupo = factor(grupo, levels = c(\"venda_3\", \"venda_1\", \"venda_2\"))\n  )\n\nggplot(data = long_reordenado) +\n  geom_area(aes(x = ano, y = total, fill = grupo))\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-10-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Elementos estéticos\n\nOs principais elementos estéticos da função `geom_area()` são\n\n-   `fill` - A cor que preenche a área abaixo da linha.\n-   `color` - A cor da linha.\n-   `alpha` - O nível de transparência das cores.\n-   `linetype` - O tipo de linha (tracejado).\n-   `linewidth` - A espessura da linha.\n\nOs elementos estéticos podem receber dois tipos de valores: constantes ou variáveis. Uma constante é simplesmente um valor (número, texto, etc.) enquanto uma variável é o nome de alguma coluna da base de dados.\n\nNo exemplo abaixo o elemento `alpha`, que controla o nível de transparência é constante `alpha = 0.5` e é aplicado de forma uniforme sobre todo o gráfico. Já o elemento `fill` é variável e definido como `fill = grupo` dentro da função `aes()`. Quando mapeamos uma coluna/variável para um elemento estético sempre usamos a função `aes()` da mesma maneira como fazemos para mapear as variáveis `x` e `y`.\n\nComo a variável `grupo` é mapeada usamos uma função especial `scale_fill_manual()` para definir as suas cores e para controlar a legenda.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = long) +\n  geom_area(aes(x = ano, y = total, fill = grupo), alpha = 0.5) +\n  # Define as cores e controla a legenda\n  scale_fill_manual(\n    # Título da legenda\n    name = \"Lojas\",\n    # Texto da legenda\n    labels = c(\"Loja 1\", \"Loja 2\", \"Loja 3\"),\n    # Cores\n    values = c(\"#0a9396\", \"#ee9b00\", \"#ae2012\"))\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-11-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n# Exemplo: Crédito Direcionado\n\nAgora vamos seguir para um exemplo aplicado. Vamos explorar o volume de crédito direcionado para pessoas físicas no Brasil. Para importar os dados vamos usar o pacote `GetBCBData` que interage com a API do Banco Central do Brasil e que traz os dados já no formato \"long\" dentro do `R`.\n\nO código abaixo importa as séries de tempo e identifica elas. A manipulação de dados é feita usando funções do pacote `dplyr`. Neste momento, não é necessário entender a fundo a manipulação dos dados.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Códigos numéricos das séries de crédito direcionado para Pessoas Físicas\ncodigos <- c(20701, 20704, 20708, 20712, 20713)\n# Importa as séries a partir de 01/mar/2011\nseries <- gbcbd_get_series(codigos, first.date = as.Date(\"01-03-2011\"))\n\n# Cria uma coluna chamada linha_credito indicando qual a linha de crédito\nseries <- series |> \n  dplyr::mutate(\n    linha_credito = dplyr::case_when(\n      id.num == 20701 ~ \"Rural\",\n      id.num == 20704 ~ \"Imobiliário\",\n      id.num == 20708 ~ \"BNDES\",\n      id.num == 20712 ~ \"Microcrédito\",\n      id.num == 20713 ~ \"Outro\"\n    )\n  )\n```\n:::\n\n\nVamos montar um gráfico simples que mostra a composição e evolução do crédito direcionado.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Plota o gráfico\nggplot(data = series) +\n  geom_area(aes(x = ref.date, y = value, fill = linha_credito))\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-13-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\nO gráfico acima pode ser melhorado de diversas formas. Vamos explorar algumas opções.\n\n### Reordenando os grupos\n\nPelo gráfico, vemos que o crédito rural e o crédito imobiliário são as linhas de crédito mais expressivas. O código abaixo reordena o nível dos grupos para dar mais destaque ao crédito imobiliário e ao crédito rural.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nseries <- series |> \n  dplyr::mutate(\n    linha_credito = factor(\n      linha_credito,\n      levels = c(\"Imobiliário\", \"Rural\", \"BNDES\", \"Microcrédito\", \"Outro\"))\n    )\n\nggplot(data = series) +\n  geom_area(aes(x = ref.date, y = value, fill = linha_credito))\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-14-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n### Trocando as cores\n\nA escolha automática de cores do `ggplot` raramente é satisfatória. Podemos escolher novas cores manualmente usando a função `scale_fill_manual()`. Além disso, também adicionamos um título mais apropriado para a legenda das cores.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = series) +\n  geom_area(aes(x = ref.date, y = value, fill = linha_credito)) +\n  # Define a cor dos grupos e adiciona um título na legenda\n  scale_fill_manual(\n    name = \"Linha de Crédito\",\n    values = c(\"#005f73\", \"#94d2bd\", \"#ee9b00\", \"#bb3e03\", \"#9b2226\")\n    )\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-15-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\nUma solução mais prática é utilizar uma paleta pré-definida de cores. A função `scale_fill_brewer()`, por exemplo, possui várias paletas importadas do [Color Brewer](https://colorbrewer2.org).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = series) +\n  geom_area(aes(x = ref.date, y = value, fill = linha_credito)) +\n  # Define a cor dos grupos e adiciona um título na legenda\n  scale_fill_brewer(\n    name = \"Linha de Crédito\",\n    type = \"qual\",\n    palette = 6\n    )\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-16-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n### Ajustando eixos e legendas\n\nPara ajustar os eixos utilizamos as funções `scale_`. No código abaixo a função `scale_y_continuous()` altera o eixo-y de três formas: primeiro, o argumento `breaks` define os números que devem ser destacados no eixo; segundo, o argumento `labels` modifica a aparência destes números no gráfico; por fim, `limits` estabelece os limites inferior e superior do eixo-y.\n\nA função `scales::label_number(big.mark = \".\")` pode parecer um pouco confusa, mas ela simplesmente informa que o sinal de ponto \".\" deve ser utilizado como separador de milhar. Assim `10000` é convertido para `10.000`. Na prática ela faz o mesmo que a função base `format()`.\n\nPor fim, colocamos a legenda na parte superior do gráfico usando a função `theme()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = series) +\n  geom_area(aes(x = ref.date, y = value, fill = linha_credito)) +\n  scale_fill_brewer(name = \"Linha de Crédito\", type = \"qual\", palette = 6) +\n  # Modifica o comportamento do eixo-y\n  scale_y_continuous(\n    breaks = seq(0, 60000, 10000),\n    labels = scales::label_number(big.mark = \".\"),\n    limits = c(0, 60000)\n    ) +\n  # Coloca a legenda na parte superior do gráfico.\n  theme(legend.position = \"top\")\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-17-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n### Adicionando títulos e um tema\n\nPara adicionar títulos o modificar o nome de cada eixo utilizamos a função `labs()` como no código abaixo. Para este gráfico escolhemos um tema neutro com fundo branco `theme_minimal()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = series) +\n  geom_area(aes(x = ref.date, y = value, fill = linha_credito)) +\n  scale_fill_brewer(name = \"Linha de Crédito\", type = \"qual\", palette = 6) +\n  scale_y_continuous(\n    breaks = seq(0, 60000, 10000),\n    labels = scales::label_number(big.mark = \".\"),\n    limits = c(0, 60000)) +\n  # Define o título e o nome dos eixos\n   labs(\n    title = \"Evolução das concessões de crédito direcionadas\",\n    caption = \"Fonte: Banco Central do Brasil.\",\n    # Omite o nome do eixo-x\n    x = NULL,\n    y = \"Milhões (R$)\"\n    ) +\n  # Insere um tema minimalista com fundo branco\n  theme_minimal() +\n  theme(legend.position = \"top\")\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-18-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n### Suavizando a série\n\nPor fim, pode-se suavizar a série para reduzir o impacto da sazonalidade na visualização. Isto não é uma decisão puramente estética, pois modifica os dados e troca a ênfase do gráfico: enxerga-se, agora, a tendência dos dados.\n\nHá muitas maneiras de se fazer isto. Pode-se, por exemplo, dessazonalizar os dados usando X-13 ARIMA; pode-se extrair a tendência das séries utilizando algum filtro linear como de médias móveis, Holt-Winters, filtro HP, etc.\n\nUma escolha bastante simples é simplesmente somar as últimas doze observações e criar uma janela móvel. Assim temos as concessões acumuladas nos últimos doze meses.\n\nPara calcular esta soma utilizamos a função `RcppRoll::roll_sumr()`. Como a magnitude dos valores aumenta, dividimos o valor final por mil (agora os valores estão em bilhões de reais).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nseries <- series |> \n  dplyr::group_by(linha_credito) |> \n  dplyr::mutate(soma_12 = RcppRoll::roll_sumr(value, n = 12) / 1000) |> \n  dplyr::ungroup()\n\nggplot(data = series) +\n  geom_area(aes(x = ref.date, y = soma_12, fill = linha_credito)) +\n  geom_hline(yintercept = 0) +\n  scale_fill_brewer(\n    name = \"Linha de Crédito\",\n    type = \"qual\",\n    palette = 6) +\n  labs(\n    title = \"Evolução das concessões de crédito direcionadas\",\n    caption = \"Fonte: Banco Central do Brasil.\",\n    x = NULL,\n    y = \"R$ (bilhões)\") +\n  theme_minimal() +\n  theme(\n    legend.position = \"top\"\n  )\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-19-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n# Exemplo: Demografia\n\nVamos explorar algumas tendências demográficas do Brasil. Os dados são do projeto de projeções populacionais da ONU (*World Population Prospects*) e estão disponíves em formato `csv` e `xlsx` no [site](https://population.un.org/wpp/Download/Standard/MostUsed/).\n\nA base que vamos usar foca somente em dados do Brasil e do mundo. A tabela contém as estimativas passadas e projeções futuras da população em grupos de cinco anos (0-4, 5-9, 10-14, ..., 100+).\n\nPara ler os dados usamos a função `read_csv()`. Note que esta função está importando os dados diretamente da internet.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Importa a base de dados\nwpp <- read_csv(\"data/...\")\n\n# Seleciona apenas dados sobre o Brasil entre os anos de 2000 e 2050.\nbrazil <- wpp |> \n  dplyr::filter(\n    location == \"Brazil\",\n    year >= 2000,\n    year <= 2050\n  )\n\n# Soma o total da população a cada ano\npop <- brazil |> \n  dplyr::group_by(year) |> \n  dplyr::summarise(population = sum(pop_total))\n\n# Soma o total da população por grupos de idade a cada ano\npop_group <- brazil |> \n  dplyr::group_by(year, age_group) |> \n  dplyr::summarise(population = sum(pop_total))\n```\n:::\n\n\nA tabela `pop` apresenta a população total projetada para cada ano e tem o formato abaixo.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nhead(pop)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-condensed table-responsive table-hover table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:center;\"> year </th>\n   <th style=\"text-align:center;\"> population </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> 2000 </td>\n   <td style=\"text-align:center;\"> 174693 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2001 </td>\n   <td style=\"text-align:center;\"> 177055 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2002 </td>\n   <td style=\"text-align:center;\"> 179369 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2003 </td>\n   <td style=\"text-align:center;\"> 181584 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2004 </td>\n   <td style=\"text-align:center;\"> 183674 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2005 </td>\n   <td style=\"text-align:center;\"> 185770 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nVamos combinar a função `geom_area()` com outras duas: uma para fazer pontos e outra para traçar uma linha horizontal no zero do eixo-y. Para desenhar os pontos vamos utilizar a função `geom_point()` e para traçar a linha horizontal, `geom_hline()`. Para manter um padrão de cores vamos escolher uma constante `#2a9d8f` (um tom de verde-azulado).\n\nO código abaixo gera uma espécie de gráfico de linha, com pontos, com uma região sombreada. Note que os elementos estéticos `fill` e `color` são constantes.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncol = \"#2a9d8f\"\n\nggplot(data = pop, aes(x = year, y = population)) +\n  geom_area(alpha = 0.5, fill = col, color = col) +\n  # Linha horizontal no 0\n  geom_hline(yintercept = 0) +\n  # Pontos para destacar as observações\n  geom_point(color = col)\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-24-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\nPodemos combinar o gráfico acima com a função `facet_wrap()` para montar quatro gráficos, mostrando a evolução da população dentro de cada um dos grupos.\n\nO grupo de crianças (0 a 14 anos) cai, enquanto o grupo de idosos (65+) aumenta expressivamente. O grupo de adultos (25-64) aumenta até atingir um máximo ao redor de 2040 e depois passa a cair suavemente. Por fim, o grupo de adolescentes/jovens (15-24) cai suavamente.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = pop_group, aes(x = year, y = population)) +\n  geom_area(alpha = 0.5, fill = col, color = col) +\n  geom_hline(yintercept = 0) +\n  geom_point(color = col) +\n  facet_wrap(~age_group)\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-25-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\nAssim como nos exemplos anteriores, podemos também empilhar os grupos e ter uma noção da representatividade de cada um deles no total da população.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data = pop_group) +\n  geom_area(aes(x = year, y = population, fill = age_group)) +\n  scale_fill_brewer(type = \"qual\", palette = 6) +\n  theme(legend.position = \"top\")\n```\n\n::: {.cell-output-display}\n![](10-grafico-de-area_files/figure-html/unnamed-chunk-26-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n# Resumindo\n\nUm dos principais benefícios de usar gráficos de área é que eles permitem visualizar facilmente a tendência geral dos dados e a contribuição de cada grupo individual para o total. No geral, gráficos de área são uma ferramenta útil para visualizar a magnitude da mudança ao longo do tempo e comparar diferentes categorias ou grupos de dados uns com os outros.\n\nNeste post vimos a importância de usar dados em formato \"long\" e de reordenar as variáveis categóricas usando a função `factor()`. Também vimos que elementos estéticos podem assumir valores constantes ou variáveis.\n\nAbaixo seguem algumas recomendações finais na hora de fazer gráficos de área.\n\n1.  Não utilize um gráfico de área para representar mais do 5 ou 6 grupos.\n2.  Escolha manualmente a ordem dos grupos para facilitar a visualização do gráfico.\n3.  Coloque a legenda de cores acima ou abaixo do gráfico para poupar espaço.\n",
    "supporting": [
      "10-grafico-de-area_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
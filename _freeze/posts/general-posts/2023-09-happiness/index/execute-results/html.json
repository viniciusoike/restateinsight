{
  "hash": "e50c21ab7647feecd1e585d4f34eeba0",
  "result": {
    "markdown": "---\ntitle: 'Life Satisfaction and GDP per capita' \ndate: '2023-09-22'\ncategories: ['data-visualization']\ndescription: 'In this post I make a step-by-step replication of a plot from OurWorldInData. The plot shows the correlation between average self-reported life satisfaction and GDP per capita.'\nexecute: \n  message: false\n  warning: false\nformat:\n  html:\n    code-fold: false\n    code-tools: true\n---\n\n\n# Replicating the plot\n\nIn this tutorial post I will replicate this graph, from OurWorldInData (OWID) using `ggplot2`. The original graph is available at [OWID website](https://ourworldindata.org/happiness-and-life-satisfaction#the-link-between-happiness-and-income). The plot shows the correlation between GDP per capita and self-reported happiness. The income data comes from the [World Bank](https://data.worldbank.org/indicator/NY.GDP.PCAP.PP.KD) and is in 2017 constant PPP dollars: this ensures the data is comparable across countries since it accounts for both inflation and different costs of living. The happiness data comes from the [World Happiness Report](https://worldhappiness.report).\n\n\n::: {.cell}\n\n:::\n\n\n![](/static/images/owid_happiness.png)\n\nThis plot has several attractive features including how colors are used to represent continents and how size is used to show the population of each country.\n\nTo follow this tutorial make sure all of the packages below are installed.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n#> Packages needed to replicate the code\nlibrary(ggplot2)\nlibrary(ggrepel)\nlibrary(showtext)\nlibrary(readr)\nlibrary(dplyr)\nlibrary(janitor)\n```\n:::\n\n\n## The Data\n\nThe first step is acquiring the data. Luckily, the csv data is readily available at the OWID website. For convenience I stored a smaller version of the dataset in my Github. The code below imports the data directly into the R session.\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nowid <- readr::read_csv(\n  \"https://github.com/viniciusoike/restateinsight/raw/main/static/data/gdp-vs-happiness.csv\"\n  )\n```\n:::\n\n\nThe data shows both the GDP per capita and the Happiness Indicator for several countries across many years. The code below selects only the most recent that is available for each country.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ndat <- owid |> \n  janitor::clean_names() |> \n  rename(\n    life_satisfaction = cantril_ladder_score,\n    gdppc = gdp_per_capita_ppp_constant_2017_international,\n    pop = population_historical_estimates\n  ) |>\n  filter(!is.na(gdppc), !is.na(life_satisfaction)) |> \n  mutate(gdppc = log10(gdppc)) |> \n  group_by(entity) |> \n  filter(year == max(year)) |> \n  ungroup() |> \n  select(entity, pop, gdppc, life_satisfaction)\n\ndim_continent <- owid |> \n  select(entity, continent) |> \n  filter(!is.na(continent), !is.na(entity)) |> \n  distinct()\n\ndat <- left_join(dat, dim_continent, by = \"entity\")\n```\n:::\n\n\n# The Plot\n\n## Bubbles\n\nThe most essential aspect of this plot is summarized in the code below. The plot shows each country as *bubble*, where the size of the bubble is proportional to its population. The position of each bubble shows the country's GDP per capita (on the horizontal axis) and average life satisfaction (on the vertical axis). Finally, the color of each bubble corresponds to the continent of the country. Since many of the observations overlap the original plot uses a bit of transparency.\n\nNote that I use `shape = 21` to get a special circle with two colors. The `color` argument controls the circle's border while the `fill` argument controls the circle's interior color.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(dat, aes(x = gdppc, y = life_satisfaction)) +\n  geom_point(\n    aes(fill = continent, size = pop),\n    color = \"#A5A9A9\",\n    alpha = 0.8,\n    shape = 21\n    )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n## Highlighting the countries\n\nThis part is mostly manual labor. I create a simple vector with the names of all countries highlighted in the original plot. This vector allows me to create a dummy variable that indicates whether the name of the country should be plotted or not. For increased flexibility I store this as an auxiliar `tibble` called `dftext`. In the end, this didn't make much of a difference but it can be helpful in cases where one needs finer control over the text that is plotted.\n\nI `ggrepel` to avoid overlapping the text labels.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n#> Countries to highlight\nsel_countries <- c(\n  \"Ireland\", \"Qatar\", \"Hong Kong\", \"Switzerland\", \"United States\", \"France\",\n  \"Japan\", \"Costa Rica\", \"Russia\", \"Turkey\", \"China\", \"Brazil\", \"Indonesia\",\n  \"Iran\", \"Egypt\", \"Botswana\", \"Lebanon\", \"Philippines\", \"Bolivia\", \"Pakistan\",\n  \"Bangladesh\", \"Nepal\", \"Senegal\", \"Burkina Faso\", \"Ethiopia\", \"Tanzania\",\n  \"Democratic Republic of Congo\", \"Mozambique\", \" Somalia\", \"Chad\", \"Malawi\",\n  \"Burundi\", \"India\")\n\n#> Auxiliar tibble with names of countries to highlight\ndftext <- dat |> \n  mutate(highlight = if_else(entity %in% sel_countries, entity, NA))\n\n#> Creates a base plot with the bubbles plus the text labels\nbase_plot <- ggplot(dat, aes(x = gdppc, y = life_satisfaction)) +\n  geom_point(\n    aes(fill = continent, size = pop),\n    color = \"#A5A9A9\",\n    alpha = 0.8,\n    shape = 21\n    ) +\n  ggrepel::geom_text_repel(\n    data = dftext,\n    aes(x = gdppc, y = life_satisfaction, label = highlight, color = continent),\n    size = 3\n    )\n\nbase_plot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n## Scales and colors\n\nThe x-axis of the original plot is in a logarithmic scale and its labels highlight specific values (1000, 2000, 5000, ..., 100000). The numbers are formatted with a comma and dollar sign. The y-axis is much more straightforward since the numbers are simple integers ranging from 3 to 7.\n\nThe default size of the bubbles in `ggplot` is small so I use `scale_size_continuous` to increase them. I have no idea how to emulate the original size legend (the circle within a circle) so I omit it.\n\nBoth the interior color of the bubbles and the text follow a particular color scheme. I got the exact colors of the original plot by exporting it to SVG. By default, the legend key inherits its colors. So the legend shows slightly transparent round circles. To get solid colored squares I override this default behavior.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nxbreaks <- c(3, 3.3, 3.7, 4, 4.3, 5)\nxlabels <- c(1000, 2000, 5000, 10000, 20000, 100000)\nxlabels <- paste0(\"$\", format(xlabels, big.mark = \",\", scientific = FALSE))\n\ncolors <- c(\"#A2559C\", \"#00847E\", \"#4C6A9C\", \"#E56E5A\", \"#9A5129\", \"#883039\")\n\nbase_plot <- base_plot +\n  #> Adds labels to the log scale\n  scale_x_continuous(breaks = xbreaks, labels = xlabels) +\n  #> Adds labels to the y-axis scale\n  scale_y_continuous(breaks = 3:7) +\n  #> Increases the size of the bubbles\n  scale_size_continuous(range = c(1, 15)) +\n  #> Adds colors to the bubbles and text labels\n  scale_fill_manual(name = \"\", values = colors) +\n  scale_color_manual(name = \"\", values = colors) +\n  #> Removes the size and color legend\n  guides(\n    color = \"none\",\n    size = \"none\",\n    #> Override default behaviour to get solid colors\n    fill = guide_legend(override.aes = list(shape = 22, alpha = 1))\n    )\n\nbase_plot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n## Text elements\n\nThe code below inserts the other textual elements of the plot.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n#> Caption\ncaption <- \"Source: World Happiness Report (2023), Data compiled from multiple sources by World Bank\\nNote: GDP per capita is expressed in international-$ at 2017 prices.\\nOurWorldInData.org/happiness-and-life-satisfacation/\"\n#> Subtitle\nsubtitle <- \"Self-reported life satisfaction is measured on a scale ranging from 0-10, where 10 is the highest possible life\\nsatisfaction. GDP per capita is adjusted for inflation and differences in the cost of living between countries.\"\n\n#> Adds textual elements to base plot\nbase_plot <- base_plot +\n  labs(\n    title = \"Self-reported life satisfaction vs. GDP per capita, 2022\",\n    subtitle = subtitle,\n    x = \"GDP per capita\",\n    y = \"Life satisfaction (country average; 0-10)\",\n    caption = caption\n    )\n\nbase_plot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n## Font\n\nLooking at the source code of the page it seems that most of the text is displayed in [Lato](https://fonts.google.com/specimen/Lato?query=lato) while the titles are displayed in [Playfair Display](https://fonts.google.com/specimen/Playfair+Display). I import both fonts using `font_add_google` and load them using `showtext`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfont_add_google(\"Playfair Display\", \"Playfair Display\")\nfont_add_google(\"Lato\", \"Lato\")\n\nshowtext::showtext_auto()\n```\n:::\n\n\n## Theme\n\nThis step really does the magic.\n\nFor the theme, I use `theme_minimal` as a template, since its fairly similar to the OWID graphic. I start by removing the minor panel grids from the background and changing the major panel grids. Then, I alter the textual elements of the graphic and make minor tweaks to the legend and plot margins.\n\nAll of the text is in different shades of gray with exception of the title, the axis titles, and the legend text which are all in plain black. Figuring out the sizes of the text is mostly a trial and error process. Almost all of the text is small except the main title and the text on the axes.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nbase_plot +\n  theme_minimal() +\n  theme(\n    #> Background grid\n    panel.grid.minor = element_blank(),\n    panel.grid.major = element_line(linetype = 3, color = \"#DDDDDD\"),\n    \n    #> Text elements (change font)\n    text = element_text(family = \"Lato\"),\n    title = element_text(family = \"Lato\"),\n    #> Caption, title, and subtitle\n    plot.caption = element_text(color = \"#777777\", hjust = 0, size = 8),\n    plot.title = element_text(\n      color = \"#444444\",\n      family = \"Playfair Display\",\n      size = 18),\n    plot.subtitle = element_text(color = \"#666666\", size = 11),\n    #> Axis text\n    axis.title = element_text(color = \"#000000\", size = 9),\n    axis.text = element_text(color = \"#666666\", size = 12),\n    #> Legend\n    legend.key.size = unit(5, \"pt\"),\n    legend.position = \"right\",\n    legend.text = element_text(size = 10),\n    #> Margin\n    plot.margin = margin(rep(10, 4))\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n# Final result\n\nThe graphic below is the final version. For convenience I collect all of the code needed to reproduce this graphic into two chunks. I also change `geom_text_repel` for `geom_label_repel` to insert a small white background on the names of the countries to improve readability.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\n#> Theme\ntheme_owid <- theme_minimal() +\n  theme(\n    panel.grid.minor = element_blank(),\n    panel.grid.major = element_line(linetype = 3, color = \"#DDDDDD\"),\n    \n    text = element_text(family = \"Lato\"),\n    title = element_text(family = \"Lato\"),\n    \n    plot.caption = element_text(color = \"#777777\", hjust = 0, size = 8),\n    plot.title = element_text(\n      color = \"#444444\",\n      family = \"Playfair Display\",\n      size = 18),\n    plot.subtitle = element_text(color = \"#666666\", size = 11),\n    \n    axis.title = element_text(color = \"#000000\", size = 9),\n    axis.text = element_text(color = \"#666666\", size = 12),\n    \n    legend.key.size = unit(5, \"pt\"),\n    legend.position = \"right\",\n    legend.text = element_text(size = 10),\n    \n    plot.margin = margin(rep(10, 4))\n  )\n\n#> Countries to highlight\nsel_countries <- c(\n  \"Ireland\", \"Qatar\", \"Hong Kong\", \"Switzerland\", \"United States\", \"France\",\n  \"Japan\", \"Costa Rica\", \"Russia\", \"Turkey\", \"China\", \"Brazil\", \"Indonesia\",\n  \"Iran\", \"Egypt\", \"Botswana\", \"Lebanon\", \"Philippines\", \"Bolivia\", \"Pakistan\",\n  \"Bangladesh\", \"Nepal\", \"Senegal\", \"Burkina Faso\", \"Ethiopia\", \"Tanzania\",\n  \"Democratic Republic of Congo\", \"Mozambique\", \" Somalia\", \"Chad\", \"Malawi\",\n  \"Burundi\", \"India\")\n\ndftext <- dat |> \n  mutate(highlight = if_else(entity %in% sel_countries, entity, NA))\n\n#> x-axis labels\nxbreaks <- c(3, 3.3, 3.7, 4, 4.3, 5)\nxlabels <- c(1000, 2000, 5000, 10000, 20000, 100000)\nxlabels <- paste0(\"$\", format(xlabels, big.mark = \",\", scientific = FALSE))\n\n#> Colors\ncolors <- c(\"#A2559C\", \"#00847E\", \"#4C6A9C\", \"#E56E5A\", \"#9A5129\", \"#883039\")\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nggplot(dat, aes(x = gdppc, y = life_satisfaction)) +\n  geom_point(\n    aes(fill = continent, size = pop),\n    color = \"#A5A9A9\",\n    alpha = 0.8,\n    shape = 21\n    ) +\n  ggrepel::geom_label_repel(\n    data = dftext,\n    aes(x = gdppc, y = life_satisfaction, label = highlight, color = continent),\n    size = 3,\n    force = 5,\n    family = \"Lato\",\n    label.padding = unit(0.05, \"lines\"),\n    label.size = NA\n    ) +\n  scale_x_continuous(breaks = xbreaks, labels = xlabels) +\n  scale_y_continuous(breaks = 3:7) +\n  scale_size_continuous(range = c(1, 15)) +\n  scale_fill_manual(name = \"\", values = colors) +\n  scale_color_manual(name = \"\", values = colors) +\n  guides(\n    color = \"none\",\n    size = \"none\",\n    fill = guide_legend(override.aes = list(shape = 22, alpha = 1))\n    ) +\n  labs(\n    title = \"Self-reported life satisfaction vs. GDP per capita, 2022\",\n    subtitle = subtitle,\n    x = \"GDP per capita\",\n    y = \"Life satisfaction (country average; 0-10)\",\n    caption = caption\n    ) +\n  theme_owid\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){fig-align='center' width=100%}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
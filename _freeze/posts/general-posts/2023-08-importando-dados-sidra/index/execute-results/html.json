{
  "hash": "81eb0cacaafbefa6db098728e5c7b570",
  "result": {
    "markdown": "---\ntitle: Importando dados do SIDRA\ndate: '2023-08-10'\ncategories: ['data-science', 'economia', 'tutorial-R']\ndescription: 'Importando dados abertos do IBGE via API usando o sidrar no R.'\nimage: \"/static/images/thumbnails/sidra_logo.png\"\nimage-alt: \"/static/images/thumbnails/sidra_logo.png\"\n---\n\n::: {.cell}\n\n:::\n\n\n\n\nO SIDRA, ou Sistema IBGE de Recuperação Automática, é um sistema automatizado de coleta de dados do IBGE, que disponbiliza tabelas das várias pesquisas feitas pelo IBGE. O sistema é centralizado no [site](https://sidra.ibge.gov.br/home/pnadcm). Encontrar pesquisas e dados pode não ser fácil e, em geral, exige conhecimento prévio sobre as pesquisas do IBGE. O site oferece uma página de [ajuda](https://sidra.ibge.gov.br/ajuda).\n\nNeste post vou comentar mais especificamente sobre o pacote `sidrar` que dialoga diretamente com a API do SIDRA para importar tabelas diretamente para dentro do `R`. O pacote tem duas funções centrais:\n\n-   `info_sidra()` - busca os metadados e informações de uma tabela.\n-   `get_sidra()` - importa uma tabela do SIDRA seguindo um conjunto de parâmetros.\n\n# R\n\nPrimeiro, temos que instalar o pacote `sidrar` e chamá-lo usando a função `library()`. Além disso, para a primeira parte deste tutorial mostro também como utilizar os pacotes `dplyr`, `tidyr` e `janitor` para limpar os dados.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Instale o pacote (caso necessário)\ninstall.packages(\"sidrar\")\n# Outros pacotes usados neste tutorial\ninstall.packages(c(\"janitor\", \"dplyr\", \"tidyr\"))\n\nlibrary(\"sidrar\")\nlibrary(\"janitor\")\nlibrary(\"dplyr\")\nlibrary(\"tidyr\")\n```\n:::\n\n\n# Importando dados\n\nVamos começar olhando para a tabela de estimativas da população dos municípios. A tabela [6579](https://sidra.ibge.gov.br/tabela/6579) reúne os dados da pesquisa \"Estimativas da População\", uma contagem anual da população de todos os municípios do Brasil.\n\nPrimeiro vamos usar a função `info_sidra` para verificar o conteúdo desta tabela.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ninfo_sidra(6579)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$table\n[1] \"Tabela 6579: População residente estimada\"\n\n$period\n[1] \"2001, 2002, 2003, 2004, 2005, 2006, 2008, 2009, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021\"\n\n$variable\n   cod                                   desc\n1 9324 População residente estimada (Pessoas)\n\n$classific_category\nNULL\n\n$geo\n     cod                      desc\n1 Brazil                Brasil (1)\n2 Region         Grande Região (5)\n3  State Unidade da Federação (27)\n4   City         Município (5.570)\n```\n:::\n:::\n\n\nA tabela, neste caso, é bastante simples. Os dados são anuais e estão disponíveis de 2001 a 2021. Há apenas uma variável: `População residente estimada (Pessoas)` com código `9324`. Por fim, os dados estão desagregados no nível nacional, regional, estadual e municipal.\n\nVamos importar a população de todos os municipios em 2021. Note que no código abaixo o argumento do ano é inserido como um `character`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npop21 <- get_sidra(6579, period = \"2021\", geo = \"City\")\n\npop21\n```\n:::\n\n\nA tabela já vem formatada dentro do R.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npop21 <- get_sidra(6579, period = \"2021\", geo = \"City\")\nhead(pop21)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  Nível Territorial (Código) Nível Territorial Unidade de Medida (Código)\n2                          6         Município                         45\n3                          6         Município                         45\n4                          6         Município                         45\n5                          6         Município                         45\n6                          6         Município                         45\n7                          6         Município                         45\n  Unidade de Medida  Valor Município (Código)                  Município\n2           Pessoas  22516            1100015 Alta Floresta D'Oeste - RO\n3           Pessoas 111148            1100023             Ariquemes - RO\n4           Pessoas   5067            1100031                Cabixi - RO\n5           Pessoas  86416            1100049                Cacoal - RO\n6           Pessoas  16088            1100056            Cerejeiras - RO\n7           Pessoas  15213            1100064     Colorado do Oeste - RO\n  Ano (Código)  Ano Variável (Código)                     Variável\n2         2021 2021              9324 População residente estimada\n3         2021 2021              9324 População residente estimada\n4         2021 2021              9324 População residente estimada\n5         2021 2021              9324 População residente estimada\n6         2021 2021              9324 População residente estimada\n7         2021 2021              9324 População residente estimada\n```\n:::\n:::\n\n\nAinda que os dados não estejam \"sujos\", eles não estão num formato agradável para se trabalhar. Vamos fazer uma limpeza básica dos dados. Primeiro, vamos simplificar os nomes das colunas e selecionar apenas as colunas de maior interesse.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npop21 <- janitor::clean_names(pop21)\npop21 <- dplyr::select(pop21, municipio_codigo, municipio, ano, valor)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-condensed table-responsive table-hover table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:center;\"> municipio_codigo </th>\n   <th style=\"text-align:center;\"> municipio </th>\n   <th style=\"text-align:center;\"> ano </th>\n   <th style=\"text-align:center;\"> valor </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 2 </td>\n   <td style=\"text-align:center;\"> 1100015 </td>\n   <td style=\"text-align:center;\"> Alta Floresta D'Oeste - RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 22516 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:center;\"> 1100023 </td>\n   <td style=\"text-align:center;\"> Ariquemes - RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 111148 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4 </td>\n   <td style=\"text-align:center;\"> 1100031 </td>\n   <td style=\"text-align:center;\"> Cabixi - RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 5067 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 5 </td>\n   <td style=\"text-align:center;\"> 1100049 </td>\n   <td style=\"text-align:center;\"> Cacoal - RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 86416 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:center;\"> 1100056 </td>\n   <td style=\"text-align:center;\"> Cerejeiras - RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 16088 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 7 </td>\n   <td style=\"text-align:center;\"> 1100064 </td>\n   <td style=\"text-align:center;\"> Colorado do Oeste - RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 15213 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nNote que o nome dos municípios contém também a abreviação do estado ao qual o município pertence. Podemos deixar isto mais claro separando esta informação em duas colunas distintas.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npop21 <- tidyr::separate(\n  pop21,\n  col = \"municipio\",\n  into = c(\"nome_muni\", \"abr_estado\"),\n  sep = \" - \")\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-condensed table-responsive table-hover table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:center;\"> municipio_codigo </th>\n   <th style=\"text-align:center;\"> nome_muni </th>\n   <th style=\"text-align:center;\"> abr_estado </th>\n   <th style=\"text-align:center;\"> ano </th>\n   <th style=\"text-align:center;\"> valor </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 2 </td>\n   <td style=\"text-align:center;\"> 1100015 </td>\n   <td style=\"text-align:center;\"> Alta Floresta D'Oeste </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 22516 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:center;\"> 1100023 </td>\n   <td style=\"text-align:center;\"> Ariquemes </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 111148 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4 </td>\n   <td style=\"text-align:center;\"> 1100031 </td>\n   <td style=\"text-align:center;\"> Cabixi </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 5067 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 5 </td>\n   <td style=\"text-align:center;\"> 1100049 </td>\n   <td style=\"text-align:center;\"> Cacoal </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 86416 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:center;\"> 1100056 </td>\n   <td style=\"text-align:center;\"> Cerejeiras </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 16088 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 7 </td>\n   <td style=\"text-align:center;\"> 1100064 </td>\n   <td style=\"text-align:center;\"> Colorado do Oeste </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 15213 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nPor fim, podemos padronizar melhor o nome das colunas. Vamos utilizar as convenções do pacote `geobr`, por exemplo, e traduzir as variáveis para o inglês.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npop21 <- dplyr::rename(\n  pop21,\n  name_muni = nome_muni,\n  abbrev_state = abr_estado,\n  code_muni = municipio_codigo,\n  year = ano,\n  population = valor)\n```\n:::\n\n\nA tabela final aparece abaixo.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-condensed table-responsive table-hover table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:center;\"> code_muni </th>\n   <th style=\"text-align:center;\"> name_muni </th>\n   <th style=\"text-align:center;\"> abbrev_state </th>\n   <th style=\"text-align:center;\"> year </th>\n   <th style=\"text-align:center;\"> population </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 2 </td>\n   <td style=\"text-align:center;\"> 1100015 </td>\n   <td style=\"text-align:center;\"> Alta Floresta D'Oeste </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 22516 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:center;\"> 1100023 </td>\n   <td style=\"text-align:center;\"> Ariquemes </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 111148 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4 </td>\n   <td style=\"text-align:center;\"> 1100031 </td>\n   <td style=\"text-align:center;\"> Cabixi </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 5067 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 5 </td>\n   <td style=\"text-align:center;\"> 1100049 </td>\n   <td style=\"text-align:center;\"> Cacoal </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 86416 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:center;\"> 1100056 </td>\n   <td style=\"text-align:center;\"> Cerejeiras </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 16088 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 7 </td>\n   <td style=\"text-align:center;\"> 1100064 </td>\n   <td style=\"text-align:center;\"> Colorado do Oeste </td>\n   <td style=\"text-align:center;\"> RO </td>\n   <td style=\"text-align:center;\"> 2021 </td>\n   <td style=\"text-align:center;\"> 15213 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nA padronização dos nomes traz como vantagem facilitar o `join` com o shapefile dos municípios usando o pacote `geobr`.\n\n## Variando os parâmetros de busca\n\nA função `get_sidra()` permite refinar a query que gera a tabela final que é importada dentro do `R`. Os principais argumentos são:\n\n-   `period` - escolhe a janela temporal dos dados.\n-   `variable` - escolhe a variável a ser importada.\n-   `geo` - nível geográfico dos dados (e.g. `\"Brazil\"`, `\"City\"`, `\"Neighborhood\"`, etc.).\n-   `geo.filter` - lista com filtros geográficos.\n-   `classific` - classificação dos dados.\n-   `category` - escolhe quais categorias (do `classific`) importar.\n\nDe maneira geral, todos os parâmetros acima tem algumas nuances. Vamos explorá-los caso a caso\n\n## Importando dados de vários períodos\n\nPara selecionar múltiplos períodos podemos montar um vetor `character` com os períodos desejados. Para selecionar uma sequência de períodos deve-se montar um string único encadeando os períodos com o sinal de \"-\". O código abaixo deve deixar isto mais claro.\n\nNote que se você rodar o código abaixo, provavelmente, vai enfrentar um problema de limite de query. A API do SIDRA restringe o número de linhas que um usuário pode chamar de uma só vez. Assim, para importar bases de dados maiores é preciso montar estratégias para particionar os dados.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Importa os dados de 2010 e de 2020\npop <- get_sidra(6579, period = c(\"2010\", \"2020\"), geo = \"City\")\n\n# Importa todos os dados de 2010 até 2020 (erro: limite de requisição)\npop <- get_sidra(6579, period = c(\"2010-2020\"), geo = \"City\")\n```\n:::\n\n\nUm detalhe curioso é que a função não retorna erros quando o período extrapola os valores disponíveis nos dados. Assim a função abaixo retorna apenas os valores de 2021.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Importa todos os dados de 2021 até 2030\npop <- get_sidra(6579, period = c(\"2021-2030\"), geo = \"City\")\n```\n:::\n\n\nA mesma lógica acima vale para quando os dados são mensais ou trimestrais. Considere o exemplo da taxa de desocupação, levantada pela PNADC Trimestral. Note que os períodos estão no formato `YYYYQQ`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ninfo_sidra(4099)\n```\n:::\n\n\nVamos importar todos as observações da taxa de desocupação em 2012. Note que agora há múltiplas variáveis na mesma tabela e que o resultado já está em formato \"long\".\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nunemp <- get_sidra(4099, period = \"201201-201204\")\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nhead(unemp)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  Nível Territorial (Código) Nível Territorial Unidade de Medida (Código)\n2                          1            Brasil                          2\n3                          1            Brasil                          2\n4                          1            Brasil                          2\n5                          1            Brasil                          2\n6                          1            Brasil                          2\n7                          1            Brasil                          2\n  Unidade de Medida Valor Brasil (Código) Brasil Trimestre (Código)\n2                 %   8.0               1 Brasil             201201\n3                 %   0.9               1 Brasil             201201\n4                 %  15.3               1 Brasil             201201\n5                 %   0.7               1 Brasil             201201\n6                 %  14.0               1 Brasil             201201\n7                 %   0.7               1 Brasil             201201\n          Trimestre Variável (Código)\n2 1º trimestre 2012              4099\n3 1º trimestre 2012              4103\n4 1º trimestre 2012              4114\n5 1º trimestre 2012              4115\n6 1º trimestre 2012              4116\n7 1º trimestre 2012              4117\n                                                                                                                                                                           Variável\n2                                                                                             Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n3                                                                   Coeficiente de variação - Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n4                           Taxa combinada de desocupação e de subocupação por insuficiência de horas trabalhadas, na semana de referência, das pessoas de 14 anos ou mais de idade\n5 Coeficiente de variação - Taxa combinada de desocupação e de subocupação por insuficiência de horas trabalhadas, na semana de referência, das pessoas de 14 anos ou mais de idade\n6                                                     Taxa combinada de desocupação e força de trabalho potencial, na semana de referência, das pessoas de 14 anos ou mais de idade\n7                           Coeficiente de variação - Taxa combinada de desocupação e força de trabalho potencial, na semana de referência, das pessoas de 14 anos ou mais de idade\n```\n:::\n:::\n\n\nPara refinar a busca acima temos de usar o argumento `variable`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nunemp <- get_sidra(4099, period = \"201201-202203\", variable = 4099)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nhead(unemp)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  Nível Territorial (Código) Nível Territorial Unidade de Medida (Código)\n2                          1            Brasil                          2\n3                          1            Brasil                          2\n4                          1            Brasil                          2\n5                          1            Brasil                          2\n6                          1            Brasil                          2\n7                          1            Brasil                          2\n  Unidade de Medida Valor Brasil (Código) Brasil Trimestre (Código)\n2                 %   8.0               1 Brasil             201201\n3                 %   7.6               1 Brasil             201202\n4                 %   7.1               1 Brasil             201203\n5                 %   6.9               1 Brasil             201204\n6                 %   8.1               1 Brasil             201301\n7                 %   7.5               1 Brasil             201302\n          Trimestre Variável (Código)\n2 1º trimestre 2012              4099\n3 2º trimestre 2012              4099\n4 3º trimestre 2012              4099\n5 4º trimestre 2012              4099\n6 1º trimestre 2013              4099\n7 2º trimestre 2013              4099\n                                                                               Variável\n2 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n3 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n4 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n5 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n6 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n7 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n```\n:::\n:::\n\n\nAgora temos a série completa apenas da taxa de desocupação no Brasil. Podemos buscar também a taxa em cada uma das cidades do Brasil.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nunemp <- get_sidra(\n  4099,\n  period = \"201201-202203\",\n  variable = 4099,\n  geo = \"City\"\n  )\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output .cell-output-stdout}\n```\n  Nível Territorial (Código) Nível Territorial Unidade de Medida (Código)\n1                          6         Município                          2\n2                          6         Município                          2\n3                          6         Município                          2\n4                          6         Município                          2\n5                          6         Município                          2\n6                          6         Município                          2\n  Unidade de Medida Valor Município (Código)        Município\n1                 %   9.0            1100205 Porto Velho - RO\n2                 %  10.4            1200401  Rio Branco - AC\n3                 %  12.9            1302603      Manaus - AM\n4                 %   9.3            1400100   Boa Vista - RR\n5                 %  10.5            1501402       Belém - PA\n6                 %  12.6            1600303      Macapá - AP\n  Trimestre (Código)         Trimestre Variável (Código)\n1             201201 1º trimestre 2012              4099\n2             201201 1º trimestre 2012              4099\n3             201201 1º trimestre 2012              4099\n4             201201 1º trimestre 2012              4099\n5             201201 1º trimestre 2012              4099\n6             201201 1º trimestre 2012              4099\n                                                                               Variável\n1 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n2 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n3 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n4 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n5 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n6 Taxa de desocupação, na semana de referência, das pessoas de 14 anos ou mais de idade\n```\n:::\n:::\n\n\nNote, contudo, que temos o resultado somente nas capitais. Apesar do argumento \"City\" ser o mesmo que usamos na pesquisa de Estimativas da População, aqui o argumento \"City\" retorna apenas as capitais. Isto acontece porque a PNADC é uma pesquisa que é feita apenas nas capitais brasileiras e não tem uma desagregação a nível municipal para todos os municípios do Brasil. Este importante detalhe não fica evidente e depende do conhecimento prévio do usuário a respeito das pesquisas do IBGE.\n\n## Importando muitos dados\n\nComo comentei acima, a API do SIDRA tem um limite de linhas nas queries. Isto significa que é preciso montar algumas estratégias para pegar as tabelas em partes menores. Na prática, isto vai depender muito da tabela e da informação que se quer.\n\nO exemplo abaixo é bastante simples mas pode eventualmente ser útil em alguma outra aplicação. O código importa a tabela de estimativas populacionais ano a ano. O mesmo poderia ter sido feito num for-loop, mas prefiro usar o `lapply` por simplicidade.\n\nPara acelerar o processo pode-se trocar o `lapply` por `parallel::mclapply` que roda a função em paralelo. Contudo, na minha experiência, esta estratégia acaba resultando em erros imprevistos. Não sei se isto é resultado de alguma restrição da API. Na prática, é mais seguro evitar o `mclapply`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Define um vetor com todos os anos da pesquisa\nperiods <- seq(2001:2021)\n# Converte para character\nperiods <- as.character(periods)\n# Aplica a função get_sidra a cada elemento de periods (a cada ano)\nreq <- lapply(periods, function(p) get_sidra(6579, period = p, geo = \"City\"))\n# Junta o resultado numa única tabela\ntab <- dplyr::bind_rows(req)\n```\n:::\n\n\n# Refinando a busca em casos complexos\n\n## Tabelas do Censo\n\nTabelas que vem do Censo costumam ter maior complexidade. Considere, por exemplo, a tabela 1378, que retorna a população residente, por situação do domicílio (urbano x rural), sexo e idade, segundo a condição no domicílio e compartilhamento da responsabilidade (responsável, cônjuge, filho, etc.)\n\nO resultado da função abaixo é omitido para poupar espaço pois a saída é muito grande. Em casos como este é muito importante filtrar o resultado para conseguir uma tabela que faça sentido.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ninfo_sidra(1378)\n```\n:::\n\n\nVamos nos focar somente na população residente (var 93) de pessoas responsáveis do domicílio (cod 11941) por bairro de Porto Alegre (4314902).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nresp <- get_sidra(\n  1378,\n  variable = 93,\n  classific = c(\"c455\"),\n  geo = \"Neighborhood\",\n  geo.filter = list(\"City\" = 4314902)\n  )\n```\n:::\n\n\nApós um pouco de limpeza no nome das colunas podemos ver o resultado abaixo.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-condensed table-responsive table-hover table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:center;\"> bairro </th>\n   <th style=\"text-align:center;\"> cond_domi </th>\n   <th style=\"text-align:center;\"> sexo </th>\n   <th style=\"text-align:center;\"> idade </th>\n   <th style=\"text-align:center;\"> situacao_domi </th>\n   <th style=\"text-align:center;\"> valor </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 2 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 11568 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Pessoa responsável </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 4206 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Pessoa responsável - com responsabilidade compartilhada </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 1054 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 5 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Pessoa responsável - sem responsabilidade compartilhada </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 3152 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Cônjuge ou companheiro(a) </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 2101 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 7 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Cônjuge ou companheiro(a) - de sexo diferente </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 2094 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 8 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Cônjuge ou companheiro(a) - de mesmo sexo </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 9 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Filho(a) </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 3429 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 10 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Filho(a) - da pessoa responsável e do cônjuge </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 1916 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 11 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Filho(a) - somente da pessoa responsável </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 1513 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 12 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Enteado(a) </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 145 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 13 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Genro ou nora </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 170 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 14 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Pai, mãe, padastro ou madrasta </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 183 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 15 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Sogro(a) </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 51 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 16 </td>\n   <td style=\"text-align:center;\"> Medianeira </td>\n   <td style=\"text-align:center;\"> Neto(a) </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 549 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nNote que temos a coluna da condição do domicílio desagregada (c455), mas todas as outras (sexo, idade, etc.) estão agregadas.\n\n## API do SIDRA\n\nEntão imagine, por exemplo, que queremos esta mesma informação, por grupos de idade. Esta requisição quebra o limite da query. Além disso, os grupos de idade disponíveis são caóticos e não é possível filtrar dentro deste grupo da mesma maneira como fazemos com o argumento `variable`.\n\nA solução é interagir diretamente com a API do SIDRA! O código acaba sendo bastante complexo/confuso. Muito provavelmente há maneiras de melhorar o código abaixo, mas foi como fiz para conseguir esta informação. Por conveniência chamo explicitamente todos os pacotes que uso. A limpeza dos dados foi a parte mais desafiadora do processo visto que não foi possível transformar o input de JSON para um `data.frame` de maneira direta.\n\nEm partes, acho que dei o azar de ter escolhido uma tabela especialmente complicada. Se `jsonlite::fromJSON(x, simplifyDataFrame = TRUE)` tivesse funcionado, o código seria muito mais simples.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Bibliotecas usadas\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(stringr)\nlibrary(janitor)\nlibrary(tidyjson)\nlibrary(httr)\nlibrary(jsonlite)\nlibrary(geobr)\n\n# 1. Montar a query\n\n# Montar um vetor com o código de todos os bairros de Porto Alegre\n\n# Importa o shapefile de todos os bairros IBGE (2010)\nbairros <- geobr::read_neighborhood()\n\nbairros_poa <- bairros |> \n  # Pega apenas os códigos dos bairros de POA\n  filter(code_muni == 4314902) |> \n  # O código do bairro tem alguns números sobrando no meio\n  mutate(code_nb = paste0(\n    str_sub(code_neighborhood, 1, 7),\n    str_sub(code_neighborhood, 10, 12))\n    )\n# Extrai o vetor com os códgios dos bairros\ncodenb_poa <- bairros_poa[[\"code_nb\"]]\n# Colapsa o vetor num único string separado por vírgulas\nlocal = paste(codenb_poa, collapse = \",\")\n# Insere o string no formato da API\nlocal = stringr::str_glue(\"localidades=N102[{local}]\")\n\n# Base do url da API\nbase = \"https://servicodados.ibge.gov.br/api/v3/agregados\"\n# Número da tabela\ntable <- 1378\n# Período da extração (ano)\nperiod <- 2010\n# Código da variável (Pessoas residentes)\nvariable <- 93\n# Códigos das classes\nclass <- c(1, 2, 287, 455)\n# Filtro das classes (veja info_sidra(1378))\ncategory <- list(c(1), c(4, 5), c(93087:93100), c(11941))\n# Colapsa os strings\ncategory <- sapply(category, paste, collapse = \",\")\n# Coloca os strings no format da API\ncat_filter <- stringr::str_glue(\"{class}[{category}]\")\n# Colapsa os strings num único string separado pelo operador booleano |\ncat_filter <- paste(cat_filter, collapse = \"|\")\n\n# Monta a query\nquery <- stringr::str_glue(\n  \"{base}/{table}/periodos/{period}/variaveis/{variable}?{local}&classificacao={cat_filter}\"\n)\n\n# 2. Importar dados\n\n# Importar os dados da API\nreq <- httr::GET(url = query)\njson <- httr::content(req, as = \"text\", encoding = \"UTF-8\")\njson <- jsonlite::fromJSON(json, simplifyVector = FALSE)\n\n# 3. Limpar os dados\n\n# Simplificar os dados de JSON para um tibble\nvalores <- json |> \n  spread_all() |> \n  enter_object(resultados) |> \n  gather_array() |> \n  spread_all() |> \n  enter_object(series) |> \n  gather_array() |> \n  spread_all()\n\n# Extrair somente os valores da série\nvalores <- valores |> \n  as_tibble() |> \n  mutate(serie.2010 = as.numeric(serie.2010)) |> \n  pivot_wider(\n    id_cols = \"array.index\",\n    names_from = \"localidade.id\",\n    values_from = \"serie.2010\"\n  )\n\n# Extrair a classificação das variáveis (sexo, idade)\nclassificacao <- json |> \n  spread_all() |> \n  enter_object(resultados) |> \n  gather_array() |> \n  spread_all() |> \n  enter_object(classificacoes) |> \n  gather_array() |> \n  spread_all()\n\n# Extrai somente a coluna com os grupos de idade\ntblage <- classificacao |> \n  select(contains(\"93\")) |>\n  as_tibble() |> \n  unite(\"age_group\", everything(), na.rm = TRUE) |> \n  filter(age_group != \"\") |> \n  distinct()\n\n# Cria um grid com todas as classificações na ordem correta\ntblclass <- expand_grid(\n  situacao_domicilio = \"urban\",\n  resp = \"Responsável pelo Domicilio\",\n  sex = c(\"male\", \"female\"),\n  age_group = tblage$age_group\n)\n\n# Junta as classificações com os valores \ntab <- cbind(valores, tblclass)\n\n# Converte os dados para wide\ntab <- tab |> \n  pivot_longer(starts_with(\"431\"), names_to = \"code_nb\") |> \n  select(code_nb, situacao_domicilio, resp, sex, age_group, value)\n\n# Converte os dados para uma tabela final\nrespnb <- tab |> \n  pivot_wider(\n    id_cols = c(\"code_nb\", \"age_group\"),\n    names_from = \"sex\",\n    values_from = \"value\"\n  ) |> \n  mutate(total = male + female)|> \n  group_by(code_nb) |> \n  mutate(total_nb = sum(total)) |> \n  ungroup() |> \n  mutate(share_nb = total / total_nb * 100)\n```\n:::\n\n\nA tabela abaixo mostra o resultado final do código. A tabela apresenta o número total de pessoas responsáveis por domicílios em grupos de idade quinquenais por sexo e por bairro de Porto Alegre. Além disso, a coluna `total_nb` traz o número total de pessoas responsáveis por domicílio no bairro e `share_nb` computa a participação relativa de cada faixa de idade no total do bairro.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-condensed table-responsive table-hover table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:center;\"> code_nb </th>\n   <th style=\"text-align:center;\"> age_group </th>\n   <th style=\"text-align:center;\"> male </th>\n   <th style=\"text-align:center;\"> female </th>\n   <th style=\"text-align:center;\"> total </th>\n   <th style=\"text-align:center;\"> total_nb </th>\n   <th style=\"text-align:center;\"> share_nb </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902003 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 383 </td>\n   <td style=\"text-align:center;\"> 406 </td>\n   <td style=\"text-align:center;\"> 789 </td>\n   <td style=\"text-align:center;\"> 8757 </td>\n   <td style=\"text-align:center;\"> 9 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902005 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 3 </td>\n   <td style=\"text-align:center;\"> 7 </td>\n   <td style=\"text-align:center;\"> 10 </td>\n   <td style=\"text-align:center;\"> 435 </td>\n   <td style=\"text-align:center;\"> 2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902007 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 214 </td>\n   <td style=\"text-align:center;\"> 245 </td>\n   <td style=\"text-align:center;\"> 459 </td>\n   <td style=\"text-align:center;\"> 9116 </td>\n   <td style=\"text-align:center;\"> 5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902069 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 42 </td>\n   <td style=\"text-align:center;\"> 62 </td>\n   <td style=\"text-align:center;\"> 104 </td>\n   <td style=\"text-align:center;\"> 2071 </td>\n   <td style=\"text-align:center;\"> 5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902009 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 331 </td>\n   <td style=\"text-align:center;\"> 359 </td>\n   <td style=\"text-align:center;\"> 690 </td>\n   <td style=\"text-align:center;\"> 13137 </td>\n   <td style=\"text-align:center;\"> 5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902072 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 75 </td>\n   <td style=\"text-align:center;\"> 57 </td>\n   <td style=\"text-align:center;\"> 132 </td>\n   <td style=\"text-align:center;\"> 3706 </td>\n   <td style=\"text-align:center;\"> 4 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902068 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 163 </td>\n   <td style=\"text-align:center;\"> 144 </td>\n   <td style=\"text-align:center;\"> 307 </td>\n   <td style=\"text-align:center;\"> 8052 </td>\n   <td style=\"text-align:center;\"> 4 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902013 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 193 </td>\n   <td style=\"text-align:center;\"> 177 </td>\n   <td style=\"text-align:center;\"> 370 </td>\n   <td style=\"text-align:center;\"> 6319 </td>\n   <td style=\"text-align:center;\"> 6 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902012 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 31 </td>\n   <td style=\"text-align:center;\"> 19 </td>\n   <td style=\"text-align:center;\"> 50 </td>\n   <td style=\"text-align:center;\"> 2719 </td>\n   <td style=\"text-align:center;\"> 2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902004 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 206 </td>\n   <td style=\"text-align:center;\"> 227 </td>\n   <td style=\"text-align:center;\"> 433 </td>\n   <td style=\"text-align:center;\"> 13342 </td>\n   <td style=\"text-align:center;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902032 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 261 </td>\n   <td style=\"text-align:center;\"> 285 </td>\n   <td style=\"text-align:center;\"> 546 </td>\n   <td style=\"text-align:center;\"> 12171 </td>\n   <td style=\"text-align:center;\"> 4 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902022 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 117 </td>\n   <td style=\"text-align:center;\"> 105 </td>\n   <td style=\"text-align:center;\"> 222 </td>\n   <td style=\"text-align:center;\"> 6910 </td>\n   <td style=\"text-align:center;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902071 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 49 </td>\n   <td style=\"text-align:center;\"> 29 </td>\n   <td style=\"text-align:center;\"> 78 </td>\n   <td style=\"text-align:center;\"> NA </td>\n   <td style=\"text-align:center;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902045 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 70 </td>\n   <td style=\"text-align:center;\"> 56 </td>\n   <td style=\"text-align:center;\"> 126 </td>\n   <td style=\"text-align:center;\"> 4190 </td>\n   <td style=\"text-align:center;\"> 3 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 4314902049 </td>\n   <td style=\"text-align:center;\"> 20 a 24 anos </td>\n   <td style=\"text-align:center;\"> 71 </td>\n   <td style=\"text-align:center;\"> 65 </td>\n   <td style=\"text-align:center;\"> 136 </td>\n   <td style=\"text-align:center;\"> 4365 </td>\n   <td style=\"text-align:center;\"> 3 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nApesar de claramente não ser o foco do post, pareceu um desperdício de esforço não fazer algo com esta informação. O código abaixo agrupa os dados um pouco mais e monta um mapa interativo dos domicílios por grupo de idade da pessoa responsável. Não seria difícil transformar isto num aplicativo para ver esta mesma info nas outras faixas de idade, mas isto fica para outro post.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nbairros <- geobr::read_neighborhood(showProgress = FALSE)\n\nbairros_poa <- bairros |> \n  # Pega apenas os códigos dos bairros de POA\n  filter(code_muni == 4314902) |> \n  # O código do bairro tem alguns números sobrando no meio\n  mutate(code_nb = paste0(\n    stringr::str_sub(code_neighborhood, 1, 7),\n    stringr::str_sub(code_neighborhood, 10, 12))\n    )\n\n\nrespnb <- respnb |>\n  separate(age_group, into = c(\"age_min\", \"age_max\"), sep = \" a \") |> \n  mutate(\n    age_generation = case_when(\n      age_min >= 25 & age_min < 40 ~ \"25-39\",\n      age_min >= 40 & age_min < 60 ~ \"40-59\",\n      age_min >= 60 & age_min < 80 ~ \"60-79\",\n      age_min >= 80 ~ \"80+\",\n      TRUE ~ \"<25\"\n    )\n  )\n\nresp_grouped_nb <- respnb |> \n  group_by(code_nb, age_generation) |> \n  summarise(pop = sum(total, na.rm = TRUE)) |> \n  group_by(code_nb) |> \n  mutate(total_nb = sum(pop)) |> \n  ungroup() |> \n  mutate(share_nb = pop / total_nb * 100)\n\nresp_ages <- pivot_wider(\n  resp_grouped_nb,\n  id_cols = \"code_nb\",\n  names_from = \"age_generation\",\n  names_prefix = \"age_\",\n  values_from = \"share_nb\"\n)\n\nresp_ages <- janitor::clean_names(resp_ages)\n\nresp_bairros <- left_join(bairros_poa, resp_ages, by = \"code_nb\")\n```\n:::\n\n\nO mapa é gerado pelo código abaixo. O mapa mostra o share de domicílios, em cada bairro, que são chefiados por \"adultos-jovens\", isto é, de 25 a 39 anos. Nota-se que os bairros que tem maiores percentuais estão mais na periferia da cidade. Alguns bairros de classe alta como Moinhos de Vento, Três Figueiras e Vila Assunção tem os menores percentuais.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(tmap)\nlibrary(tmaptools)\ntmap_mode(mode = \"view\")\n\nm <- tm_shape(resp_bairros) +\n  tm_fill(\n    col = \"age_25_39\",\n    palette = \"inferno\",\n    alpha = 0.8,\n    style = \"jenks\",\n    n = 7,\n    id = \"name_neighborhood\",\n    title = \"Percentual de domicílios<br>chefiados por pessoas<br>de 25 a 39 anos (%).\",\n    popup.vars = c(\n      \"Menos de 25 anos\" = \"age_25\",\n      \"25 a 39 anos\" = \"age_25_39\",\n      \"40 a 59 anos\" = \"age_40_59\",\n      \"60 a 79 anos\" = \"age_60_79\",\n      \"80 anos ou mais\" = \"age_80\"),\n    popup.format = list(digits = 1),\n    legend.format = list(digits = 0)) +\n  tm_borders() +\n  tm_basemap(server = \"CartoDB.Positron\") +\n  tm_view(set.view = c(-51.179152, -30.025976, 13))\n\nleaf <- tmap_leaflet(m)\nwidgetframe::frameWidget(leaf, width = \"100%\")\n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"htmlwidget-c54b2f67a90b5c0d92b4\" style=\"width:100%;height:415.296px;\" class=\"widgetframe html-widget \"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-c54b2f67a90b5c0d92b4\">{\"x\":{\"url\":\"index_files/figure-html//widgets/widget_unnamed-chunk-27.html\",\"options\":{\"xdomain\":\"*\",\"allowfullscreen\":false,\"lazyload\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n<script src=\"../../../site_libs/htmlwidgets-1.6.2/htmlwidgets.js\"></script>\n<script src=\"../../../site_libs/pymjs-1.3.2/pym.v1.js\"></script>\n<script src=\"../../../site_libs/widgetframe-binding-0.3.1/widgetframe.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
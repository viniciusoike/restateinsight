{
  "hash": "d21ef469c2baec7c767cf6ff2cd532a3",
  "result": {
    "markdown": "---\ntitle: \"Film ratings over the decades: replicating a Nexo plot\"\ndate: \"2024-12-09\"\ncategories: ['data-visualization', 'ggplot2', 'replication']\ndescription: \"In this tutorial, we delve into the world of cinema ratings over the decades, examining how films from various eras are rated on IMDb. We'll replicate a plot originally published in Nexo, a Brazilian media outlet that produces fantastic data visualizations. With these techniques, you can now apply similar methods to analyze and present your own data sets.\"\nimage: \"/static/images/replications/nexo_imdb_replication.png\"\nimage-alt: \"/static/images/replications/nexo_imdb_replication.png\"\nexecute: \n  warning: false\n---\n\n\n\n\n# Film ratings over the decades: replicating a Nexo plot\n\nIn this tutorial, we delve into the world of cinema ratings over the decades, examining how films from various eras are rated on IMDb. Using `ggplot2` in R, this guide will demonstrate how to visualize these ratings to understand trends and highlight significant films.\n\nWe'll replicate a plot originally published in [Nexo](https://www.nexojornal.com.br), a Brazilian media outlet that produces [fantastic data visualizations](https://www.nexojornal.com.br/grafico). This replication will serve as a practical application of `ggplot2` techniques, making it a valuable exercise for data analysts looking to sharpen their skills or movie enthusiasts curious about film ratings across time.\n\nI replicate plots as a practice and have a compilation of ggplot2 code to replicate visualizations from [OurWorldInData, The Financial Times, and The Economist](https://restateinsight.com/posts/general-posts/2023-11-replicating-plots/#the-economist). Nexo is great source for inspiration not only because of the quality of their work, but also because most of their plots are made using `ggplot2`.\n\n![](/static/images/replications/nexo_imdb.png){fig-align=\"center\"}\n\n## \n\n# Replicating the plot\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nimport::from(dplyr, mutate, if_else, case_when)\n```\n:::\n\n\n## Data\n\nTo replicate this plot we need the full top 250 IMDB list. There are several ways to acquire this info but I believe the easiest is [250.took.nl](https://250.took.nl/compare/full). Scrapping this page is straightforward since all the data is neatly arranged as a `table` element in HTML.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nurl <- \"https://250.took.nl/compare/full\"\npage <- xml2::read_html(url)\npage_tables <- rvest::html_table(page)\ntab <- page_tables[[9]]\n```\n:::\n\n\nA curious feature of the top 250 IMDB list is that its not ranked by rating. IMDB clarifies this in [their FAQ](https://help.imdb.com/article/imdb/featured-content/why-doesn-t-a-title-with-the-average-user-vote-of-9-4-appear-in-your-top-250-movies-or-tv-list/GTU67Q5QQ8W53RJT?pf_rd_m=A2FGELUUNOQJNL&pf_rd_p=1a264172-ae11-42e4-8ef7-7fed1973bb8f&pf_rd_r=YBZT6MRVGM65WJJZPKR8&pf_rd_s=center-1&pf_rd_t=15506&pf_rd_i=top&ref_=cons_chttp_learnmore#):\n\n> -   The list is ranked by a formula which includes the number of ratings each movie received from users, and value of ratings received from regular users\n\nIMDB, unfortunately, doesn't disclose how they define \"regular users\". As a result,\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nimdb <- imdb |>  \n  mutate(\n    decade = floor(year / 10) * 10,\n    trunc_rating = round(wr, 1),\n    trunc_decade = case_when(\n      decade < 1950 ~ 1940,\n      decade > 2020 ~ 2020,\n      TRUE ~ decade\n    ),\n    #trunc_decade = factor(trunc_decade),\n    #trunc_decade = forcats::fct_reorder(trunc_decade, decade),\n    is_top20 = factor(if_else(rank <= 20, 1L, 0L))\n  )\n```\n:::\n\n\n## Basic plot\n\nThe Nexo visualization is a sort of \"punchcard\" plot, that shows the frequency of a pair of categorical variables. [I discussed these kind of plots in another post](https://restateinsight.com/posts/general-posts/2024-12-punchcard-plot/). In this case, our variables are decades and binned film ratings.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(imdb, aes(trunc_decade, trunc_rating)) +\n  geom_count(aes(color = is_top20)) +\n  geom_hline(yintercept = 7.9)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\nTo improve our base plot we'll:\n\n-   Format the text on both axis\n\n-   Add colors to highlight the top 20 films\n\n-   Adjust the size legend\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nnexo_labels <- c(\"até\\n1950\", \"1960\", \"70\", \"80\", \"90\", \"00\", \"10\", \"20\", \"até\\nhoje\")\n\ncolors <- c(\"#328bff\", \"#88bce4\")\n\nplot_base <- ggplot(imdb, aes(trunc_decade, trunc_rating)) +\n  geom_count(aes(color = is_top20)) +\n  geom_hline(yintercept = 7.9) +\n  scale_x_continuous(breaks = seq(1940, 2020, 10), labels = nexo_labels) +\n  scale_y_continuous(\n    limits = c(7.9, 9.55),\n    breaks = seq(7.9, 9.3, 0.1),\n    labels = scales::label_number(decimal.mark = \",\", accuracy = 0.1),\n    expand = c(0, 0)\n  ) +\n  scale_color_manual(values = rev(colors)) +\n  scale_size_area(name = \"\", breaks = c(4, 8, 12, 16)) +\n  guides(\n    color = \"none\",\n    size = guide_legend(\n      label.position = \"bottom\",\n      override.aes = list(color = \"gray80\"))\n  )\n\nplot_base\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Adding labels and arrows\n\nAdding annotations and arrows can be very frustrating in `ggplot2`. If multiple annotations/arrows are needed I'd recommend using another software to complement `R`. I'll split this section into smaller parts, first showing how to handle the text labels and then showing how to draw curved arrows.\n\nText annotations require at minimum three arguments: `x`, `y`, and `label`. Getting the right values for the text position usually requires multiple tests. Additionally, we usually desire to change both the font and its size. In this case, to get a proper replication we should use the Gotham Rounded font used by Nexo.\n\nArrows function as line segments in `ggplot2` and are defined by a starting and end position on each axis: this means we must specify 4 arguments to draw an arrow. This is made using the `geom_arrow` function. To make curved arrows, such as those in the original plot, however, we use instead the `geom_curve` function.\n\n### Using the Nexo font\n\nTo achieve a more accurate plot we need to use the Gotham Rounded font used by Nexo. If you do don't have access to this font, I recommend using the Montserrat font available at Google Fonts.\n\nThe code below defines a simple function called `load_fonts_nexo` to load the fonts into the R session.\n\nThis step is entirely optional but does make a big difference for the end result.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Verifica a fonte do texto\n\ncheck_fonts_nexo <- function() {\n  \n  dbfonts <- sysfonts::font_files()\n  \n  nexo_fonts <- paste(\"Gotham Rounded\", c(\"Bold\", \"Medium\", \"Light\"))\n  nexo_fonts_path <- paste0(nexo_fonts, \".otf\")\n  \n  cond <- stringr::str_glue(\n    \"({nexo_fonts[1]})|({nexo_fonts[2]})|({nexo_fonts[3]})\"\n  )\n  \n  check_fonts <- sum(stringr::str_detect(dbfonts$family, cond))\n  check_fonts <- ifelse(check_fonts == 3, TRUE, FALSE)\n  \n  if (!check_fonts) {\n    \n    fonts_found <- dbfonts$family[stringr::str_detect(dbfonts$family, cond)]\n    \n    message(glue::glue(\n      \"Missing fonts. Only found: {paste(fonts_found, collapse = ', ')}\"\n    ))\n  }\n  \n  return(check_fonts)\n  \n}\n\nload_fonts_nexo <- function(dpi = 96, ...) {\n\n  check_fonts <- check_fonts_nexo()\n  \n  if (check_fonts) {\n    # Adiciona as fonts Gotham Rounded Bold e Light\n    sysfonts::font_add(\"Gotham Rounded Bold\", \"Gotham Rounded Bold.otf\")\n    sysfonts::font_add(\"Gotham Rounded Medium\", \"Gotham Rounded Medium.otf\")\n    sysfonts::font_add(\"Gotham Rounded Light\", \"Gotham Rounded Light.otf\")\n  } else {\n    # Adiciona Montserrat caso as fontes Gotham nao estejam disponiveis\n    sysfonts::font_add_google(\"Montserrat\", \"Montserrat\")\n  }\n  \n  sysfonts::font_add_google(\"Crimson Pro\", \"Crimson Text\")\n  \n  if (dpi > 0) {\n    showtext::showtext_opts(dpi = dpi, ...)\n  }\n  \n  showtext::showtext_auto()\n  \n  if (check_fonts) {\n    message(\"Gotham Rounded fonts successfully loaded.\")\n  } else {\n    message(\"Gotham Rounded font not found. Montserrat was loaded instead.\")\n  }\n  \n}\n\nload_fonts_nexo()\n\nfont <- ifelse(check_fonts_nexo(), \"Gotham Rounded Bold\", \"Montserrat\")\nfont_axis <- ifelse(check_fonts_nexo(), \"Gotham Rounded Light\", \"Montserrat\")\nfont_title <- \"Crimson Text\"\n```\n:::\n\n\n### Adding the annotations\n\nText annotations require a position and a text `label`. Additionally, we insert a `font` and other customizations.\n\nNote that I insert some blank lines in the subtitle. This extra space will later be needed to make room for the color legend.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_annotations <- plot_base +\n  labs(\n    title = \"Notas dos 250 filmes melhor\\navaliados por década de estreia\",\n    subtitle = \"SEGUNDO AVALIAÇÕES DO IMDB ATÉ DEZ. DE 2024\\n\\n\\n\\n\",\n    x = NULL,\n    y = NULL\n  ) +\n  annotate(\n    \"label\",\n    x = 1970,\n    y = 9.31,\n    label = \"entre os melhores\\n20 filmes\",\n    # Font of the text\n    family = font,\n    # Size of the text\n    size = 3,\n    # Color of the text\n    color = colors[1],\n    # Centralized text\n    hjust = 0.5,\n    # Remove borders\n    label.size = 0\n  ) +\n  annotate(\n    \"label\",\n    x = 2015,\n    y = 9.15,\n    label = \"entre os\\nmelhores\\n250 filmes\",\n    family = font,\n    size = 3,\n    color = colors[2],\n    # Centralized text\n    hjust = 0.5,\n    # Remove borders\n    label.size = 0\n  )\n\nplot_annotations\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n### Adding the arrows\n\nThe code below adds the arrows. Again, getting the right values will usually require multiple attempts.\n\nStoring the arguments inside a `data.frame` is not necessary but I feel it makes for more organized code.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_arrows <- plot_annotations +\n  geom_curve(\n    data = data.frame(x = 1990, xend = 1978, y = 9.31, yend = 9.4),\n    aes(x = x, xend = xend, y = y, yend = yend),\n    arrow = arrow(length = unit(0.03, \"npc\"))\n  ) +\n  geom_curve(\n    data = data.frame(x = 2020, xend = 2015, y = 8.6, yend = 9),\n    aes(x = x, xend = xend, y = y, yend = yend),\n    curvature = -0.45,\n    arrow = arrow(length = unit(0.03, \"npc\"))\n  )\n\nplot_arrows\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Final plot\n\nLike spices in food, thematic elements are what set a plot apart. The final ingredient for a neat replication is modifying the `theme` elements.\n\nThis may seem the hardest step but my personal experience points to the opposite. Thematic elements follow a well defined and consistent structure, making it easy to change them.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_full <- plot_arrows +\n  theme_minimal(base_family = font, base_size = 14) +\n  theme(\n    panel.grid.major.y = element_line(linetype = 3, color = \"#d9d9d9\", linewidth = 0.35),\n    panel.grid.major.x = element_line(color = \"#838484\", linewidth = 0.35),\n    panel.grid.minor = element_blank(),\n    legend.position = c(0.09, 1.1),\n    legend.direction = \"horizontal\",\n    legend.text = element_text(size = 10),\n    plot.subtitle = element_text(size = 10),\n    plot.title = element_text(family = font_title, size = 22, hjust = 0),\n    \n    axis.title.y = element_text(color = \"#767676\"),\n    axis.ticks.x = element_line(color = \"#000000\")\n  )\n\nplot_full\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Conclusion\n\nWe've reached the end of our exploration into IMDb ratings of the top 250 films by decade. This tutorial provided a step-by-step guide on using `ggplot2` in R to visualize data effectively, showing the power of good visualizations in making data easier to understand and insights more apparent. With these techniques, you can now apply similar methods to analyze and present your own data sets. As you continue to work with `ggplot2`, you'll find it an invaluable tool for revealing patterns and stories within the data.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
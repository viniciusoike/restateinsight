{
  "hash": "0ef502ffd9651934608857d7b726b1a4",
  "result": {
    "markdown": "---\ntitle: \"Médias móveis\"\ndate: '2024-02-20'\ncategories: ['data-science', 'economia', 'tutorial-R', 'econometria', 'time-series']\ndescription: 'O filtro de médias móveis serve para suavizar séries de tempo e encontrar tendências nos dados. Este filtro é bastante simples e pode ser escalado com facilidade para lidar com múltiplas séries de tempo.'\nimage: \"/static/plots/moving_average_trend.png\"\nexecute: \n  warning: false\n  message: false\n---\n\n\n\n\n# Médias móveis\n\nUma média móvel, como o nome sugere, calcula a média de uma série temporal em janelas móveis. Tipicamente, a média móvel serve como uma estimativa da tendência da série; também é bastante comum usar a média móvel para identificar ciclos ou padrões numa série. Aplicar uma média móvel numa série de tempo $y_t$ produz uma nova série $z_t$:\n\n$$\nz_t = \\sum_{j = -k}^{k}a_{j}y_{t+j}\n$$ No caso mais simples, k = 1, temos:\n\n$$\nz_{t} = a_1y_{t-1} + a_2 y_{t} + a_3 y_{t+1}\n$$\n\nSupondo que os pesos devem ser todos iguais e somar um temos a média móvel simples abaixo:\n\n$$\nz_{t} = \\frac{1}{3}y_{t-1} +\\frac{1}{3} y_{t} + \\frac{1}{3} y_{t+1}\n$$\n\nO exemplo acima, mostra uma média móvel simétrica de ordem 3, onde todos os pesos são iguais. Cada ponto na nova série $z_t$ é uma média entre os valores vizinhos da série original. Tipicamente, valores próximos uns aos outros no tempo costumam ser similares; na prática, isto torna o filtro de médias móveis bastante suave.\n\nEvidentemente, não é possível calcular este filtro no início e no final da série $y_t$. Isto implica que a série $z_t$ tem menos observações do que a série original $y_t$. Isto, de fato, é um ponto negativo quando se usa filtros de médias móveis.\n\nMédias móveis simétricas sempre tem um número ímpar de termos: no exemplo acima, $k=1$ resultou num filtro com três termos; se tivéssemos usado $k=2$ teríamos cinco termos e assim por diante. É possível fazer médias móveis não-simétricas variando a janela temporal. A equação abaixo mostra um filtro que soma as últimas duas observações e tira a média junto com a observação atual e a próxima observação.\n\n$$\nz_{t} = \\frac{1}{4} y_{t-2} + \\frac{1}{4} y_{t-1} + \\frac{1}{4} y_{t} + \\frac{1}{4} y_{t+1}\n$$\n\nNão existe forte \"contraindicação\" sobre o uso de médias móveis não-simétricas. Vale notar, contudo, que é relativamente fácil transformar uma média móvel não-simétrica em uma média móvel simétrica. Vamos tirar uma média móvel sobre a média móvel acima:\n\n$$\n\\begin{align}\nx_{t} & = \\frac{1}{2}z_{t} + \\frac{1}{2}z_{t+1} \\\\\nx_{t} & = \\frac{1}{2}(\\frac{1}{4}(y_{t-2} + y_{t-1} + y_{t} + y_{t+1}) + \\frac{1}{4}(y_{t-1} + y_{t} + y_{t+1} + y_{t+2})) \\\\\nx_{t} & = \\frac{1}{8} y_{t-2} + \\frac{1}{4} y_{t-1} + \\frac{1}{4} y_{t} + \\frac{1}{4} y_{t+1} + \\frac{1}{8} y_{t+2}\n\\end{align}\n$$\n\nA série final é uma média móvel simétrica com menor peso nas pontas. Esta é uma média móvel de ordem 2x4. Este tipo de filtro também é conhecido como média móvel ponderada.\n\nNa primeira demonstração acima, definimos que todos $a_j$ teriam o mesmo valor. Isto não é necessário. Imagine que queremos um filtro que olha somente para o passado e atribui pesos decrescentes à medida que a observação se afasta no tempo. No caso de uma janela com apenas dois períodos teríamos algo da forma:\n\n$$\nz_{t} = \\frac{1}{2}y_{t} + \\frac{1}{3}y_{t-1} + \\frac{1}{6}y_{t-2} \n$$\n\nNote que os pesos somam 1 e vão decaindo no tempo. De forma mais geral,\n\n$$\n\\text{WMA}_M = \\frac{ny_{t} + (n-1)y_{t-1} + \\dots + y_{M-n+1}}{\\frac{n(n+1)}{2}}\n$$\n\nPode-se definir uma média móvel ponderada com pesos que apresentam algum tipo de decaimento. O filtro acima também é conhecido como média móvel linearmente ponderada, pois os pesos decaem linearmente. Outra opção seria usar pesos que apresentam decaimento exponencial como\n\n$$\nz_{t} = \\alpha y_{t} + \\alpha(1-\\alpha) y_{t-1} + \\alpha(1-\\alpha)^2 y_{t-2}\n$$\n\nTomando o valor $\\alpha = \\frac{1}{2}$ temos que:\n\n$$\nz_{t} = \\frac{1}{2}y_t + \\frac{1}{4}y_{t-1} + \\frac{1}{8} y_{t-2}\n$$\n\nComparando os termos da expressão acima com a média móvel ponderada anterior, vemos que os termos do passado agora tem menor peso. De maneira mais geral, o filtro de médias móveis exponencial é dado por\n\n$$\nz_t = \\alpha \\sum_{j = 0}^{\\infty}(1-\\alpha)^j y_{t-j}\n$$\n\n## Exemplo simples\n\nPara montar um exemplo de médias móveis vamos importar uma das rubricas da balança de pagamentos do Brasil. O gráfico abaixo mostra a série anual da rubrica \"passe de atletas\"[^1].\n\n[^1]: Nome completo: \"Transfer rights on sporting club players - annual - net\".\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(rbcb)\nlibrary(ggplot2)\nlibrary(forecast)\n\ntheme_series = theme_bw(base_size = 10, base_family = \"sans\") +\n    theme(\n      legend.position = \"top\",\n      panel.grid.minor = element_blank(),\n      axis.text.x = element_text(angle = 90),\n      axis.title.x = element_blank()\n      )\n\natletas = rbcb::get_series(23617, as = \"ts\")\n\nautoplot(atletas) + theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nA tabela abaixo mostra o cálculo de três filtros de médias móveis aplicados na série.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nma3 = stats::filter(atletas, filter = rep(1/3, 3), method = \"convolution\")\nma5 = stats::filter(atletas, filter = rep(1/5, 5), method = \"convolution\")\nma11 = stats::filter(atletas, filter = rep(1/11, 11), method = \"convolution\")\n\nmts = ts.intersect(atletas, ma3, ma5, ma11)\n\ntbl_ma = data.frame(\n  ano = as.numeric(time(mts)),\n  zoo::coredata(mts)\n)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n```{=html}\n<div id=\"afisqkglmk\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>@import url(\"https://fonts.googleapis.com/css2?family=Chivo:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap\");\n@import url(\"https://fonts.googleapis.com/css2?family=Chivo:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap\");\n@import url(\"https://fonts.googleapis.com/css2?family=Chivo:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap\");\n@import url(\"https://fonts.googleapis.com/css2?family=Cairo:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap\");\n#afisqkglmk table {\n  font-family: Cairo, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#afisqkglmk thead, #afisqkglmk tbody, #afisqkglmk tfoot, #afisqkglmk tr, #afisqkglmk td, #afisqkglmk th {\n  border-style: none;\n}\n\n#afisqkglmk p {\n  margin: 0;\n  padding: 0;\n}\n\n#afisqkglmk .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: 400;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: none;\n  border-top-width: 3px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#afisqkglmk .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#afisqkglmk .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#afisqkglmk .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#afisqkglmk .gt_heading {\n  background-color: #FFFFFF;\n  text-align: left;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#afisqkglmk .gt_bottom_border {\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#afisqkglmk .gt_col_headings {\n  border-top-style: none;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #000000;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#afisqkglmk .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#afisqkglmk .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#afisqkglmk .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#afisqkglmk .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#afisqkglmk .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #000000;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#afisqkglmk .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#afisqkglmk .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: none;\n  border-top-width: 2px;\n  border-top-color: #000000;\n  border-bottom-style: solid;\n  border-bottom-width: 1px;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#afisqkglmk .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: none;\n  border-top-width: 2px;\n  border-top-color: #000000;\n  border-bottom-style: solid;\n  border-bottom-width: 1px;\n  border-bottom-color: #FFFFFF;\n  vertical-align: middle;\n}\n\n#afisqkglmk .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#afisqkglmk .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#afisqkglmk .gt_row {\n  padding-top: 3px;\n  padding-bottom: 3px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#afisqkglmk .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 0px;\n  border-right-color: #FFFFFF;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#afisqkglmk .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#afisqkglmk .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#afisqkglmk .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#afisqkglmk .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#afisqkglmk .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#afisqkglmk .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#afisqkglmk .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#afisqkglmk .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#afisqkglmk .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#afisqkglmk .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#afisqkglmk .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#afisqkglmk .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#afisqkglmk .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#afisqkglmk .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#afisqkglmk .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#afisqkglmk .gt_sourcenote {\n  font-size: 12px;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#afisqkglmk .gt_left {\n  text-align: left;\n}\n\n#afisqkglmk .gt_center {\n  text-align: center;\n}\n\n#afisqkglmk .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#afisqkglmk .gt_font_normal {\n  font-weight: normal;\n}\n\n#afisqkglmk .gt_font_bold {\n  font-weight: bold;\n}\n\n#afisqkglmk .gt_font_italic {\n  font-style: italic;\n}\n\n#afisqkglmk .gt_super {\n  font-size: 65%;\n}\n\n#afisqkglmk .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#afisqkglmk .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#afisqkglmk .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#afisqkglmk .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#afisqkglmk .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#afisqkglmk .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#afisqkglmk .gt_indent_5 {\n  text-indent: 25px;\n}\n\ntbody tr:last-child {\n  border-bottom: 2px solid #ffffff00;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"border-top-width: 0px; border-top-style: solid; border-top-color: black; font-family: Chivo; font-size: 14px; vertical-align: bottom; font-weight: 200; text-transform: uppercase;\" scope=\"col\" id=\"ano\">ano</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"border-top-width: 0px; border-top-style: solid; border-top-color: black; font-family: Chivo; font-size: 14px; vertical-align: bottom; font-weight: 200; text-transform: uppercase;\" scope=\"col\" id=\"atletas\">atletas</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"border-top-width: 0px; border-top-style: solid; border-top-color: black; font-family: Chivo; font-size: 14px; vertical-align: bottom; font-weight: 200; text-transform: uppercase;\" scope=\"col\" id=\"ma3\">ma3</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"border-top-width: 0px; border-top-style: solid; border-top-color: black; font-family: Chivo; font-size: 14px; vertical-align: bottom; font-weight: 200; text-transform: uppercase;\" scope=\"col\" id=\"ma5\">ma5</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"border-top-width: 0px; border-top-style: solid; border-top-color: black; font-family: Chivo; font-size: 14px; vertical-align: bottom; font-weight: 200; text-transform: uppercase;\" scope=\"col\" id=\"ma11\">ma11</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">1995</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">18.0</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">—</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">—</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">—</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">1996</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">46.6</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">49.5</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">—</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">—</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">1997</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">84.0</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">60.3</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">51.9</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">—</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">1998</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">50.4</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">65.0</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">73.6</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">—</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">1999</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">60.7</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">79.2</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">85.0</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">—</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2000</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">126.4</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">96.8</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">80.2</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">80.4</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2001</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">103.4</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">96.6</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">86.5</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">89.2</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2002</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">60.0</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">81.8</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">97.8</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">106.5</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2003</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">82.1</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">86.4</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">99.6</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">113.9</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2004</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">117.0</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">111.5</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">101.9</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">125.8</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2005</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">135.4</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">122.4</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">137.3</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">138.4</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2006</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">114.9</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">162.5</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">154.0</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">143.8</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2007</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">237.1</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">172.5</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">166.9</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">145.1</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2008</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">165.5</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">194.8</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">179.7</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">162.4</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2009</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">181.7</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">182.1</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">193.7</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">170.2</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2010</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">199.1</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">188.7</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">170.0</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">179.2</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2011</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">185.2</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">167.5</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">186.9</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">183.4</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2012</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">118.3</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">184.5</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">184.1</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">193.9</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2013</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">250.0</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">178.8</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">187.6</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">201.5</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2014</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">168.0</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">211.4</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">186.8</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">210.9</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2015</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">216.3</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">188.5</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">209.3</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">214.3</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2016</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">181.3</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">209.5</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">223.2</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">210.2</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2017</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">230.8</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">244.0</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">243.6</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">208.6</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2018</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">319.8</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">273.5</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">244.1</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">218.9</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2019</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">269.8</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">269.5</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">238.6</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">—</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2020</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">218.9</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">214.2</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">226.0</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">—</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2021</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">153.9</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">180.1</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">208.4</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">—</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2022</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">167.6</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">184.4</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">—</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">—</td></tr>\n    <tr><td headers=\"ano\" class=\"gt_row gt_right\">2023</td>\n<td headers=\"atletas\" class=\"gt_row gt_right\">231.8</td>\n<td headers=\"ma3\" class=\"gt_row gt_right\">—</td>\n<td headers=\"ma5\" class=\"gt_row gt_right\">—</td>\n<td headers=\"ma11\" class=\"gt_row gt_right\">—</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\nO gráfico abaixo mostra o ajuste de cada um dos filtros.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nautoplot(mts) + \n  scale_color_manual(\n    name = \"\",\n    values = c(\"#073B4C\", \"#FFD166\", \"#0CB0A9\", \"#F4592A\"),\n    labels = c(\"Original\", \"MA3\", \"MA5\", \"MA11\")) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## Maior eficiência\n\nNum caso aplicado, seria interessante ter uma maneira simples de escalar o processo acima para múltiplas séries de tempo. Para calcular médias móveis com grande velocidade, vamos usar o pacote `RcppRoll`, onde `cpp` significa C++, a linguagem subjacente do pacote. A função `roll_mean()` aplica uma média móvel sobre uma série.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(RcppRoll)\nroll_mean(atletas, n = 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1]  49.53333  60.33333  65.03333  79.16667  96.83333  96.60000  81.83333\n [8]  86.36667 111.50000 122.43333 162.46667 172.50000 194.76667 182.10000\n[15] 188.66667 167.53333 184.50000 178.76667 211.43333 188.53333 209.46667\n[22] 243.96667 273.46667 269.50000 214.20000 180.13333 184.43333\n```\n:::\n:::\n\n\nObjetos `ts` foram criados especificamente para armazenar séries de tempo, têm muitas praticidades, e são pré-carregados no `R`. A vasta maioria dos dados, e análises de dados, segue o paradigma de bases retangulares, de `data.frame` s por assim dizer. Neste sentido, o `ts` ou `mts` acaba sendo pouco prático[^2] quando se trabalha com múltiplas séries de tempo ou até mesmo com séries de tempo com altas frequências.\n\n[^2]: Existem, na verdade, uma infinitude de classes de objetos para lidar com séries temporais no `R`. Para uma referência veja o pacote [tsbox](https://docs.ropensci.org/tsbox/) que funciona como uma pedra de Rosetta entre esses diferentes tipos de objetos.\n\nNo exemplo abaixo vamos importar 9 séries do Índice de Produção Industrial (IPI) e aplicar uma média móvel 2x12 em cada uma delas. O código abaixo mostra como importar as séries e empilhá-las num único `tibble`. Para manipular os dados vamos utilizar o popular pacote `dplyr`[^3].\n\n[^3]: Apesar de muito bom, o `dplyr` tem um problema chato quando se trabalha com séries de tempo. Há um conflito entre as funções `dplyr::filter` e `stats::filter`, que se utiliza para calcular uma média móvel. É muito comum carregar o pacote e esquecer deste detalhe. Para resolver os conflitos basta sempre declarar a função usando o operador \"quatro pontos\", `::`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(dplyr)\n\ncode = 28503:28511\nseries = get_series(code)\nseries = lapply(series, setNames, c(\"date\", \"value\"))\nnames(series) = code\nseries = bind_rows(series, .id = \"series_id\")\n\nggplot(series, aes(date, value)) + \n  geom_line() + \n  facet_wrap(vars(series_id)) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nÉ relativamente simples aplicar o filtro sobre cada uma das séries. O gráfico mostra o resultado final.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nseries = series |> \n  group_by(series_id) |> \n  mutate(\n    trend = roll_mean(value, n = 12, fill = NA),\n    trend = roll_mean(trend, n = 2, fill = NA)\n  )\n\nggplot(series, aes(date)) + \n  geom_line(aes(y = value), alpha = 0.8, color = \"#126782\") + \n  geom_line(aes(y = trend), lwd = 0.8, color = \"#023047\") +\n  facet_wrap(vars(series_id)) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## Extraindo tendência\n\nMédias móveis fornecem uma estimativa simples da tendência de uma série. Neste sentido, é comum utilizar o filtro de médias móveis [para decompor uma série](https://restateinsight.com/posts/general-posts/2024-01-sazonalidade/#decomposição-clássica). O código abaixo usa a base `USMacroG` para importar algumas séries macroeconômicas trimestrais dos EUA no período 1947-1997[^4]. Vamos modelar a tendência das séries usando uma janela de quatro anos (dois anos para trás e dois anos para frente), ou seja, uma média móvel de ordem 25.\n\n[^4]: Para a definição das variáveis, consulte `?USMacroG`\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(AER)\nlibrary(tidyr)\ndata(\"USMacroG\")\n\nmacro = tibble(\n  date = zoo::as.Date.ts(USMacroG),\n  as.data.frame(USMacroG)\n)\n\nsubmacro = macro |> \n  filter(date >= as.Date(\"1947-01-01\"), date <= as.Date(\"1997-01-01\")) |> \n  mutate(across(gdp:m1, log))\n\nmacro_trend = submacro |> \n  select(date, gdp, consumption, invest, m1, inflation, unemp) |> \n  pivot_longer(col = -date, names_to = \"name_series\") |> \n  group_by(name_series) |> \n  mutate(\n    trend = roll_mean(value, n = 25, fill = NA),\n    detrend = value - trend) |> \n  ungroup()\n\nggplot(macro_trend, aes(date)) +\n  geom_line(aes(y = value), alpha = 0.5) +\n  geom_line(aes(y = trend), lwd = 0.8) +\n  facet_wrap(vars(name_series), scales = \"free_y\") +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nO gráfico das séries livres de tendência é apresentado abaixo. Note que as séries não foram dessazonalisadas, portanto, elas ainda apresentam oscilação sazonal.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(macro_trend, aes(date, detrend)) +\n  geom_line(lwd = 0.8) +\n  facet_wrap(vars(name_series), scales = \"free_y\") +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## Filtros complexos\n\nApesar de simples, o filtro de médias móveis é bastante utilizado e tem boas propriedades estatísticas. O gráfico abaixo compara o ajuste de um filtro de médias móveis com o filtro Baxter-King[^5], que é bastante mais sofisticado. Como se vê, ambos os filtros chegam em resultados muito similares.\n\n[^5]: M. Baxter and R.G. King. Measuring business cycles: Approximate bandpass filters. The Review of Economics and Statistics, 81(4):575-93, 1999.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(mFilter)\n\ntbl_unemp = select(macro, date, unemp)\nbk = mFilter::bkfilter(tbl_unemp$unemp, 6, 32, nfix = 12)\n\ntbl_unemp = tbl_unemp |> \n  mutate(\n    ma = roll_mean(unemp, n = 25, fill = NA, align = \"center\"),\n    bk = mFilter::bkfilter(unemp, 6, 32, nfix = 12)$trend\n  ) |> \n  pivot_longer(cols = -date, names_to = \"series\")\n\nggplot(tbl_unemp, aes(date, value, color = series)) +\n  geom_line(data = filter(tbl_unemp, series == \"unemp\")) +\n  geom_line(data = filter(tbl_unemp, series != \"unemp\"), lwd = 0.9) +\n  scale_color_manual(\n    name = \"\",\n    values = c(\"#FFD166\", \"#0CB0A9\", \"#073B4C\"),\n    labels = c(\"Baxter-King\", \"MA25\", \"Original\")\n  ) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## Médias móveis exponenciais\n\nO filtro de médias móveis exponenciais ou EWMA (exponentially weighted moving average) é bastante popular em finanças. Na prática, ele é um caso específico de suvização exponencial[^6]. Tecnicamente, seria possível implementá-lo usando `stats::filter` fornecendo os pesos adequados. O código abaixo replica o primeiro exemplo, da série \"passe de atletas\".\n\n[^6]: Para uma boa introdução a suvização exponencial usando o pacote `forecast` consulte [Forecasting: Principles and Practice (2ed)](https://otexts.com/fpp2/expsmooth.html).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\newma_wgt = function(alpha = 0.5, order = 3) { rev((1 - alpha)^(seq(1, order))) }\n\newma3 = stats::filter(atletas, filter = c(1/8, 1/4, 1/2), sides = 1L)\newma5 = stats::filter(atletas, filter = ewma_wgt(order = 5), sides = 1L)\newma11 = stats::filter(atletas, filter = ewma_wgt(order = 11), sides = 1L)\n\n\nmts = ts.intersect(atletas, ewma3, ewma5, ewma11)\n\nautoplot(mts) + \n  scale_color_manual(\n    name = \"\",\n    values = c(\"#073B4C\", \"#FFD166\", \"#0CB0A9\", \"#F4592A\"),\n    labels = c(\"Original\", \"MA3\", \"MA5\", \"MA11\")) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nO exemplo acima é um tanto quanto artificial. Tipicamente, o filtro EWMA é utilizado em séries financeiras de alta frequência. O código abaixo usa o pacote TTR (Technical Trading Rules), especializado em funções para finanças, para computar o EWMA de uma série de preço. Para tornar o exemplo mais simples vamos aproveitar a base `ttrc` do próprio pacote.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(TTR)\ndata(ttrc)\n\nttrc = ttrc |> \n  rename_with(tolower) |> \n  dplyr::filter(date >= as.Date(\"2004-01-01\")) |> \n  mutate(\n    trend07 = EMA(close, n = 7),\n    trend30 = EMA(close, n = 30),\n    trend50 = EMA(close, n = 50)\n    ) |> \n  select(date, close, starts_with(\"trend\")) |> \n  pivot_longer(cols = -date, names_to = \"series\")\n\nggplot(ttrc, aes(x = date, y = value, color = series)) +\n  geom_line(data = dplyr::filter(ttrc, series == \"close\"), alpha = 0.8) +\n  geom_line(data = dplyr::filter(ttrc, series != \"close\"), lwd = 0.5) +\n  scale_color_manual(\n    name = \"\",\n    values = c(\"#073B4C\", \"#FFD166\", \"#0CB0A9\", \"#F4592A\"),\n    labels = c(\"Original\", \"EWMA7\", \"EWMA25\", \"EWMA50\")) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){fig-align='center' width=90%}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
{
  "hash": "8dce08a0e7a2ffaa1321a7e9b1aaf6dc",
  "result": {
    "markdown": "---\ntitle: \"GDP in Brazil\"\ndate: \"2024-04-20\"\ncategories: ['data-visualization', 'brazil', 'maps', 'ggplot2']\ndescription: \"A choropleth map showing the spatial distribution of Brazilian GDP by city. Colors represent the economic sector with the highest share of contribution to total city GDP. Data comes from the most recent National Accounts data from IBGE (2023).\"\nexecute: \n  message: false\n  warning: false\n---\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Libraries\nlibrary(geobr)\nlibrary(sf)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(stringr)\nlibrary(MetBrewer)\nlibrary(showtext)\n\n# Color palette\ncores = met.brewer(\"Hiroshige\", 20)[c(1, 8, 15, 20)]\n# Import Gill Sans locally\nfont_add(\"Gill Sans\", \"GillSans.ttc\")\nshowtext_auto()\n\n# Data ------------------------------------------------------------------\n\n# Shapes\n\n# Import city shapefile\nmunis <- read_municipality(year = 2022, showProgress = FALSE)\n# Import state shapefile\ngeostate <- read_state(showProgress = FALSE)\n\n# Import city data from Brazil (see data/raw/R/painel_municipios.R)\npanel <- readr::read_csv(here::here(\"static/data\", \"cities_brazil.csv\"))\n\n## Data cleaning --------------------------------------------------------\n\n# Vector to select GDP columns\npib_cols = c(\"pib_agriculture\", \"pib_industrial\", \"pib_services\",\n             \"pib_govmt_services\")\n\n# Compute GDP share by city\npib_share = panel |> \n  select(all_of(c(\"code_muni\", \"pib\", pib_cols))) |> \n  pivot_longer(cols = 3:last_col(), names_to = \"sector\", values_to = \"total\") |> \n  mutate(\n    share = total / pib * 100,\n    # Improve text labels\n    sector_label = str_remove(sector, \"pib_\"),\n    sector_label = str_to_title(sector_label),\n    sector_label = str_replace(sector_label, \"Govmt_services\", \"Government\"),\n    sector_label = str_replace(sector_label, \"Industrial\", \"Industry\")\n    )\n\n# Convert to wider\ntab_pib_share = pib_share |> \n  pivot_wider(\n    id_cols = \"code_muni\",\n    names_from = \"sector\",\n    values_from = \"share\"\n    )\n\n# Find the most relevant economic sector by city\ntop_pib_share = pib_share |> \n  filter(share == max(share), .by = \"code_muni\") |> \n  select(code_muni, top_sector = sector_label)\n\n# Join tabular data with city shapefile\nmap_share = munis |> \n  left_join(tab_pib_share, by = \"code_muni\") |> \n  left_join(top_pib_share, by = \"code_muni\")\n\n# Map -------------------------------------------------------------------\n\nm1 = ggplot() +\n  # State borders\n  geom_sf(data = geostate, lwd = 0.3, color = \"gray30\", fill = \"white\") +\n  # City colors\n  geom_sf(\n    data = na.omit(map_share),\n    aes(fill = top_sector),\n    lwd = 0.01,\n    color = \"gray90\"\n    ) +\n  # Remove junk from the east coast\n  coord_sf(xlim = c(NA, -35)) +\n  # Use Hiroshige colors\n  scale_fill_manual(name = \"\", values = cores) +\n  labs(\n    title = \"Top GDP contribution by City (2021)\",\n    subtitle = \"Colors represent the most relevant economic contributing group in each city\",\n    caption = \"Source: National Accounts, IBGE (2023)\") +\n  ggthemes::theme_map(base_family = \"Gill Sans\") +\n  # Thematic elements\n  theme(\n    # Background\n    panel.background = element_rect(fill = \"#ffffff\", color = NA),\n    plot.background = element_rect(fill = \"#ffffff\", color = NA),\n    # Legend\n    legend.position = \"left\",\n    legend.justification = 0.5,\n    legend.key.size = unit(1, \"cm\"),\n    legend.key.width = unit(1.5, \"cm\"),\n    legend.text = element_text(size = 12),\n    legend.margin = margin(),\n    # Labels (title, subtitle)\n    plot.title = element_text(size = 38, hjust = 0.5),\n    plot.subtitle = element_text(size = 14, hjust = 0.5),\n    # Plot margins\n    plot.margin = margin(10, 5, 5, 10)\n  )\n\n# Histogram -------------------------------------------------------------\n\npib_bars = top_pib_share |> \n  count(top_sector) |> \n  mutate(top_sector = forcats::fct_rev(top_sector))\n\np_hist = ggplot(pib_bars, aes(top_sector, n)) +\n  geom_col(aes(fill = top_sector)) +\n  # Number labels\n  geom_text(\n    aes(y = n, label = n, color = factor(c(0, 0, 0, 1))),\n    size = 4,\n    family = \"Gill Sans\",\n    nudge_y = c(-200, -200, 200, -200)\n    ) +\n  # Text labels\n  geom_text(\n    aes(y = 50, label = top_sector, color = factor(c(0, 0, 0, 1))),\n    family = \"Gill Sans\",\n    size = 4,\n    hjust = 0\n  ) +\n  # Flip axis\n  coord_flip() +\n  scale_fill_manual(values = rev(cores)) +\n  scale_color_manual(values = c(\"black\", \"white\")) +\n  labs(x = NULL, y = NULL, title = \"Number of cities\") +\n  guides(fill = \"none\", color = \"none\") +\n  theme_minimal(base_family = \"Gill Sans\") +\n  theme(\n    plot.title = element_text(size = 14, hjust = 0.5),\n    panel.grid.major = element_blank(),\n    panel.grid.minor = element_blank(),\n    axis.text = element_blank()\n    )\n```\n:::\n\n\n# GDP Contribution by city\n\n-   The number of cities where Agriculture is the main driver of the local economy rose from 1049 in 2020 to 1272 in 2021. Agriculture is most prevalent in the Midwest cities.\n\n-   Public Administration is the most prevalent economic activity among cities in the North and Northeast of the country. General services are most prevalent in the Southeast.\n\n-   Industrial activities constitute the primary economic driver for fewer than 8% of cities. The few industrial cities are spatially disperse across the country, exhibiting no clear pattern.\n\n\n::: {.cell fig.showtext='true'}\n::: {.cell-output-display}\n![](index_files/figure-html/map-1.svg){width=100% height=900px}\n:::\n:::\n\n\n-   Dados: IBGE, Contas Nacionais, Produto Interno Bruto dos Munic√≠pios (2023)\n\n-   Tipografia: Gill Sans\n\n-   Paleta: `Hiroshige` (MetBrewer)\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
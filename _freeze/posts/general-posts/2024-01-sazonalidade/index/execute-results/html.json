{
  "hash": "18d8c4af68eadfaef03d4b08a053cd4c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Tendência e Sazonalidade\"\ndate: '2024-01-23'\ncategories: ['data-science', 'economia', 'tutorial-R', 'econometria', 'time-series']\ndescription: 'Séries de tempo apresentam diversos padrões sazonais. Em econometria, o interesse nem sempre está na sazonalidade, em si, mas na sua eliminação para chegar na tendência de uma série. Este post apresenta algumas maneiras para visualizar e modelar a sazonalidade de uma série.'\nimage: \"/static/plots/series_trend_decomposition_stl.png\"\n---\n\n\n\n\n\n# Tendência e Sazonalidade\n\nSéries de tempo costumam exibir alguns padrões similares. Uma abordagem particularmente útil é de decompor uma série de tempo em componentes, que representam características específicas. Pode-se pensar numa série de tempo como uma conjunção de três componentes:\n\n1.  Tendência\n2.  Sazonalidade\n3.  Resíduo (resto, ruído, etc.)\n\nEm geral, a tendência varia pouco no tempo, segue algum ciclo longo, como a **tendência de crescimento do PIB** de um país. O movimento sazonal de uma série reflete algum tipo de **variação períodica**. Muitas séries possuem sazonalidade, como nfa demanda por energia elétrica ao longo dos trimestres, o [número de nascimentos a cada mês](https://restateinsight.com/posts/general-posts/2023-10-nascimentos-brasil/), o número diário de acidentes de trânsito a cada semana, a temperatura média ao longo do dia, etc.\n\nEntender a sazonalidade de um fenômeno é essencial para a sua modelagem estatística. Vale notar que, usualmente, o interesse de economistas e econometristas não está na sazonalidade em si, mas sim na *série dessazonalizada*, isto é, livre de qualquer sazonalidade. Esta abordagem enfatiza mais a busca pela tendência \"limpa\" da série do que pelo efeito sazonal.\n\nA sazonalidade se expressa em várias frequências, mas a ênfase deste post será em sazonalidades mensais e trimestrais. Sazonalidades complexas (mistas, por exemplo) ou de alta frequência (intradiária, diária, semanal), em geral, exigem um pouco mais de esforço no setup e pacotes específicos[^1].\n\n[^1]: Para uma referência para séries com sazonalidade complexa no R veja [Hyndman e Athansopoulos (2021) Forecasting: Principles and Practice](https://otexts.com/fpp3/complexseasonality.html).\n\n# Setup\n\nPrimeiro, vamos carregar os pacotes necessários para seguir este post.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n#> Séries de tempo em geral\nlibrary(forecast)\n#> X-13-ARIMA-SEATS\nlibrary(seasonal)\n#> Ler e converter objetos ts\nlibrary(zoo)\n#> Gráficos\nlibrary(ggplot2)\n#> Testes de sazonalidade\nlibrary(seastests)\n\n\n#> Auxiliares\nlibrary(rvest)\nlibrary(readr)\nlibrary(dplyr)\n#> https://github.com/wilsonfreitas/rbcb\nlibrary(rbcb)\n```\n:::\n\n\nVou também definir um tema para os gráficos. Este passo é opcional.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntheme_series = theme_bw(base_size = 10, base_family = \"sans\") +\n  theme(\n    panel.grid.minor = element_blank(),\n    axis.text.x = element_text(angle = 90)\n  )\n```\n:::\n\n\n# Visualizando sazonalidade\n\nHá alguns recursos simples para melhor visualizar o padrão sazonal de uma série. Primeiro vamos importar a série de Custos de Construção do IPI (Índice de Produção Industrial). O código abaixo importa a série e converte o data.frame para um objeto `ts`. Para facilitar a visualização dos gráficos uso um tema customizado, definido acima `theme_series`.\n\nNote que esta série possui sazonalidade e também uma tendência. Inicialmente, há uma tendência de queda, no período 2014-2016; depois, há uma tendência de estabilidade, que é quebrada momentaneamente no início da pandemia do Covid-19.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n#> Série do Índice de Produção Industrial - Insumos da Construção Civil\nipi = rbcb::get_series(21868, as = \"ts\")\n\nautoplot(ipi) + theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nA segunda série que vamos importar é a da demanda residencial por energia elétrica no Brasil. Esta série possui uma clara tendência de crescimento e, também, uma tendência sazonal.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n#> Série de demanda por energia elétrica residencial (Brasil)\nenerg = rbcb::get_series(1403, as = \"ts\", start_date = as.Date(\"2002-01-01\"))\n\nautoplot(energ) + theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nA maneira mais simples de visualizar o efeito sazonal é comparando o valor de cada período dentro do seu ciclo. No caso de uma série mensal, temos (potencialmente) um ciclo que se repete a cada ano. O gráfico abaixo mostra os valores da série do IPI-CC mês a mês em cada ano. Visualmente, parece haver um pico em outubro seguido por um queda nos meses seguintes.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggseasonplot(ipi) +\n  scale_color_viridis_d() +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nA função `ggsubseriesplot` cria pequenos gráficos ordenando as observações dentro de cada mês. As linhas representam as observações de cada mês, ano a ano. Neste caso, é um pouco difícil enxergar a tendência sazonal já que há uma forte tendência de queda no período 2012-2014.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggsubseriesplot(ipi) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nAcaba sendo mais fácil visualizar a sazonalidade quando se olha para a série a partir de 2016, quando a tendência fica mais estável. Os meses de julho a outubro parecem ser um período de alta. Já o mês de dezembro parece ser um mês de baixa.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggsubseriesplot(window(ipi, start = c(2016, 1))) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nTambém é possível fazer um lag plot convencional.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ngglagplot(ipi, seasonal = TRUE, do.lines = FALSE, lags = 12) +\n  scale_color_viridis_d() +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\nComo comentado, a série de energia elétrica também possui padrão sazonal. Em geral, parece haver um consumo maior de energia em dezembro e um consumo menor em junho.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggseasonplot(energ) + theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nAlternativamente, pode-se fazer um boxplot mês a mês da série. No caso abaixo, remove-se primeiro a tendência da série da energia elétrica usando um polinômio de terceiro grau. No gráfico, vê-se como a tendência sazonal aponta para menor consumo de energia nos meses de inverno, de junho a agosto, e de maior consumo nos meses de calor, de novembro a janeiro.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\n#> Série de demanda por energia elétrica residencial (Brasil)\nenerg = rbcb::get_series(\n  1403,\n  as = \"tibble\",\n  start_date = as.Date(\"2002-01-01\")\n)\n\n#> Regressão com tendência polinomial\nnames(energ) = c(\"date\", \"consumo\")\nenerg$consumo = ts(log(energ$consumo), start = c(2002, 1), frequency = 12)\nenerg$trend = time(energ$consumo)\nreg_lm = lm(consumo ~ poly(trend, 3, raw = TRUE), data = energ)\nenerg$detrend = residuals(reg_lm)\nenerg$mes = lubridate::month(energ$date, label = TRUE)\n\np1 <- ggplot(energ, aes(x = date, y = detrend)) +\n  geom_line() +\n  xlab(NULL) +\n  theme_series\n\np2 <- ggplot(energ, aes(x = mes, y = detrend)) +\n  geom_boxplot() +\n  geom_point(position = position_jitter(0.25), alpha = 0.5) +\n  xlab(NULL) +\n  theme_series\n\nlibrary(patchwork)\n\np1 / p2 + plot_layout(heights = c(1 / 3, 2 / 3))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\nPor fim, vale comentar que também é possível visualizar o padrão sazonal de série com frequência mais alta. O painel abaixo mostra a temperatura média (hora a hora) na estação Jardim Botânico de Porto Alegre (RS) nos primeiros três meses de 2023. Como comentei anteriormente, este tipo de série exige alguns pacotes específicos como `xts` para ser melhor processado pelo `R`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntemp = readr::read_rds(\n  \"https://github.com/viniciusoike/restateinsight/raw/main/static/data/temperatura_poa_2023.rds\"\n)\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ntemp = subset(temp, mes <= 3)\ntemp$mes = factor(temp$mes, labels = c(\"Jan\", \"Fev\", \"Mar\"))\ntemp$ins_c = zoo::na.spline(temp$temp_ins_c)\n\nggplot(temp, aes(x = hora, y = temp_ins_c, color = mes, group = date_ymd)) +\n  geom_line(alpha = 0.8) +\n  facet_wrap(vars(mes), ncol = 1) +\n  scale_x_continuous(breaks = 0:23) +\n  guides(color = \"none\") +\n  labs(\n    title = \"Temperatura média Porto Alegre\",\n    x = \"Hora do dia\",\n    y = \"Celsius\"\n  ) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n# Decomposição Clássica\n\nA forma \"clássica\" de se modelar sazonalidade numa série é decompondo ela em três componentes: tendência, sazonalidade, e ruído. Assim, temos:\n\n$$\ny_{t} = T_{t} + S_{t} + u_{t}\n$$\n\nEm geral, a tendência $T_{t}$ é um polinômio, de primeiro ou segundo grau[^2], que depende do tempo ou uma média móvel simples. Já a sazonalidade, $S_{t}$ entra linearmente no modelo: coloca-se uma variável binária (*dummy*) para cada período sazonal. No caso de uma série com sazonalidade mensal, isto significa incluir onze variáveris binárias[^3]. O caso de uma tendência linear com sazonalidade \"determinística\"[^4] é expresso na equação abaixo.\n\n[^2]: Pode-se usar um polinômio de qualquer grau, mas polinômios de ordens muito elevadas costumam se ajustar \"perfeitamente\" aos dados e vão absorver toda a sazonalidade da série.\n\n[^3]: Sempre coloca-se uma variável binária a menos do que períodos sazonais pela questão do posto da matriz de regressores. Na prática, se houvesse uma dummy para cada período sazonal a matriz de regressão seria uma matriz identidade.\n\n[^4]: É comum ver esta expressão nos textos de séries de tempo; em geral o termo é utilizado em contraste com modelos SARIMA onde a sazonalidade é estocástica, mas o termo \"determinístico\" não tem implicação causal. Na prática, quer dizer que a sazonalidade não varia no tempo e é sempre a mesma o que pode gerar previsões ruins a depender do caso.\n\n$$\ny_{t} = \\alpha_{0} + \\alpha_{1}t + \\sum_{i = 1}^{11}\\beta_{i}\\delta_{i} + u_{t}\n$$\n\nNeste tipo de regressão o \"período-base\" fica incorporado no termo de constante. Isto é, imaginando que temos uma série mensal e que janeiro seja o mês-base, o efeito de janeiro ficaria estimado junto com $\\alpha_{0}$ e os demais parâmetros. O código abaixo estima esta regressão na série de Custos de Construção do IPI e mostra os resultados.\n\nRelativamente ao mês base (janeiro), os meses de julho a agosto exibem valores positivos de maior magnitude. Isto corrobora a inspeção visual, que apontava que estes meses eram um \"período de alta\". Além disso, o modelo estima uma tendência linear e negativa, sinalizando a queda dos valores da série ao longo do tempo.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodel_lm <- tslm(ipi ~ trend + season)\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"tgemcilrac\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#tgemcilrac table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#tgemcilrac thead, #tgemcilrac tbody, #tgemcilrac tfoot, #tgemcilrac tr, #tgemcilrac td, #tgemcilrac th {\n  border-style: none;\n}\n\n#tgemcilrac p {\n  margin: 0;\n  padding: 0;\n}\n\n#tgemcilrac .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#tgemcilrac .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#tgemcilrac .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#tgemcilrac .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#tgemcilrac .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#tgemcilrac .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#tgemcilrac .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#tgemcilrac .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#tgemcilrac .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#tgemcilrac .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#tgemcilrac .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#tgemcilrac .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#tgemcilrac .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#tgemcilrac .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#tgemcilrac .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#tgemcilrac .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#tgemcilrac .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#tgemcilrac .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#tgemcilrac .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#tgemcilrac .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#tgemcilrac .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#tgemcilrac .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#tgemcilrac .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#tgemcilrac .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#tgemcilrac .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#tgemcilrac .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#tgemcilrac .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#tgemcilrac .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#tgemcilrac .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#tgemcilrac .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#tgemcilrac .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#tgemcilrac .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#tgemcilrac .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#tgemcilrac .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#tgemcilrac .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#tgemcilrac .gt_left {\n  text-align: left;\n}\n\n#tgemcilrac .gt_center {\n  text-align: center;\n}\n\n#tgemcilrac .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#tgemcilrac .gt_font_normal {\n  font-weight: normal;\n}\n\n#tgemcilrac .gt_font_bold {\n  font-weight: bold;\n}\n\n#tgemcilrac .gt_font_italic {\n  font-style: italic;\n}\n\n#tgemcilrac .gt_super {\n  font-size: 65%;\n}\n\n#tgemcilrac .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#tgemcilrac .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#tgemcilrac .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#tgemcilrac .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#tgemcilrac .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#tgemcilrac .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#tgemcilrac .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#tgemcilrac .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#tgemcilrac div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"label\"><span data-qmd-base64=\"KipDaGFyYWN0ZXJpc3RpYyoq\"><span class='gt_from_md'><strong>Characteristic</strong></span></span></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"estimate\"><span data-qmd-base64=\"KipCZXRhKio=\"><span class='gt_from_md'><strong>Beta</strong></span></span></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"conf.low\"><span data-qmd-base64=\"Kio5NSUgQ0kqKg==\"><span class='gt_from_md'><strong>95% CI</strong></span></span></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"p.value\"><span data-qmd-base64=\"KipwLXZhbHVlKio=\"><span class='gt_from_md'><strong>p-value</strong></span></span></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">trend</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-0.2220</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">-0.2600, -0.1840</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">season</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\"><br /></td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\"><br /></td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><br /></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    1</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">—</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">—</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><br /></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    2</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-0.0923</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">-8.6324, 8.4479</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\">>0.9</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    3</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">8.8868</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">0.3464, 17.4273</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\">0.042</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    4</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">2.8731</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">-5.6677, 11.4140</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\">0.5</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    5</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">7.9951</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">-0.5463, 16.5365</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\">0.066</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    6</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">6.0100</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">-2.5322, 14.5522</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\">0.2</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    7</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">12.1720</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">3.4692, 20.8747</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\">0.006</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    8</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">16.2094</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">7.5065, 24.9122</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    9</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">11.1160</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">2.4129, 19.8191</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\">0.013</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    10</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">15.8841</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">7.1806, 24.5876</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    11</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">9.0984</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">0.3943, 17.8025</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\">0.041</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    12</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-6.4642</td>\n<td headers=\"conf.low\" class=\"gt_row gt_center\">-15.1690, 2.2406</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\">0.14</td></tr>\n  </tbody>\n  <tfoot class=\"gt_sourcenotes\">\n    <tr>\n      <td class=\"gt_sourcenote\" colspan=\"4\"><span data-qmd-base64=\"QWJicmV2aWF0aW9uOiBDSSA9IENvbmZpZGVuY2UgSW50ZXJ2YWw=\"><span class='gt_from_md'>Abbreviation: CI = Confidence Interval</span></span></td>\n    </tr>\n  </tfoot>\n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\nO gráfico abaixo mostra o ajuste \"interno\" da série. Note como a série vermelha, dos valores previstos, exibe uma tendência linear simples e um padrão sazonal fixo e recorrente. O padrão sazonal é relativamente resiliente a outliers como no caso do início da pandemia.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nautoplot(ipi) +\n  autolayer(fitted(model_lm)) +\n  guides(color = \"none\") +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nA decomposição clássica é bastante simples. Note que a regressão acima estima o efeito mês a mês da sazonalidade (relativamente ao mês-base), o que pode ser bastante interessante por permitir uma interpretação simples dos dados. Além disso, é bastante fácil de gerar previsões a partir deste modelo. O exemplo abaixo mostra a previsão 18 meses à frente do nosso modelo linear.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfcast = forecast(model_lm, h = 18)\n\nautoplot(fcast, include = 72) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-17-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nPode-se também modelar a tendência de maneiras um pouco mais sofisticadas. Uma opção simples é usar uma média móvel. No exemplo abaixo uso uma média móvel de 12x2 meses. O resultado é apresentado na linha azul junto com a série original.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nma_trend = stats::filter(\n  ipi,\n  filter = c(1 / 24, rep(1 / 12, 10), 1 / 24),\n  method = \"convolution\"\n)\n\nautoplot(ipi) +\n  autolayer(ma_trend, color = \"blue\") +\n  guides(color = \"none\") +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-18-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nPara remover a tendência subtrai-se a média móvel, calculada acima, da série original. Assim, tem-se somente o componente sazonal e o ruído.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nipi_detrend = ipi - ma_trend\n\nautoplot(ipi_detrend) + theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-19-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nNovamente, usando um modelo linear simples, temos a modelagem apenas do padrão sazonal.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodel_lm2 = tslm(ipi_detrend ~ season)\n\nautoplot(ipi_detrend) +\n  autolayer(fitted(model_lm2)) +\n  guides(color = \"none\") +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nComparando os modelos, vê-se que as estimativas dos efeitos sazonais são diferentes.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"ntgjenxmmf\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#ntgjenxmmf table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#ntgjenxmmf thead, #ntgjenxmmf tbody, #ntgjenxmmf tfoot, #ntgjenxmmf tr, #ntgjenxmmf td, #ntgjenxmmf th {\n  border-style: none;\n}\n\n#ntgjenxmmf p {\n  margin: 0;\n  padding: 0;\n}\n\n#ntgjenxmmf .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#ntgjenxmmf .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#ntgjenxmmf .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#ntgjenxmmf .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#ntgjenxmmf .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ntgjenxmmf .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ntgjenxmmf .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ntgjenxmmf .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#ntgjenxmmf .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#ntgjenxmmf .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#ntgjenxmmf .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#ntgjenxmmf .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#ntgjenxmmf .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#ntgjenxmmf .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#ntgjenxmmf .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#ntgjenxmmf .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#ntgjenxmmf .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#ntgjenxmmf .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#ntgjenxmmf .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ntgjenxmmf .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#ntgjenxmmf .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#ntgjenxmmf .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#ntgjenxmmf .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ntgjenxmmf .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#ntgjenxmmf .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#ntgjenxmmf .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ntgjenxmmf .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ntgjenxmmf .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#ntgjenxmmf .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ntgjenxmmf .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#ntgjenxmmf .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ntgjenxmmf .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ntgjenxmmf .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ntgjenxmmf .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ntgjenxmmf .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ntgjenxmmf .gt_left {\n  text-align: left;\n}\n\n#ntgjenxmmf .gt_center {\n  text-align: center;\n}\n\n#ntgjenxmmf .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#ntgjenxmmf .gt_font_normal {\n  font-weight: normal;\n}\n\n#ntgjenxmmf .gt_font_bold {\n  font-weight: bold;\n}\n\n#ntgjenxmmf .gt_font_italic {\n  font-style: italic;\n}\n\n#ntgjenxmmf .gt_super {\n  font-size: 65%;\n}\n\n#ntgjenxmmf .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#ntgjenxmmf .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#ntgjenxmmf .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#ntgjenxmmf .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#ntgjenxmmf .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#ntgjenxmmf .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#ntgjenxmmf .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#ntgjenxmmf .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#ntgjenxmmf div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings gt_spanner_row\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"2\" colspan=\"1\" scope=\"col\" id=\"label\"><span data-qmd-base64=\"KipDaGFyYWN0ZXJpc3RpYyoq\"><span class='gt_from_md'><strong>Characteristic</strong></span></span></th>\n      <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"2\" scope=\"colgroup\" id=\"level 1; estimate_1\">\n        <div class=\"gt_column_spanner\"><span data-qmd-base64=\"VGVuZMOqbmNpYSBsaW5lYXI=\"><span class='gt_from_md'>Tendência linear</span></span></div>\n      </th>\n      <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"2\" scope=\"colgroup\" id=\"level 1; estimate_2\">\n        <div class=\"gt_column_spanner\"><span data-qmd-base64=\"TcOpZGlhIE3Ds3ZlbA==\"><span class='gt_from_md'>Média Móvel</span></span></div>\n      </th>\n    </tr>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"estimate_1\"><span data-qmd-base64=\"KipCZXRhKio=\"><span class='gt_from_md'><strong>Beta</strong></span></span></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"p.value_1\"><span data-qmd-base64=\"KipwLXZhbHVlKio=\"><span class='gt_from_md'><strong>p-value</strong></span></span></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"estimate_2\"><span data-qmd-base64=\"KipCZXRhKio=\"><span class='gt_from_md'><strong>Beta</strong></span></span></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"p.value_2\"><span data-qmd-base64=\"KipwLXZhbHVlKio=\"><span class='gt_from_md'><strong>p-value</strong></span></span></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">trend</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">-0.2220</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\"><0.001</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\"><br /></td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\"><br /></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">season</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\"><br /></td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\"><br /></td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\"><br /></td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\"><br /></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    1</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">—</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\"><br /></td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">—</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\"><br /></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    2</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">-0.0923</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\">>0.9</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">-0.2292</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\">0.9</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    3</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">8.8868</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\">0.042</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">8.7920</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    4</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">2.8731</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\">0.5</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">2.5927</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\">0.2</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    5</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">7.9951</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\">0.066</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">6.4042</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    6</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">6.0100</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\">0.2</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">4.6021</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\">0.010</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    7</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">12.1720</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\">0.006</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">11.7918</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    8</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">16.2094</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\"><0.001</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">16.1563</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    9</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">11.1160</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\">0.013</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">11.1553</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    10</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">15.8841</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\"><0.001</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">15.8405</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    11</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">9.0984</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\">0.041</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">9.1553</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    12</td>\n<td headers=\"estimate_1\" class=\"gt_row gt_center\">-6.4642</td>\n<td headers=\"p.value_1\" class=\"gt_row gt_center\">0.14</td>\n<td headers=\"estimate_2\" class=\"gt_row gt_center\">-6.2197</td>\n<td headers=\"p.value_2\" class=\"gt_row gt_center\"><0.001</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n# Testando sazonalidade\n\nExistem testes estatísticos formais para verificar a presença de sazonalidade em uma série. Pessoalmente, foram raras as ocasiões em que vi alguém testando a presença de sazonalidade; em geral, a inspeção visual é suficiente. Um teste bastante simples é verificar se coeficientes das dummies sazonais, dos modelos de regressão acima, são conjuntamente iguais a zero, isto é:\n\n$$\nH_{o} = \\beta_{1} = \\beta_{2} = \\dots = \\beta_{11} = 0\n$$\n\nNo caso em que a hipótese nula é rejeitada, tem-se evidência de sazonalidade na série. Ou seja, essencialmente, faz-se um teste F para verificar a significância dos parâmetros relacionados aos termos de sazonalidade.\n\nHá também dois possíveis testes não-paramétricos: (1) Teste de Kruskal-Wallis; e (2) Teste de Friedman.\n\n### Krukal-Wallis\n\nO [teste de Kruskal-Wallis](https://en.wikipedia.org/wiki/Kruskal–Wallis_one-way_analysis_of_variance) (KW) verifica se amostras distintas foram geradas pela mesma distribuição. No caso de séries de tempo, pode-se adaptar este teste. Supondo uma série mensal, cada ano fornece 12 observações e queremos verificar se existe uma diferença entre os anos. Assim temos k amostras (k anos) de 12 observações.\n\nVale notar que o teste tem de ser feito sobre a série sem tendência. Aqui, aproveito a série livre de tendência utilizando o filtro MA 12x2, feito anteriormente.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# model_arima = Arima(ipi, order = c(0, 1, 1))\n# ipi_detrend = residuals(model_arima)\n\ndf = data.frame(\n  date = as.Date.ts(ipi_detrend),\n  value = as.numeric(ipi_detrend)\n)\n\ntab = df |>\n  dplyr::filter(!is.na(value)) |>\n  dplyr::mutate(\n    rank = rank(value, ties.method = \"average\"),\n    mes = lubridate::month(date),\n    ano = lubridate::year(date)\n  )\n\ntab |>\n  tidyr::pivot_wider(\n    id_cols = \"ano\",\n    names_from = \"mes\",\n    values_from = \"rank\",\n    names_sort = TRUE\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 13 × 13\n     ano   `1`   `2`   `3`   `4`   `5`   `6`   `7`   `8`   `9`  `10`  `11`  `12`\n   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n 1  2012    NA  NA      NA    NA    NA    53   109   148   104   149   114  14  \n 2  2013    42   9      84   122   106    63   128   147   124   150   123   8  \n 3  2014    38  46      87    61   103    21   117   143   145   151   120  11  \n 4  2015    33  26     140    68    67    48   119   129   111   144    80   2  \n 5  2016    12  29      93    66    88    76   108   138    78    85    60   7  \n 6  2017    27  25     121    22    72    49    74   132    82   105    91  18  \n 7  2018    36  23      79    50    19    69    92   134    86   133    65  10  \n 8  2019    35  40      44    47    89    41   113   125    94   141   116  17  \n 9  2020    57  55      43     1     3    30   136   142   139   146   102  31.5\n10  2021    39  34      95    54    77    73   115   127   110   101    75  13  \n11  2022    15  24      83    45   100    64    98   137    90   118    59   5  \n12  2023    16  20     112    37    99    70    96   130    62    97    56   6  \n13  2024    28  31.5    52    71    58    51   126   131   107   135    81   4  \n```\n\n\n:::\n:::\n\n\nA hipótese nula do teste é de que as diferentes amostras foram geradas pela mesma distribuição. Como se vê abaixo, o teste é rejeitado, implicando que há presença de sazonalidade.\n\nVale notar que o teste tem duas hipóteses bastante frágeis no contexto de séries de tempo. Primeiro, o teste supõe que as observações dentro de cada grupo são independentes, isto é, de que as observações de cada mês (janeiro, fevereiro, etc.) são indepedentes. Segundo, o teste supõe que as amostras (anos) são independentes entre si.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nkruskal.test(tab$rank, tab$mes)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tKruskal-Wallis rank sum test\n\ndata:  tab$rank and tab$mes\nKruskal-Wallis chi-squared = 116.68, df = 11, p-value < 2.2e-16\n```\n\n\n:::\n:::\n\n\n### Friedman\n\nO teste de Friedman é muito similar ao teste KW, mas não exige independência das observações dentro de cada grupo (mês). O código abaixo executa o teste. Note que é preciso remover os anos incompletos, pois o teste somente funciona quando as amostras tem tamanho igual. Novamente, rejeita-se a hipótese nula, sugerindo que existe um padrão sazonal na série.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntab = df |>\n  dplyr::mutate(\n    mes = lubridate::month(date),\n    ano = lubridate::year(date)\n  ) |>\n  dplyr::filter(!is.na(value), ano > 2012, ano < 2023) |>\n  dplyr::mutate(rank = rank(value), .by = \"ano\")\n\nfriedman.test(tab$rank, tab$mes, tab$ano)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tFriedman rank sum test\n\ndata:  tab$rank, tab$mes and tab$ano\nFriedman chi-squared = 87.569, df = 11, p-value = 4.984e-14\n```\n\n\n:::\n:::\n\n\n### seastests\n\nPor fim, vale notar o pacote `seastests`, que fornece alguns testes adicionais para verificar a presença de sazonalidade em uma série. O código abaixo executa os mesmos testes. Note que o valor da estatística de teste é diferente (ainda que a interpretação final continue a mesma). Isto acontece pois a função remove a tendência usando um modelo ARIMA (selecionado via a função `auto.arima`). Por fim, a função `isSeasonal` combina cinco testes de sazonalidade distintos e retorna um valor lógico, indicando se há sazonalidade na série.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(seastests)\n\nkw(ipi, 12, diff = FALSE, residuals = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTest used:  Kruskall Wallis \n \nTest statistic:  104.34 \nP-value:  0\n```\n\n\n:::\n\n```{.r .cell-code}\nfried(ipi, 12, diff = FALSE, residuals = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTest used:  Friedman rank \n \nTest statistic:  101.32 \nP-value:  1.110223e-16\n```\n\n\n:::\n\n```{.r .cell-code}\nisSeasonal(ipi, freq = 12)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n:::\n\n\n# Abordagens comuns de sazonalidade\n\n## STL\n\nA decomposição STL é mais sofisticada do que a decomposição clássica. A metodologia STL foi apresentada no influente artigo [STL: A Seasonal-Trend Decomposition Procedure Based on Loess](https://www.wessa.net/download/stl.pdf) dos autores Robert Cleveland, William Cleveland, Jean McRae e Irma Terpenning. Assim como a decomposição clássica, a decomposição STL divide uma série em três componentes: um componente de tendência (**trend**), uma componente sazonal (**seasonal**) e um componente aleatório (**remainder**).\n\nO STL foi feito para ser um método versátil, resistente a outliers e eficiente (do ponto de vista computacional). Tipicamente, a decomposição STL funciona com qualquer série (mesmo quando há observações ausentes) independentemente da sua frequência. Para modelar a tendência e sazonalidade da série, o STL usa uma regressão LOESS. Além de ser mais flexível do que a média móvel, que vimos acima, a regressão LOESS não perde observações da série.\n\nO código abaixo mostra como calcular a decomposição STL e apresenta os resultados visualmente usando a série `co2` que vem pré-carregada no R. Esta série é similar a uma das utilizadas no artigo original.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nstl_13 <- stl(co2, s.window = 13)\n\nautoplot(stl_13) + theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-26-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nA função `stl` tem diversos parâmetros de \"suaviazação\", que servem para escolher o tamanho e intensidade dos ciclos de tendência e sazonalidade. Via de regra quanto maiores os valores dos argumentos `x.window` mais suave será o ajuste final. Outro argumento potencialmente útil é definir `robust = TRUE` quando a série possui outliers.\n\nNo presente contexto, o argumento mais relevante do comando `stl` é o `s.window` ou $n_{(s)}$ na nomenclatura do artigo original. Este parâmetro, em linhas gerais, define o grau de suaviazação da tendência sazonal. Ele deve ser um número ímpar e pelo menos igual a 7. O artigo original sugere uma ferramenta visual para escolher o parâmetro, mas concede que a escolha final é arbitrária e depende da sensibilidade do usuário.\n\nO gráfico apresentado é o *seasonal-diagnostic plot*. As linhas mostram a \"intensidade\" do efeito sazonal e os pontos indicam como este efeito sazonal varia com o ruído aleatório. Note como as variações da curva coincidem com as variações dos pontos, sugerindo que as oscilações sazonais estão sendo afetadas pelo ruído da série.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ncomponents <- stl_13$time.series\n\ndat = data.frame(\n  date = as.Date.ts(components),\n  coredata(components)\n)\n\ndat$month = lubridate::month(dat$date, label = TRUE, locale = \"pt_BR\")\ndat$year = lubridate::year(dat$date)\n\ndat <- dat |>\n  mutate(s_avg = mean(seasonal), .by = \"month\") |>\n  mutate(s1 = seasonal - s_avg, s2 = seasonal - s_avg + remainder)\n\nggplot(dat) +\n  geom_line(aes(x = year, y = s1), lwd = 0.8) +\n  geom_point(aes(x = year, y = s2), size = 0.8, shape = 21) +\n  facet_wrap(vars(month)) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-27-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nO gráfico abaixo repete o mesmo exercício mas utilizando `s.window = 35` para suavizar a série original. Note como as curvas estão mais suaves.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nstl_35 <- stl(co2, s.window = 35)\ncomponents <- stl_35$time.series\n\ndat = data.frame(\n  date = as.Date.ts(components),\n  coredata(components)\n)\n\ndat$month = lubridate::month(dat$date, label = TRUE, locale = \"pt_BR\")\ndat$year = lubridate::year(dat$date)\n\ndat <- dat |>\n  mutate(s_avg = mean(seasonal), .by = \"month\") |>\n  mutate(s1 = seasonal - s_avg, s2 = seasonal - s_avg + remainder)\n\nggplot(dat) +\n  geom_line(aes(x = year, y = s1), lwd = 0.8) +\n  geom_point(aes(x = year, y = s2), size = 0.8, shape = 21) +\n  facet_wrap(vars(month)) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-28-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nA função `forecast::mstl` oferece uma opção menos manual do ajuste STL. Esta função executa seis janelas distintas para `s.window` iterativamente. Os resultados costumam ser satisfatórios, mas como de costume, é necessário revisar o ajuste final.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nstl_auto = mstl(co2, lambda = \"auto\")\nautoplot(stl_auto)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-29-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## SARIMA\n\nOs modelos SARIMA incluem um componente de \"sazonalidade estocástica\" nos modelos ARIMA. Já escrevi um [post](https://restateinsight.com/posts/general-posts/repost-sarima-no-r/) onde detalho melhor alguns aspectos teóricos deste tipo de modelo. Vale notar o modelo SARIMA *não realiza uma decomposição de tendência e sazonalidade* com visto acima. Quando se aplica um SARIMA, implicitamente, supõe-se que a série possui uma tendência sazonal estocástica (i.e. raiz unitária sazonal) e não uma tendência sazonal determinística[^5].\n\n[^5]: Para uma boa apresentação sobre raiz unitária e sobre tendências determinísticas veja Enders (2009) Applied Econometric Time Series.\n\nComo último exemplo vamos analisar a demanda mensal por gasolina. A série é da [ANP](https://www.gov.br/anp/pt-br/centrais-de-conteudo/dados-estatisticos) e registra o total de vendas de gasolina C no Brasil em metros cúbicos.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ngasolina = read_csv(\n  \"https://github.com/viniciusoike/restateinsight/raw/refs/heads/main/static/data/br_anp_gasolina.csv\"\n)\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ngas = ts(na.omit(gasolina$demand), start = c(2012, 1), frequency = 12)\nautoplot(gas) + theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-31-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nA série parece exibir algum componente de sazonalidade. Parece haver um pico de consumo todo mês de dezembro e uma queda todo mês de fevereiro.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggseasonplot(gas) +\n  scale_color_viridis_d() +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-32-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nA escolha da ordem do modelo SARIMA exige a inspeção visual do correlograma da série. Para mais detalhes consulte meu [post mais detalhado sobre o assunto](https://restateinsight.com/posts/general-posts/repost-sarima-no-r/). Aqui, por simplicidade, uso um modelo simples, que costuma funcionar bem para série em geral.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsarima_model = Arima(log(gas), order = c(0, 1, 1), seasonal = c(0, 1, 1))\n\nsarima_model\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSeries: log(gas) \nARIMA(0,1,1)(0,1,1)[12] \n\nCoefficients:\n          ma1     sma1\n      -0.2719  -0.7227\ns.e.   0.0973   0.0972\n\nsigma^2 = 0.003158:  log likelihood = 179.5\nAIC=-353.01   AICc=-352.81   BIC=-344.52\n```\n\n\n:::\n:::\n\n\nUm dos pontos fortes dos modelos SARIMA é de gerar boas previsões de curto prazo com grande facilidade. Como comentei anteriormente, não há uma interpretação simples para a sazonalidade neste tipo de abordagem.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nautoplot(forecast(sarima_model), include = 48) +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-34-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\n## X13-ARIMA\n\nO X13-ARIMA ou X13-ARIMA-SEATS é a versão mais recente do X11-ARIMA, uma metodologia desenvolvida pelo [US Census Bureau](https://www.census.gov/data/software/x13as.html) para lidar com a sazonalidade de séries de tempo. Este método foi pensado para lidar com o tipo de sazonalidade comumemente encontrada em séries econômicas. Os métodos de ajuste são implementados no R via o pacote `seasonal`.\n\nA função principal do pacote `seas` realiza um ajuste sazonal automático. Para verificar os principais resultados do ajuste usa-se a função `summary`. O ajuste automático costuma ser bom, mas é sempre necessário revisar o ajuste.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n#> Consumo mensal de energia elétrica - Residencial\nenerg = rbcb::get_series(1403, as = \"ts\", start_date = as.Date(\"2002-01-01\"))\n#> Executa a rotina do X13-ARIMA\nsenerg = seas(energ)\n#> Resumo dos resultados\nsummary(senerg)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nseas(x = energ)\n\nCoefficients:\n                    Estimate Std. Error z value Pr(>|z|)    \nMon               -0.0044594  0.0024144  -1.847   0.0647 .  \nTue               -0.0067071  0.0024161  -2.776   0.0055 ** \nWed                0.0015360  0.0023804   0.645   0.5188    \nThu                0.0060074  0.0023645   2.541   0.0111 *  \nFri                0.0043871  0.0023727   1.849   0.0645 .  \nSat               -0.0008662  0.0023711  -0.365   0.7149    \nEaster[15]        -0.0287199  0.0050182  -5.723 1.05e-08 ***\nLS2002.Apr         0.0752851  0.0172641   4.361 1.30e-05 ***\nAO2014.Feb         0.0810754  0.0164747   4.921 8.60e-07 ***\nLS2015.Mar        -0.0788268  0.0156131  -5.049 4.45e-07 ***\nMA-Nonseasonal-01  0.5532245  0.0501164  11.039  < 2e-16 ***\nMA-Seasonal-12     0.7247917  0.0470988  15.389  < 2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nSEATS adj.  ARIMA: (0 1 1)(0 1 1)  Obs.: 282  Transform: log\nAICc:  3649, BIC:  3695  QS (no seasonality in final):    0  \nBox-Ljung (no autocorr.): 15.76   Shapiro (normality): 0.9952  \n```\n\n\n:::\n:::\n\n\nO gráfico abaixo mostra a série original e a série sazonalmente ajustada em vermelho. Para extrair a série ajustada usa-se a função `final()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nautoplot(energ) +\n  autolayer(final(senerg)) +\n  guides(color = \"none\") +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-36-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nO pacote `seasonal` é muito bem documentado e inclui um artigo [de apresentação](http://www.seasonal.website/seasonal.html) com exemplos, um texto mostrando como [rodar os exemplos oficiais do X13 dentro do R](http://www.seasonal.website/examples.html) e até uma [ferramenta interativa](http://www.seasonal.website). Neste post não vou explorar todas as nuances do pacote.\n\nPara conseguir um ajuste mais adequado é preciso explorar os argumentos adicionais da função `seas` além de adaptar as variáveis de calendário. Na sua configuração padrão, a função `seas` não considera o efeito do carnaval, por exemplo. É possível criar eventos de calendário usando a função `genhol` (de \"**gen**erate **hol**iday\").\n\nUm recurso bastante útil para conseguir as datas das festividades brasileiras é o site do [prof. Roberto Cabral de Mello Borges](https://www.inf.ufrgs.br/~cabral/tabela_pascoa.html). O código abaixo extrai a tabela com as datas da Páscoa, Carnaval e Corpus Christi de 1951-2078.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(rvest)\n\nurl = \"https://www.inf.ufrgs.br/~cabral/tabela_pascoa.html\"\n\ntabela = url |>\n  read_html() |>\n  html_table()\n\ntab = tabela[[1]]\n\nferiados_bra = data.frame(tab[-1, ])\nnames(feriados_bra) = as.character(tab[1, ])\nhead(feriados_bra)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Ano  a b c  d e d+e Dia   Mês      Páscoa    Carnaval Corpus Christi\n1 1951 13 3 5  1 2   3  25 Março 25/mar/1951 06/fev/1951    24/mai/1951\n2 1952 14 0 6 20 2  22  13 Abril 13/abr/1952 26/fev/1952    12/jun/1952\n3 1953 15 1 0  9 5  14   5 Abril 05/abr/1953 17/fev/1953    04/jun/1953\n4 1954 16 2 1 28 6  34  18 Abril 18/abr/1954 02/mar/1954    17/jun/1954\n5 1955 17 3 2 17 2  19  10 Abril 10/abr/1955 22/fev/1955    09/jun/1955\n6 1956 18 0 3  6 4  10   1 Abril 01/abr/1956 14/fev/1956    31/mai/1956\n```\n\n\n:::\n:::\n\n\nPara utilizar este dado no X13-ARIMA é necessário converter a coluna `Carnaval` num tipo Date e então utilizar a função `genhol`. Para facilitar a leitura das datas uso o pacote `readr`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(readr)\n\nferiados_bra$date_carnaval = parse_date(\n  feriados_bra$Carnaval,\n  format = \"%d/%b/%Y\",\n  locale = locale(\"pt\")\n)\n\ncarnaval = genhol(\n  feriados_bra$date_carnaval,\n  start = -3,\n  end = 1,\n  frequency = 12\n)\n```\n:::\n\n\nAs datas de carnaval são inseridas dentro do X13-ARIMA via o argumento `xreg`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsenerg = seas(\n  energ,\n  xreg = carnaval,\n  regression.variables = \"td1coef\",\n  arima.model = c(0, 1, 1, 0, 1, 1)\n)\n\nsummary(senerg)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nseas(x = energ, xreg = carnaval, regression.variables = \"td1coef\", \n    arima.model = c(0, 1, 1, 0, 1, 1))\n\nCoefficients:\n                   Estimate Std. Error z value Pr(>|z|)    \nxreg              -0.026183   0.006325  -4.139 3.48e-05 ***\nEaster[15]        -0.041452   0.006007  -6.900 5.19e-12 ***\nLS2015.Mar        -0.079472   0.016788  -4.734 2.20e-06 ***\nMA-Nonseasonal-01  0.596372   0.046563  12.808  < 2e-16 ***\nMA-Seasonal-12     0.715057   0.044903  15.924  < 2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nSEATS adj.  ARIMA: (0 1 1)(0 1 1)  Obs.: 282  Transform: log\nAICc:  3695, BIC:  3717  QS (no seasonality in final):4.187  \nBox-Ljung (no autocorr.): 114.7 *** Shapiro (normality): 0.9931  \nMessages generated by X-13:\nWarnings:\n- At least one visually significant trading day peak has been\n  found in one or more of the estimated spectra.\n```\n\n\n:::\n:::\n\n\nO gráfico abaixo mostra o resulado do ajuste com as datas de feriado modificadas.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nautoplot(energ) +\n  autolayer(final(senerg)) +\n  guides(color = \"none\") +\n  theme_series\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-40-1.png){fig-align='center' width=90%}\n:::\n:::\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
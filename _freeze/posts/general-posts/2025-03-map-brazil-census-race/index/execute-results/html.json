{
  "hash": "1eb5127a1988229c32b3655a3fedf3bd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"A Distribuição Racial do Brasil\"\ndate: \"2025-03-01\"\ncategories: [\"brasil\", \"brazil\", \"ggplot2\", \"data-visualization\", \"maps\", \"censo\", \"census\"]\ndescription: \"Um mapa coroplético que mostra o grupo racial predominante em cada região do Brasil. A distribuição espacial dos dados revela um interessante padrão norte-sul, onde quase todas as regiões do norte são predominantemente pardas e do sul são predominantemente brancas. Os dados são do mais recente Censo Demográfico.\"\ndraft: true\nformat: html\nexecute: \n  eval: false\n---\n\n\n\n# A Distribuição Racial do Brasil em Regiões\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Setup -------------------------------------------------------------------\n\nlibrary(geobr)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(stringr)\nlibrary(sf)\nlibrary(ggnewscale)\nlibrary(showtext)\n\nimport::from(janitor, clean_names)\nimport::from(readxl, read_excel)\nimport::from(sidrar, get_sidra)\nimport::from(stringi, stri_trans_general)\nimport::from(tidyr, separate_wider_delim)\n\nfont_add_google(\"Lato\", \"Lato\")\nshowtext_auto()\n\n# Data --------------------------------------------------------------------\n\n# Download data from SIDRA (Brazilian Institute of Geography and Statistics database)\n# Table 9605: Population by race/color\nsidra9605 <- get_sidra(9605, variable = 93, geo = \"City\")\n\nurl <- \"https://geoftp.ibge.gov.br/organizacao_do_territorio/divisao_regional/divisao_regional_do_brasil/divisao_regional_do_brasil_em_regioes_geograficas_2017/tabelas/regioes_geograficas_composicao_por_municipios_2017_20180911.xlsx\"\n\nnmfile <- tempfile(fileext = \"xlsx\")\ndownload.file(url, nmfile)\ndim_inter <- readxl::read_excel(nmfile)\n\ndim_inter <- dim_inter |> \n  rename(\n    code_muni = CD_GEOCODI,\n    code_intermediate = cod_rgint,\n    code_immediate = cod_rgi,\n    name_muni = nome_mun,\n    name_intermediate = nome_rgi\n  ) |> \n  mutate(across(starts_with(\"code\"), as.numeric))\n\n# Helper function to standardize text: remove accents and convert to lowercase\nstr_simplify <- function(x) {\n  y <- stringi::stri_trans_general(x, \"latin-ascii\")\n  y <- stringr::str_to_lower(y)\n  return(y)\n}\n\npop <- sidra9605 |> \n  as_tibble() |> \n  janitor::clean_names() |> \n  mutate(\n    code_muni = municipio_codigo,\n    code_region = str_sub(code_muni, 1, 1),\n    code_state = str_sub(code_muni, 1, 2),\n    race = str_simplify(cor_ou_raca),\n    race_label = cor_ou_raca,\n    pop = valor\n  ) |> \n  mutate(across(starts_with(\"code\"), as.numeric))\n\npop <- left_join(\n  pop,\n  select(dim_inter, code_muni, code_intermediate, code_immediate),\n  by = \"code_muni\"\n)\n\npop <- pop |> \n  # Split municipality name and state abbreviation\n  separate_wider_delim(\n    cols = municipio,\n    delim = \" - \",\n    names = c(\"name_muni\", \"abbrev_state\")\n  ) |> \n  # Select and reorder relevant columns\n  select(starts_with(\"code\"), name_muni, abbrev_state, race, race_label, pop) |> \n  # Remove totals and calculate proportions by municipality\n  filter(race != \"total\") |> \n  mutate(prop = pop / sum(pop, na.rm = TRUE), .by = \"code_muni\")\n\n# Define grouping variables for different geographic levels (id variables)\npop_summary <- list(\n  region = c(\"code_region\"),\n  state = c(\"code_state\"),\n  intermediate = c(\"code_intermediate\"),\n  immediate = c(\"code_immediate\"),\n  brasil = c(\"race\")\n)\n\n# Function to create summary tables\nsummarise_tables <- function(x) {\n  pop |> \n    # Sums population by id variables + race\n    summarise(\n      total = sum(pop, na.rm = TRUE),\n      .by = c(all_of(x), \"race\", \"race_label\")\n    ) |> \n    # Computes population shares by id variables\n    mutate(\n      prop = total / sum(total),\n      .by = all_of(x)\n    )\n}\n\n# Create all summary tables at once\ntbls <- lapply(pop_summary, summarise_tables)\n\n# Find the highest share within each intermediate region\n\ntop_inter <- tbls$intermediate |> \n  group_by(code_intermediate) |> \n  slice_max(prop, n = 1) |> \n  ungroup()\n\ngeo_inter_full <- read_intermediate_region(showProgress = FALSE, simplified = FALSE)\ngeo_inter <- read_intermediate_region(showProgress = FALSE)\n\ngeo_inter_full <- left_join(geo_inter_full, top_inter, by = \"code_intermediate\")\ninter <- left_join(geo_inter, top_inter, by = \"code_intermediate\")\n\n# Map ---------------------------------------------------------------------\n\nlegend_breaks <- seq(0.5, 0.8, 0.1)\nlegend_labels <- legend_breaks * 100\nlegend_limits <- c(0.4, 0.85)\n\nbase_map <- ggplot() +\n  geom_sf(\n    data = filter(inter, race != \"branca\"),\n    aes(fill = prop),\n    lwd = 0.1,\n    color = \"white\"\n  ) +\n  scale_fill_distiller(\n    name = \"% Pardos\",\n    palette = \"Purples\",\n    direction = 1,\n    breaks = legend_breaks,\n    labels = legend_labels,\n    limits = legend_limits\n  ) +\n  # Creates a secondary scale using ggnewscale::new_scale_fill\n  new_scale_fill() +\n  geom_sf(\n    data = filter(inter, race == \"branca\"),\n    aes(fill = prop),\n    lwd = 0.1,\n    color = \"white\"\n  ) +\n  scale_fill_distiller(\n    name = \"% Brancos\",\n    palette = \"Greens\",\n    direction = 1,\n    breaks = legend_breaks,\n    labels = legend_labels,\n    limits = legend_limits\n  )\n\n# Find the region with the highest share for each race\nsf_top <- inter |> \n  group_by(race) |> \n  slice_max(prop, n = 1, na_rm = TRUE) |> \n  ungroup()\n\n# Get the position of the centroids (for the arrow)\ncoords_centroid_top <- sf_top |> \n  st_centroid() |> \n  st_coordinates()\n\n# Auxiliar data.frame to position the text labels\ndf_annotation <- tibble(\n  x = c(-40, -65, -43, -44),\n  y = c(-27, -18, -32, 2),\n  label = c(\n    \"Regiões em verde\\nindicam que\\nbrancos são maioria\",\n    \"Regiões em roxo\\nindicam que\\npardos são maioria\",\n    \"Santa Cruz é a RI\\ncom maior percentual\\nde brancos (82%)\",\n    \"Parintins é a RI\\ncom maior percentual\\nde pardos (80%)\"\n  )\n)\n\n# Add text labels to plot\nmap_annotations <- base_map +\n  geom_label(\n    data = df_annotation,\n    aes(x = x, y = y, label = label),\n    family = \"Lato\",\n    size = c(4, 4, 3, 3),\n    fill = \"white\",      # background color\n    alpha = 0.8,         # transparency\n    label.padding = unit(0.2, \"lines\"),  # padding around text\n    label.size = 0.1     # border thickness\n  ) +\n  # Top %share -- Santa Cruz - Lajeado  | Parintins-- dark border \n  geom_sf(\n    data = filter(inter, code_intermediate %in% c(1304, 4308)),\n    fill = NA,\n    color = \"black\",\n    lwd = 0.15\n  ) +\n  # arrow/curve segment: Santa Cruz - Lajeado\n  geom_curve(\n    data = data.frame(x = coords_centroid_top[1, 1], y = coords_centroid_top[1, 2]),\n    aes(x = x, y = y + 0.25, xend = x + 5, yend = y - 2.25),\n    linewidth = 0.3,\n    angle = 45,\n    alpha = 0.8,\n    arrow = arrow(length = unit(2.5, \"pt\"))\n  ) +\n  # arrow/curve segment: Parintins\n  geom_curve(\n    data = data.frame(x = coords_centroid_top[2, 1], y = coords_centroid_top[2, 2]),\n    aes(x = x, y = y, xend = x + 10, yend = y + 5),\n    linewidth = 0.3,\n    angle = 45,\n    curvature = -0.1,\n    alpha = 0.8,\n    arrow = arrow(length = unit(2.5, \"pt\"))\n  ) +\n  # Remove excess white space from map\n  coord_sf(xlim = c(-72.2, -35.5))\n\n# Add title and thematic elements\nfinal_map <- map_annotations +\n  labs(\n    title = \"A Divisão Racial do Brasil\",\n    subtitle = \"Percentual do grupo racial majoritário por Região Intermediária* (RI). Em todos as RIs, ou brancos ou pardos são a maioria.\\nOs dados são do Censo Demográfico de 2022 do IBGE e mostram um padrão norte-sul no país.\\nExceções ao padrão incluem a região do Rio de Janeiro, no sudeste, e de Caicó, no nordeste.\",\n    caption = \"Fonte: IBGE (Censo Demográfico 2022). @viniciusoike\\n(*) Regiões intermediárias agrupam municípios que compartilham relações econômicas e sociais em torno de um mesmo centro urbano principal.\") +\n  ggthemes::theme_map(base_family = \"Lato\") +\n  theme(\n    plot.title = element_text(\n      hjust = 0,\n      size = 22\n    ),\n    plot.subtitle = element_text(\n      hjust = 0,\n      size = 10\n    ),\n    plot.caption = element_text(hjust = 0),\n    legend.position =  \"inside\",\n    legend.position.inside = c(0.01, 0.01),\n    legend.box = \"horizontal\",\n    legend.key.size = unit(1, \"cm\"),\n    legend.text = element_text(size = 10),\n    legend.title = element_text(size = 12),\n    plot.background = element_rect(fill = \"#F6EEE3\", color = \"#F6EEE3\"),\n    legend.background = element_rect(fill = \"#F6EEE3\", color = \"#F6EEE3\")\n  )\n\nggsave(\n  here::here(\"static/images/censo_mapa_raca.svg\"),\n  final_map,\n  width = 8,\n  height = 9\n)\n```\n:::\n\n\n\n-   O mapa abaixo mostra o grupo racial predominante em cada região do Brasil. A divisão escolhida tem o objetivo de facilitar a leitura dos dados. No agregado, 45,3% da população do Brasil é parda, 43,5% é branca, 10,2% é preta, 0,6% é indígena e 0,4% é amarela.\n\n-   Tecnicamente, uma região intermediária é uma agregação de regiões imediatas, que são uma divisão territorial do Brasil que agrupa municípios com base em centros urbanos. Na prática, uma região intermediária é como uma região metropolitana.\n\n![](/static/images/censo_mapa_raca.svg){fig-align=\"center\"}\n\n-   Dados: IBGE, Censo (2022)\n\n-   Tipografia: Lato\n\n-   Paleta: `Greens` e `Purple` (MetBrewer)\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
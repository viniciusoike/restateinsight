{
  "hash": "c4b54c25fd66ea7f57d904fa8e796ee7",
  "result": {
    "markdown": "---\ntitle: \"Locating all The Coffee shops in Brazil\"\ndate: \"2024-06-28\"\ndescription: \"In this post, I show how to map every The Coffee shop in Brazil using web scraping and geocoding. I also show how to combine this information with Goolge Maps ratings and Census demographic data to produce valuable insights.\"\ncategories: ['data-science', 'web-scrapping', 'finding-all', 'tutorial-r', 'brasil']\nexecute: \n  eval: false\n  message: false\n  warning: false\n---\n\n\n# Finding all The Coffee shops in Brazil\n\nIn this post, I'll show you how to map every The Coffee shop in Brazil in less time than it takes to brew a pot of coffee. All this from your laptop and without spending a dime.\n\nWe'll use only `R` and a few packages to webscrape all addresses.\n\n### What is The Coffee\n\nThe Coffee is a Japanese-inspired chain of coffee shops with a distinct minimalist visual identity. Their street shops are small, clean, and extremely space-efficient, sometimes taking less than 20 m2. Most shops are for takeout only, with limited seating. They offer a wide variety of high quality coffee at a premium price point.\n\nThe company was founded in Curitiba, at the southern part of Brazil, in 2018, and has expanded rapidly to 12 countries with over 200 shops. Their franchise model in part explains this strong expansion.\n\n<div>\n\nSimilar to Starbucks, product customization is a major selling point. Customers can choose and replace pretty much everything in their drinks, from adding and additional espresso shot, requiring an additional pump of chocolate syrup. Unlike Starbucks, however, most The Coffee shops are strictly to-go, or offer only minimal seating capacity. The Coffee (usually) doesn't aim at becoming a 3rd place, where friends meet to share a cup of coffee, or work colleagues schedule a meeting. That said, there are exceptions and some shops do include tables and even\n\nThe Coffee also strays away from the traditional friendly-neighborhood barista and instead focuses on a more technological approach. Customers mainly interact with a tablet that displays the menu and all customization choices. Friendly chatter is optional, as a customer can get in, get his coffee without exchanging any words with the barista.\n\n</div>\n\n# Webscraping\n\nWe'll leverage the power of R, an open-source programming language that's widely used in data science. Using R offers numerous advantages: it’s free, the code can be reused and adapted to various contexts, and its strong emphasis on reproducibility ensures that your analyses can be replicated by others.\n\n## Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(leaflet)\nlibrary(stringr)\nlibrary(rvest)\nlibrary(sf)\n\nimport::from(tidygeocoder, geocode)\nimport::from(purrr, map, map2)\nimport::from(tidyr, unnest)\n```\n:::\n\n\n## Finding the data\n\nThe data is extracted from [The Coffee's website](https://thecoffee.jp). There is no single recipe or approach for webscraping: each website is organized differently, though there are patterns. In the case of The Coffee, units are separated by country and city; additionally each unit is identified by a name and has an address\n\n### The website\n\nThe site presents every unit by country and city. The print below shows an example unit in Belo Horizonte, Brazil.\n\n![](/static/images/coffeeshops/tcf_site.png){fig-align=\"center\"}\n\n![](/static/images/coffeeshops/tcf_inspect.png){fig-align=\"center\"}\n\n### Using R\n\nThe code below extracts the `url` related to every individual city in Brazil.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Base url \nbase_url <- \"https://thecoffee.jp/shortcut/brasil\"\n# Parse HTML\npage_list_brazil <- xml2::read_html(base_url)\n\n# Gets the urls for all cities in Brazil\n\npage_list_cities <- page_list_brazil |> \n  html_elements(xpath = \"//div/ul/li/a\") |> \n  html_attr(\"href\")\n\npage_list_cities <- page_list_cities[str_detect(page_list_cities, \"brasil/\")]\n\nurl_cities <- str_c(base_url, str_remove(page_list_cities, \"shortcut/brasil/\"))\n```\n:::\n\n\nThe code below is a function the scrapes the information of all shops for a given `url` of a city. The output is a simple `data.frame`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nscrape_the_coffee <- function(url) {\n  \n  # Parse the html\n  page <- xml2::read_html(url)\n  # Find the the name of the shop\n  coffee_shop_name <- page |> \n    rvest::html_elements(xpath = \"//div/ul/li/div/div/a/h4\") |> \n    rvest::html_text()\n  # Find the address of the shop\n  address_list <- page |> \n    rvest::html_elements(xpath = \"//div/ul/li/div/div/a/p\") |> \n    rvest::html_text()\n  # Remove shops that are not open yet\n  address_list <- address_list[!str_detect(address_list, \"coming soon\")]\n  street_name <- address_list[seq(1, length(address_list), 2)]\n  city_name <- address_list[2]\n  \n  full_address <- paste(street_name, city_name)\n\n  # Store results in a tibble\n  out <- tibble::tibble(\n    name = coffee_shop_name,\n    address = full_address,\n    street_name = street_name,\n    city_name = city_name\n  )\n  \n  return(out)\n\n}\n```\n:::\n\n\n### Functional approach\n\nThe simplest approach to implement this function is applying it over a vector with all `urls` for all cities. This means that the `scrape_the_coffee` function will be executed on each individual value of the `url_cities` text vector.\n\nThis approach is usually quicker and can be scaled with parallel processing (e.g. `parallel::mclapply`). Speed, however, usually isn't a top priority with web scraping and can even be a detriment as it might lead to an excess number of requests.\n\nIt's important to note that web scraping is liable to errors due to internet connection issues. As such it's good practice to implement it in a error-prone fashion. The easiest way to do so in the functional approach is to wrap the function with `purrr::safely`. This way, errors don't stop the function and are stored in a specific error class, making it easier to debug it afterwards.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Scrape all cities\n\n# Apply the scrape_the_coffee function over url_cities\nsafe_scrape_the_coffee <- safely(scrape_the_coffee)\ncoffee_locations <- map(url_cities, safe_scrape_the_coffee)\n# Name the list for convinience\nnames(coffee_locations) <- url_cities\n# Stack the results of the list into a single table\ndat <- bind_rows(coffee_locations, .id = \"url\")\n```\n:::\n\n\n### Loop approach\n\nThe code below shows how to implement the same procedure using a typical `for-loop` syntax. This approach is usually more intuitive and easier to follow. It's generally better to use this approach in more complex web scrapping endeavors.\n\nFor illustration purposes, I show how to add a progress bar to the loop and a timeout.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define a progress bar\npb <- txtProgressBar(min = 1, max = length(url_cities), style = 3)\nls <- vector(\"list\", length(url_cities))\n\nfor (i in seq_along(url_cities)) {\n  \n  # Get the current city\n  url <- url_cities[i]\n  current_city <- basename(url)\n  message(\"Scraping data for: \", current_city)\n  # Safely apply the scrape_the_coffee function\n  ls[[i]] <- try(scrape_the_coffee(url))\n  # Update progress bar\n  setTxtProgressBar(pb, i)\n  # Small timeout to avoid problems\n  Sys.sleep(runif(1, min = 1, max = 5))\n  \n}\n```\n:::\n\n\n### Cleaning the data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nunnabreviate <- function() {\n  c(\"Av\\\\.\" = \"Avenida\",\n    \"Al\\\\.\" = \"Alameda\",\n    \"R\\\\.\"  = \"Rua\",\n    \"Dr\\\\.\" = \"Doutor\",\n    \"Visc\\\\.\" = \"Visconde\",\n    \"Pres\\\\.\" = \"Presidente\",\n    \"Mal\\\\.\" = \"Marechal\")\n}\n\ndat <- dat |> \n  mutate(\n    city_name = str_remove(city_name, \" - Brasil\"),\n    address = str_replace_all(address, unnabreviate()),\n    country = \"Brasil\"\n    )\n```\n:::\n\n\n### Geocoding\n\nGeocoding is the process of finding a street address based on a latitude/longitude pair or vice-versa. Typically, we need to call an external provider for this. In this case, I use the Google Maps API via the `tidygeocoder` package to find the corresponding lat/lng pair for each address.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Geocode using Maps API\ncoffee <- tidygeocoder::geocode(\n  dat,\n  address = address,\n  method = \"google\"\n  )\n\n# Convert to spatial data.frame\nshops <- st_as_sf(\n  coffee,\n  coords = c(\"long\", \"lat\"),\n  crs = 4326,\n  remove = FALSE\n  )\n```\n:::\n\n\n## Results\n\nThe table below shows the final results of the web scraping and geocoding process.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div id=\"dstgcfsayx\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>@import url(\"https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap\");\n#dstgcfsayx table {\n  font-family: 'Open Sans', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#dstgcfsayx thead, #dstgcfsayx tbody, #dstgcfsayx tfoot, #dstgcfsayx tr, #dstgcfsayx td, #dstgcfsayx th {\n  border-style: none;\n}\n\n#dstgcfsayx p {\n  margin: 0;\n  padding: 0;\n}\n\n#dstgcfsayx .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #5F5F5F;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #5F5F5F;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#dstgcfsayx .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#dstgcfsayx .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#dstgcfsayx .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#dstgcfsayx .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#dstgcfsayx .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #5F5F5F;\n}\n\n#dstgcfsayx .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #5F5F5F;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #5F5F5F;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#dstgcfsayx .gt_col_heading {\n  color: #FFFFFF;\n  background-color: #0076BA;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#dstgcfsayx .gt_column_spanner_outer {\n  color: #FFFFFF;\n  background-color: #0076BA;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#dstgcfsayx .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#dstgcfsayx .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#dstgcfsayx .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #5F5F5F;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#dstgcfsayx .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#dstgcfsayx .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #5F5F5F;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #5F5F5F;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#dstgcfsayx .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #5F5F5F;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #5F5F5F;\n  vertical-align: middle;\n}\n\n#dstgcfsayx .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#dstgcfsayx .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#dstgcfsayx .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: none;\n  border-top-width: 1px;\n  border-top-color: #D5D5D5;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D5D5D5;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D5D5D5;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#dstgcfsayx .gt_stub {\n  color: #333333;\n  background-color: #89D3FE;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D5D5D5;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dstgcfsayx .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#dstgcfsayx .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#dstgcfsayx .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#dstgcfsayx .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dstgcfsayx .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #5F5F5F;\n}\n\n#dstgcfsayx .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#dstgcfsayx .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #5F5F5F;\n}\n\n#dstgcfsayx .gt_grand_summary_row {\n  color: #333333;\n  background-color: #D5D5D5;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dstgcfsayx .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #5F5F5F;\n}\n\n#dstgcfsayx .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #5F5F5F;\n}\n\n#dstgcfsayx .gt_striped {\n  background-color: #EDF7FC;\n}\n\n#dstgcfsayx .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #5F5F5F;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #5F5F5F;\n}\n\n#dstgcfsayx .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#dstgcfsayx .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dstgcfsayx .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#dstgcfsayx .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#dstgcfsayx .gt_left {\n  text-align: left;\n}\n\n#dstgcfsayx .gt_center {\n  text-align: center;\n}\n\n#dstgcfsayx .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#dstgcfsayx .gt_font_normal {\n  font-weight: normal;\n}\n\n#dstgcfsayx .gt_font_bold {\n  font-weight: bold;\n}\n\n#dstgcfsayx .gt_font_italic {\n  font-style: italic;\n}\n\n#dstgcfsayx .gt_super {\n  font-size: 65%;\n}\n\n#dstgcfsayx .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#dstgcfsayx .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#dstgcfsayx .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#dstgcfsayx .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#dstgcfsayx .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#dstgcfsayx .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#dstgcfsayx .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <caption>The Coffee shops, major cities</caption>\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"City\">City</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"# Shops\"># Shops</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Share BR (%)\">Share BR (%)</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"city_name\" class=\"gt_row gt_left\">São Paulo</td>\n<td headers=\"n\" class=\"gt_row gt_right\">53</td>\n<td headers=\"share_brasil\" class=\"gt_row gt_right\">26.50%</td></tr>\n    <tr><td headers=\"city_name\" class=\"gt_row gt_left gt_striped\">Curitiba</td>\n<td headers=\"n\" class=\"gt_row gt_right gt_striped\">29</td>\n<td headers=\"share_brasil\" class=\"gt_row gt_right gt_striped\">14.50%</td></tr>\n    <tr><td headers=\"city_name\" class=\"gt_row gt_left\">Brasília</td>\n<td headers=\"n\" class=\"gt_row gt_right\">21</td>\n<td headers=\"share_brasil\" class=\"gt_row gt_right\">10.50%</td></tr>\n    <tr><td headers=\"city_name\" class=\"gt_row gt_left gt_striped\">Rio de Janeiro</td>\n<td headers=\"n\" class=\"gt_row gt_right gt_striped\">13</td>\n<td headers=\"share_brasil\" class=\"gt_row gt_right gt_striped\">6.50%</td></tr>\n    <tr><td headers=\"city_name\" class=\"gt_row gt_left\">Fortaleza</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"share_brasil\" class=\"gt_row gt_right\">5.00%</td></tr>\n    <tr><td headers=\"city_name\" class=\"gt_row gt_left gt_striped\">Porto Alegre</td>\n<td headers=\"n\" class=\"gt_row gt_right gt_striped\">9</td>\n<td headers=\"share_brasil\" class=\"gt_row gt_right gt_striped\">4.50%</td></tr>\n    <tr><td headers=\"city_name\" class=\"gt_row gt_left\">Florianópolis</td>\n<td headers=\"n\" class=\"gt_row gt_right\">6</td>\n<td headers=\"share_brasil\" class=\"gt_row gt_right\">3.00%</td></tr>\n    <tr><td headers=\"city_name\" class=\"gt_row gt_left gt_striped\">Vitória</td>\n<td headers=\"n\" class=\"gt_row gt_right gt_striped\">5</td>\n<td headers=\"share_brasil\" class=\"gt_row gt_right gt_striped\">2.50%</td></tr>\n    <tr><td headers=\"city_name\" class=\"gt_row gt_left\">Campinas</td>\n<td headers=\"n\" class=\"gt_row gt_right\">4</td>\n<td headers=\"share_brasil\" class=\"gt_row gt_right\">2.00%</td></tr>\n    <tr><td headers=\"city_name\" class=\"gt_row gt_left gt_striped\">Belo Horizonte</td>\n<td headers=\"n\" class=\"gt_row gt_right gt_striped\">3</td>\n<td headers=\"share_brasil\" class=\"gt_row gt_right gt_striped\">1.50%</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nleaflet(shops) %>%\n  addTiles() %>%\n  addMarkers(label = ~name) %>%\n  addProviderTiles(\"CartoDB\") %>%\n  setView(lng = -46.65590, lat = -23.561197, zoom = 12)\n```\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-403d997187cd0360fbaa\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-403d997187cd0360fbaa\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addMarkers\",\"args\":[[-23.1244231,-26.9929179,-19.9361078,-19.9322668,-19.926884,-1.4574412,-1.4600842,-26.9213039,-15.7599133,-15.8362013,-15.8013678,-15.8277639,-15.7980407,-15.7398321,-15.8082697,-15.7730073,-15.7376916,-15.8369749,-15.8528298,-15.7497599,-15.8277639,-15.8073875,-15.8345749,-15.7376906,-15.8271753,-15.761358,-15.8005995,-15.7081709,-15.7429483,-22.8261187,-22.8475042,-23.009917,-22.9266965,-20.456356,-25.443726,-22.7176908,-29.9157517,-24.952304,-27.0701527,-21.2881702,-15.5901447,-25.4325733,-25.4348424,-25.4295068,-25.4257771,-25.412983,-25.4181542,-25.4357505,-25.4179311,-25.4358787,-25.4384534,-25.4129592,-25.4483536,-25.4305676,-25.4430439,-25.4303474,-25.4501054,-25.431107,-25.4452162,-25.4049823,-25.4321145,-25.4333644,-25.4176941,-25.4289674,-25.4431419,-25.4376472,-25.428732,-25.4339534,-25.4173969,-25.4090219,-27.5879733,-27.5879028,-27.5955852,-27.5931141,-27.4400051,-27.535128,-3.7349146,-3.7259974,-3.7361057,-3.7423881,-3.74169,-3.7881216,-3.7350579,-3.794939,-3.74646,-3.79578,-25.5475337,-16.6966204,-16.7079067,-26.2999118,-26.3033117,-7.1046039,-7.0810559,-7.225745,-21.7763534,-23.3302039,-23.3124841,-3.0941363,-3.0847158,-23.4185038,-23.4450541,-19.986742,-29.664618,-22.5123927,-25.0963718,-30.0291783,-30.0251399,-30.0253178,-30.0352498,-30.0846697,-30.0793103,-30.0293999,-30.0097908,-30.0469939,-21.7875606,-8.0369869,-8.0593925,-22.9845782,-22.955028,-22.9146132,-22.9118482,-22.9363519,-23.0067693,-22.9068334,-22.945887,-22.9855788,-22.9671506,-22.9825392,-23.0063374,-22.9626401,-12.9905434,-12.9941089,-13.010531,-29.686466,-23.6542273,-23.96697,-23.4739131,-23.6613139,-23.2042188,-23.5653724,-23.5618254,-23.6113214,-23.5764314,-23.609117,-23.5840787,-23.5565342,-23.6322618,-23.5875637,-23.5909564,-23.5454914,-23.5436571,-23.5505821,-23.6246829,-23.5673971,-23.5500944,-23.6051676,-23.5664967,-23.5572153,-23.5887031,-23.5952979,-23.622517,-23.5834336,-23.6231169,-23.5534632,-23.5698825,-23.5558562,-23.5359197,-23.6092136,-23.5980407,-23.535303,-23.5737875,-23.5852173,-23.5987246,-23.592759,-23.5414134,-23.5955387,-23.609839,-23.6298795,-23.6245782,-23.5933406,-23.524835,-23.5980159,-23.550539,-23.4989957,-23.5410242,-23.6038964,-23.5567225,-23.5448569,-23.6113354,-23.5799289,-23.5514298,-23.5470416,-5.0684632,-20.3356073,-20.3467973,-20.3000807,-20.3129165,-20.2587914,-20.2882919,-20.3113221],[-46.5575138,-48.6299565,-43.9338522,-43.9365114,-43.9488882,-48.5014736,-48.4885369,-49.0644263,-47.8805612,-48.0182719,-47.9253869,-47.9249014,-47.9200341,-47.8935382,-47.9063324,-47.8761631,-47.8966382,-48.032842,-47.8967714,-47.8400376,-47.9249014,-47.8976061,-48.0368701,-47.8966351,-47.9101552,-47.8973608,-47.8832681,-47.9148844,-47.9129177,-47.0723596,-47.0637067,-47.1411397,-47.0428133,-54.5948531,-49.5680509,-45.5653914,-51.1648462,-53.4584378,-52.6263143,-47.7460796,-56.1206767,-49.2811883,-49.277973,-49.2656496,-49.262779,-49.258002,-49.26875,-49.2871146,-49.2634846,-49.3265474,-49.2789454,-49.265482,-49.2852373,-49.2920062,-49.2908478,-49.324071,-49.2882425,-49.2488726,-49.2872565,-49.2509249,-49.2734886,-49.3007874,-49.2464684,-49.2938673,-49.2855899,-49.2827132,-49.2146097,-49.2893225,-49.2793103,-49.265494,-48.5428953,-48.5536938,-48.5500678,-48.5579083,-48.487742,-48.5095609,-38.4972288,-38.4975597,-38.4902251,-38.4867361,-38.47303,-38.4799297,-38.5660305,-38.4805629,-38.489269,-38.5002437,-54.5848937,-49.2803448,-49.272303,-48.8504405,-48.8495321,-34.8296745,-34.8390407,-39.3238646,-43.3478257,-51.1741306,-51.166836,-60.0226946,-60.0723846,-51.9334246,-51.9157547,-43.9480412,-51.1426243,-43.1774784,-50.159082,-51.2087924,-51.2020313,-51.1624681,-51.2109251,-51.2458384,-51.2473909,-51.2010689,-51.1880242,-51.2299552,-46.5650715,-34.9126229,-34.8704729,-43.2027296,-43.194872,-43.1664982,-43.2251114,-43.1898778,-43.3118233,-43.1772234,-43.182761,-43.2263112,-43.188284,-43.2155281,-43.310715,-43.2162787,-38.4569177,-38.45966,-38.511885,-53.8119896,-46.5357292,-46.3333603,-47.4295781,-46.5706508,-45.9091453,-46.6828327,-46.6707734,-46.6638544,-46.6870898,-46.694481,-46.6796213,-46.6869589,-46.7071436,-46.6725787,-46.6899811,-46.6491764,-46.6452916,-46.5650496,-46.6835302,-46.6497431,-46.6602269,-46.6701744,-46.6541557,-46.6349608,-46.6398553,-46.6866818,-46.6716239,-46.6379731,-46.6986074,-46.6616706,-46.6917274,-46.6752826,-46.6701257,-46.6976599,-46.6975513,-46.6747025,-46.6551705,-46.6817189,-46.6765001,-46.6826255,-46.6822878,-46.6802518,-46.667781,-46.7108395,-46.7037397,-46.6751444,-46.6993338,-46.6840122,-46.678806,-46.6255918,-46.7340229,-46.6423475,-46.6639597,-46.6610047,-46.698026,-46.6750197,-46.6557867,-46.6643149,-42.7925697,-40.2835896,-40.2858423,-40.2977608,-40.2879598,-40.2682685,-40.2911988,-40.291224],null,null,null,{\"interactive\":true,\"draggable\":false,\"keyboard\":true,\"title\":\"\",\"alt\":\"\",\"zIndexOffset\":0,\"opacity\":1,\"riseOnHover\":false,\"riseOffset\":250},null,null,null,null,[\"The Coffee Jardim Atibaia\",\"The Coffee Av. Brasil 2241\",\"The Coffee Rua Inconfidentes\",\"The Coffee Praça da Liberdade\",\"The Coffee Lourdes\",\"The Coffee Cidade Velha\",\"The Coffee Batista Campos\",\"The Coffee Curt Hering\",\"The Coffee Asa Norte\",\"The Coffee Águas Claras\",\"The Coffee Sudoeste 103\",\"The Coffee Asa Sul\",\"The Coffee Sudoeste 101\",\"The Coffee CLN 116\",\"The Coffee Edifício Sabin\",\"The Coffee CLN 405\",\"The Coffee 305 Norte\",\"The Coffee Cosmopolitan\",\"The Coffee Gilberto Salomão\",\"The Coffee Lago Sul\",\"The Coffee 108 Sul\",\"The Coffee 414 Sul\",\"The Coffee Parque Águas Claras\",\"The Coffee CLN 114\",\"The Coffee 212 Sul\",\"The Coffee CEUB\",\"The Coffee Carlton Tower\",\"The Coffee 402 Sul\",\"The Coffee Noroeste\",\"The Coffee Barão Geraldo\",\"The Coffee Shopping Dom Pedro\",\"The Coffee Aeroporto Viracopos\",\"The Coffee São Leopoldo Mandic\",\"The Coffee Atrium\",\"The Coffee City Center Outlet\",\"The Coffee Parque Capivari\",\"The Coffee Park Shopping Canoas\",\"The Coffee Cascavel\",\"The Coffee Pátio Shopping Chapecó\",\"The Coffee Santa Maria Outlet\",\"The Coffee Shopping Estação Cuiabá\",\"The Coffee Prudente\",\"The Coffee Comendador\",\"The Coffee Marechal Deodoro\",\"The Coffee Reitoria\",\"The Coffee Moyses Marcondes\",\"The Coffee Cândido de Abreu\",\"The Coffee Praça Espanha\",\"The Coffee João Gualberto\",\"The Coffee Park Shop. Barigui\",\"The Coffee Batel\",\"The Coffee Min. Público - Mon\",\"The Coffee Av. Iguaçu\",\"The Coffee Champagnat Olist\",\"The Coffee Pátio Batel\",\"The Coffee Euro Import\",\"The Coffee República Argentina 414\",\"The Coffee Senador Souza Naves\",\"The Coffee Praça do Japão\",\"The Coffee Av. Paraná\",\"The Coffee Palácio Avenida\",\"The Coffee Padre Anchieta\",\"The Coffee Augusto Stresser\",\"The Coffee Mall Ucrânia\",\"The Coffee DOC Castelo\",\"The Coffee Nex Casa de Pedra\",\"The Coffee Jockey Plaza\",\"The Coffee Augusto Stellfeld\",\"The Coffee Pilar Centro Médico\",\"The Coffee Jardim\",\"The Coffee Pátio Milano\",\"The Coffee Esteves Júnior\",\"The Coffee Vidal Ramos\",\"The Coffee Top Market\",\"The Coffee Jurerê\",\"The Coffee Square SC (Pop-up)\",\"The Coffee Aldeota\",\"The Coffee Beira Mar\",\"The Coffee Pátio Dom Luis\",\"The Coffee Cocó\",\"The Coffee Shopping Riomar\",\"The Coffee Village WSTC\",\"The Coffee Shopping Riomar Kennedy\",\"The Coffee Washington Soares\",\"The Coffee Verd Mall\",\"The Coffee Glória Mall\",\"The Coffee Almirante Barroso\",\"The Coffee Vaca Brava\",\"The Coffee Goiânia Shopping\",\"The Coffee Rua Blumenau\",\"The Coffee Mueller Joinville\",\"The Coffee Manaíra\",\"The Coffee Parahyba Mall\",\"The Coffee Juazeiro do Norte\",\"The Coffee Juiz de Fora\",\"The Coffee Alameda Jardino\",\"The Coffee Rua Belo Horizonte\",\"The Coffee Amazonas Shopping\",\"The Coffee Shopping Ponta Negra\",\"The Coffee Avenida Raccanello\",\"The Coffee Jardim Aclimação\",\"The Coffee Edifício Concordia\",\"The Coffee I Fashion Outlet Novo Hamburgo\",\"The Coffee Pátio Petrópolis\",\"The Coffee Ponta Grossa\",\"The Coffee Av. Independência\",\"The Coffee 24 de Outubro\",\"The Coffee Iguatemi Porto Alegre\",\"The Coffee Bom Fim\",\"The Coffee Shopping Barra Sul\",\"The Coffee Pontal Shopping\",\"The Coffee Av. Goethe\",\"The Coffee Sogipa (exclusivo para sócios do clube)\",\"The Coffee Trend Orla\",\"The Coffee Poços de Caldas\",\"The Coffee Plaza Shopping\",\"The Coffee Moinho Recife\",\"The Coffee Ipanema\",\"The Coffee Botafogo\",\"The Coffee Aeroporto SDU - Bossa Nova Mall\",\"The Coffee Shopping Tijuca\",\"The Coffee Laranjeiras\",\"The Coffee Metrô Jardim Oceânico Saída Praia\",\"The Coffee Rio Branco\",\"The Coffee Praia de Botafogo\",\"The Coffee Leblon\",\"The Coffee Copacabana\",\"The Coffee Shopping Leblon\",\"The Coffee Metrô Jardim Oceânico Saída Lagoa\",\"The Coffee Jardim Botânico\",\"The Coffee Pituba\",\"The Coffee Praça Ana Lúcia\",\"The Coffee Ondina\",\"The Coffee Santa Maria\",\"The Coffee Rua das Bandeiras\",\"The Coffee Praça Independência\",\"The Coffee Toyota Sorocaba\",\"The Coffee Rudge Ramos\",\"The Coffee Colinas Shopping\",\"The Coffee Pinheiros\",\"The Coffee Oscar Freire\",\"The Coffee Moema\",\"The Coffee Faria Lima\",\"The Coffee Berrini\",\"The Coffee Tabapuã\",\"The Coffee Vila Madalena\",\"The Coffee Verbo Divino\",\"The Coffee Itaim II\",\"The Coffee Jk Iguatemi\",\"The Coffee Higienópolis\",\"The Coffee República\",\"The Coffee Tatuapé\",\"The Coffee Brooklin\",\"The Coffee Av. Paulista\",\"The Coffee Angélica\",\"The Coffee Moema Pássaros\",\"The Coffee Alameda Jaú\",\"The Coffee Japão Liberdade\",\"The Coffee Vila Mariana\",\"The Coffee Shopping Vila Olímpia\",\"The Coffee Campo Belo\",\"The Coffee Ana Rosa\",\"The Coffee Shopping Morumbi\",\"The Coffee Angélica II\",\"The Coffee Faria Lima II\",\"The Coffee Teodoro Sampaio\",\"The Coffee Perdizes\",\"The Coffee WTCSP\",\"The Coffee Shopping Cidade Jardim\",\"The Coffee Rua Campevas\",\"The Coffee Av. Brigadeiro Luís Antônio\",\"The Coffee Itaim\",\"The Coffee Insper\",\"The Coffee Vila Olímpia\",\"The Coffee Alfonso Bovero\",\"The Coffee Housi Faria Lima\",\"The Coffee Shopping Ibirapuera\",\"The Coffee Paseo Alto das Nações\",\"The Coffee Parque da Cidade\",\"The Coffee Vila Nova Conceição\",\"The Coffee Vila Romana\",\"The Coffee Julio Diniz\",\"The Coffee Sumaré\",\"The Coffee Santana\",\"The Coffee Spark\",\"The Coffee Luis Góis\",\"The Coffee Cerqueira Cesar\",\"The Coffee Vilaboim\",\"The Coffee CENU\",\"The Coffee Itacema\",\"The Coffee Passeio Paulista\",\"The Coffee Pacaembu\",\"The Coffee Nossa Senhora de Fátima\",\"The Coffee Praia da Costa\",\"The Coffee Itapuã\",\"The Coffee Praia do Canto\",\"The Coffee Shopping Vitória\",\"The Coffee Jardim Camburi\",\"The Coffee Jardim Food Park\",\"The Coffee Enseada\"],{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]},{\"method\":\"addProviderTiles\",\"args\":[\"CartoDB\",null,null,{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false}]}],\"limits\":{\"lat\":[-30.0846697,-1.4574412],\"lng\":[-60.0723846,-34.8296745]},\"setView\":[[-23.561197,-46.6559],12,[]]},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n# Get Google Maps ratings\n\n[Starbucks post](https://restateinsight.com/posts/general-posts/2024-07-finding-starbucks/#google-places)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncur_shops <- filter(shops, city_name == \"Curitiba\")\n\nget_ratings <- function(lat, lng) {\n  \n  location <- c(lat, lng)\n  places <- google_places(\"The Coffee\", location = location, radius = 10)\n  res <- places$results\n  \n  subres <- res %>%\n    unnest(cols = \"geometry\") %>%\n    unnest(cols = \"location\") %>%\n    select(\n      business_status, name, formatted_address, rating, user_ratings_total,\n      lat, lng\n    )\n  \n}\n\nratings <- map2(cur_shops$lat, cur_shops$long, get_ratings)\n\ndat_ratings <- ratings |> \n  bind_rows() |> \n  distinct() |> \n  filter(str_detect(name, \"^The Coffee\"))\n\ndat_ratings <- dat_ratings |> \n  mutate(\n    street_name = str_extract(formatted_address, \"^[^,]+\"),\n    street_name = str_replace_all(street_name, unnabreviate()),\n    street_name = stringi::stri_trans_general(street_name, \"latin-ascii\"),\n    street_number = as.numeric(str_extract(formatted_address, \"(?<=, )\\\\d+(?=\\\\b)\"))\n  )\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-6878cdd5e2378cfbdfcb\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-6878cdd5e2378cfbdfcb\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addCircleMarkers\",\"args\":[[-25.4325732,-25.4348424,-25.4430439,-25.4376472,-25.4384237,-25.4339534,-25.4357532,-25.432109,-25.4431255,-25.430572,-25.4289674,-25.445209,-25.4090219,-25.4295421,-25.4351398,-25.4501064,-25.4258236,-25.417535,-25.4335315,-25.4180373,-25.4483892,-25.4311071,-25.4179311,-25.4128421,-25.4129983,-25.4176941,-25.428672,-25.40504,-25.4303474,-25.4681559],[-49.2811883,-49.277973,-49.29084779999999,-49.2827132,-49.2789094,-49.2893225,-49.2871215,-49.27350879999999,-49.2853708,-49.2920136,-49.2938673,-49.2872582,-49.265494,-49.2656275,-49.3167883,-49.2882057,-49.2627553,-49.2793946,-49.3009885,-49.2688903,-49.2852218,-49.2488726,-49.2634846,-49.26541539999999,-49.2579874,-49.2464684,-49.2147448,-49.250978,-49.324071,-49.2939267],[11,9,7,5,7,5,9,5,5,5,5,5,5,9,7,7,9,5,7,9,9,9,5,7,9,5,7,9,5,5],null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":false,\"color\":[\"#7FB7D7\",\"#7FB7D7\",\"#FBC7AD\",\"#3E8BBF\",\"#BBD9E9\",\"#BBD9E9\",\"#3E8BBF\",\"#7FB7D7\",\"#1E61A5\",\"#BBD9E9\",\"#E6EFF4\",\"#BBD9E9\",\"#053061\",\"#7FB7D7\",\"#FBC7AD\",\"#3E8BBF\",\"#7FB7D7\",\"#FBC7AD\",\"#AB162A\",\"#7FB7D7\",\"#3E8BBF\",\"#1E61A5\",\"#3E8BBF\",\"#BBD9E9\",\"#BBD9E9\",\"#1E61A5\",\"#3E8BBF\",\"#3E8BBF\",\"#67001F\",\"#1E61A5\"],\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":[\"#7FB7D7\",\"#7FB7D7\",\"#FBC7AD\",\"#3E8BBF\",\"#BBD9E9\",\"#BBD9E9\",\"#3E8BBF\",\"#7FB7D7\",\"#1E61A5\",\"#BBD9E9\",\"#E6EFF4\",\"#BBD9E9\",\"#053061\",\"#7FB7D7\",\"#FBC7AD\",\"#3E8BBF\",\"#7FB7D7\",\"#FBC7AD\",\"#AB162A\",\"#7FB7D7\",\"#3E8BBF\",\"#1E61A5\",\"#3E8BBF\",\"#BBD9E9\",\"#BBD9E9\",\"#1E61A5\",\"#3E8BBF\",\"#3E8BBF\",\"#67001F\",\"#1E61A5\"],\"fillOpacity\":0.5},null,null,null,null,[\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.7 <br>\\n<b> No Ratings <\\/b> 912\",\"<b> The Coffee Comendador <\\/b> <br>\\n<b> Rating <\\/b>: 4.7 <br>\\n<b> No Ratings <\\/b> 345\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.3 <br>\\n<b> No Ratings <\\/b> 58\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.8 <br>\\n<b> No Ratings <\\/b> 30\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.6 <br>\\n<b> No Ratings <\\/b> 67\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.6 <br>\\n<b> No Ratings <\\/b> 13\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.8 <br>\\n<b> No Ratings <\\/b> 136\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.7 <br>\\n<b> No Ratings <\\/b> 47\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.9 <br>\\n<b> No Ratings <\\/b> 16\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.6 <br>\\n<b> No Ratings <\\/b> 30\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.5 <br>\\n<b> No Ratings <\\/b> 17\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.6 <br>\\n<b> No Ratings <\\/b> 38\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 5 <br>\\n<b> No Ratings <\\/b> 3\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.7 <br>\\n<b> No Ratings <\\/b> 122\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.3 <br>\\n<b> No Ratings <\\/b> 59\",\"<b> The Coffee República Argentina <\\/b> <br>\\n<b> Rating <\\/b>: 4.8 <br>\\n<b> No Ratings <\\/b> 82\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.7 <br>\\n<b> No Ratings <\\/b> 111\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.3 <br>\\n<b> No Ratings <\\/b> 9\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4 <br>\\n<b> No Ratings <\\/b> 71\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.7 <br>\\n<b> No Ratings <\\/b> 120\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.8 <br>\\n<b> No Ratings <\\/b> 146\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.9 <br>\\n<b> No Ratings <\\/b> 139\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.8 <br>\\n<b> No Ratings <\\/b> 36\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.6 <br>\\n<b> No Ratings <\\/b> 79\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.6 <br>\\n<b> No Ratings <\\/b> 281\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.9 <br>\\n<b> No Ratings <\\/b> 27\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.8 <br>\\n<b> No Ratings <\\/b> 64\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.8 <br>\\n<b> No Ratings <\\/b> 110\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 3.9 <br>\\n<b> No Ratings <\\/b> 11\",\"<b> The Coffee <\\/b> <br>\\n<b> Rating <\\/b>: 4.9 <br>\\n<b> No Ratings <\\/b> 43\"],{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]},{\"method\":\"addLegend\",\"args\":[{\"colors\":[\"#67001F , #AB162A 9.0909090909091%, #EC9373 27.2727272727273%, #FAEAE1 45.4545454545455%, #BBD9E9 63.6363636363636%, #3E8BBF 81.8181818181818%, #053061 100%, #053061 \"],\"labels\":[\"4.0\",\"4.2\",\"4.4\",\"4.6\",\"4.8\",\"5.0\"],\"na_color\":null,\"na_label\":\"NA\",\"opacity\":0.5,\"position\":\"topright\",\"type\":\"numeric\",\"title\":\"rating\",\"extra\":{\"p_1\":0.09090909090909098,\"p_n\":1},\"layerId\":null,\"className\":\"info legend\",\"group\":null}]},{\"method\":\"addProviderTiles\",\"args\":[\"CartoDB\",null,null,{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false}]}],\"limits\":{\"lat\":[-25.4681559,-25.40504],\"lng\":[-49.324071,-49.2147448]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n# Merging with Census information\n\nThe code below shows how to gather census tract data for each The Coffee shop. Census tracts are the smallest administrative division that present socioeconomic and demographic data.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Interpolation -------------------------------------------------------------\n\n## Functions ---------------------------------------------------------------\n\n# Creates a n minute walk isochrone around a point\nget_buffer <- function(point, radius = 5, simplified = FALSE) {\n  \n  stopifnot(length(radius) == 1 && is.numeric(radius))\n  \n  if (simplified) {\n    point |> \n      sf::st_transform(crs = 31982) |> \n      # Simplified assumption\n      sf::st_buffer(dist = ((1.5 - 1.2) / 2 + 1.2) * 60 * radius)\n  } else {\n    point |> \n      sf::st_transform(crs = 31982) |> \n      osrm::osrmIsochrone(breaks = radius, osrm.profile = \"foot\") |> \n      nngeo::st_remove_holes()\n  }\n  \n}\n\n# Interpolates an area with census tracts and aggregates population and households\ninterpolate_census <- function(census, target, variables = c(\"v0001\", \"v0003\")) {\n\n  if (st_crs(census) != st_crs(target)) {\n    warning(\"CRS mismatch\")\n    \n    census <- st_transform(census, crs = 31982)\n    target <- st_transform(target, crs = 31982)\n    \n  }\n\n  # Select variables\n  census <- dplyr::select(census, dplyr::all_of(variables))\n  # Interpolate areas\n  interp <- st_interpolate_aw(census, target, extensive = TRUE)\n  \n  return(interp)\n  \n}\n\n# Wrapper around get_buffer and interpolate_census\nfind_population <- function(shop, census, radius = 5, simplified = FALSE) {\n  \n  # Compute a 5-minute isochrone around\n  buffer <- get_buffer(shop, radius, simplified)\n  interpolated <- suppressWarnings(interpolate_census(census, buffer))\n  \n  return(interpolated)\n  \n}\n\n## Interpolate -------------------------------------------------------------\n\n# Uniquely identifies each shop\ncity_shops <- city_shops |> \n  mutate(shop_id = row_number())\n\n# To improve speed convert the full census data to 31982\ncity_census_utm <- st_transform(city_census, crs = 31982)\n\ncity_shops_census <- parallel::mclapply(\n  split(city_shops, city_shops$shop_id),\n  \\(x) find_population(x, census = city_census_utm)\n  )\n\ncity_shops_census <- bind_rows(city_shops_census, .id = \"shop_id\")\n\ncity_shops <- city_shops |> \n  mutate(shop_id = as.character(shop_id)) |> \n  left_join(st_drop_geometry(city_shops_census))\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=100%}\n:::\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=100%}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../../site_libs/leaflet-1.3.1/leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../../site_libs/leaflet-1.3.1/leaflet.js\"></script>\n<link href=\"../../../site_libs/leafletfix-1.0.0/leafletfix.css\" rel=\"stylesheet\" />\n<script src=\"../../../site_libs/proj4-2.6.2/proj4.min.js\"></script>\n<script src=\"../../../site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js\"></script>\n<link href=\"../../../site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../../site_libs/leaflet-binding-2.2.2/leaflet.js\"></script>\n<script src=\"../../../site_libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js\"></script>\n<script src=\"../../../site_libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
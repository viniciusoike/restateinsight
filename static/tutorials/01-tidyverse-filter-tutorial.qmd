---
title: "Dominando o filter() do dplyr"
subtitle: "Filtrando dados como um profissional"
learning_time: "30 minutos"
difficulty: "beginner"
date: "2025-01-15"
categories: ["tidyverse", "data-wrangling", "tutorial"]
prerequisites:
  - "R bÃ¡sico instalado"
  - "Conhecimento de operadores lÃ³gicos"
  - "Familiaridade com data.frames"
learning_objectives:
  - "Filtrar linhas usando condiÃ§Ãµes simples e complexas"
  - "Aplicar filtros em grupos de dados"
  - "Usar as funÃ§Ãµes auxiliares if_any e if_all"
  - "Combinar mÃºltiplas condiÃ§Ãµes de forma eficiente"
tools_needed:
  - "dplyr (>= 1.1.0)"
  - "readr"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: false
    code-tools: true
execute:
  warning: false
  message: false
  eval: false
draft: true
---

```{r setup}
#| include: false
library(kableExtra)
library(dplyr)
library(readr)

# FunÃ§Ã£o auxiliar para tabelas bonitas
print_table <- function(x, max_rows = 10) {
  x |>
    head(max_rows) |>
    knitr::kable(
      align = "c",
      digits = 0,
      format.args = list(big.mark = '.', decimal.mark = ",")
    ) |>
    kableExtra::kable_styling(
      full_width = FALSE,
      bootstrap_options = c("condensed", "responsive", "hover", "striped")
    )
}
```

## ğŸ¯ O que vocÃª vai aprender

Neste tutorial, vocÃª dominarÃ¡ a funÃ§Ã£o `filter()` do pacote `dplyr`, uma das ferramentas mais importantes para manipulaÃ§Ã£o de dados em R. Ao final, vocÃª serÃ¡ capaz de:

- âœ… Filtrar dados com confianÃ§a usando condiÃ§Ãµes lÃ³gicas
- âœ… Combinar mÃºltiplas condiÃ§Ãµes de forma eficiente
- âœ… Aplicar filtros dentro de grupos
- âœ… Usar funÃ§Ãµes auxiliares avanÃ§adas para casos complexos

## ğŸ“š Checklist de PrÃ©-requisitos

Antes de comeÃ§ar, verifique se vocÃª:

- [ ] Tem o R instalado (versÃ£o 4.0 ou superior)
- [ ] Sabe o que Ã© um data.frame
- [ ] Conhece operadores bÃ¡sicos: `>`, `<`, `==`, `!=`
- [ ] Entende a diferenÃ§a entre `&` (E) e `|` (OU)

::: {.callout-tip}
**NÃ£o tem certeza?** Execute este cÃ³digo para verificar:
```{r}
#| eval: false
# Verifica versÃ£o do R
R.version.string

# Testa operadores bÃ¡sicos
5 > 3  # Deve retornar TRUE
2 == 2 # Deve retornar TRUE
TRUE & FALSE # Deve retornar FALSE
TRUE | FALSE # Deve retornar TRUE
```
:::

## ğŸ”§ PreparaÃ§Ã£o do Ambiente

### InstalaÃ§Ã£o e carregamento de pacotes

```{r}
#| eval: false
# Instalar pacotes necessÃ¡rios (se ainda nÃ£o tiver)
install.packages(c("dplyr", "readr"))
```

```{r}
# Carregar pacotes
library(dplyr)
library(readr)
```

### Dados para prÃ¡tica

Vamos trabalhar com dados reais de cidades brasileiras:

```{r}
# Baixar dados de cidades brasileiras
dat <- readr::read_csv(
  "https://github.com/viniciusoike/restateinsight/raw/main/static/data/cities_brazil.csv",
  show_col_types = FALSE
)

# Visualizar estrutura dos dados
glimpse(dat)
```

::: {.callout-note}
**Sobre os dados**: Este dataset contÃ©m informaÃ§Ãµes de 5.570 municÃ­pios brasileiros, incluindo populaÃ§Ã£o, PIB, densidade demogrÃ¡fica e outras mÃ©tricas socioeconÃ´micas.
:::

## ğŸ“– Conceito: O que Ã© filter()?

A funÃ§Ã£o `filter()` **seleciona linhas** de uma tabela baseada em condiÃ§Ãµes lÃ³gicas. Ã‰ como aplicar um filtro no Excel, mas muito mais poderoso.

**Sintaxe bÃ¡sica:**
```r
filter(dados, condiÃ§Ã£o)
```

**Analogia**: Imagine que vocÃª tem uma pilha de fichas e quer separar apenas as azuis. O `filter()` faz exatamente isso com suas linhas de dados!

## ğŸ’» PrÃ¡tica Guiada

### NÃ­vel 1: Filtros Simples

#### Exemplo 1.1: Filtrar por valores numÃ©ricos

```{r}
# Cidades com populaÃ§Ã£o acima de 1 milhÃ£o
grandes_cidades <- filter(dat, population > 1000000)

print_table(grandes_cidades |> select(name_muni, population))
```

::: {.callout-tip collapse="true"}
## ğŸ’¡ Dica
Use notaÃ§Ã£o cientÃ­fica para nÃºmeros grandes: `1e6` = 1.000.000
:::

#### Exemplo 1.2: Filtrar por texto

```{r}
# Apenas cidades de SÃ£o Paulo
cidades_sp <- filter(dat, abbrev_state == "SP")
nrow(cidades_sp)
```

### ğŸ§ª Checkpoint 1: Teste seu conhecimento

**ExercÃ­cio**: Filtre todas as cidades da regiÃ£o Nordeste.

```{r}
#| eval: false
#| code-fold: true
#| code-summary: "Clique para ver a soluÃ§Ã£o"

# SoluÃ§Ã£o:
nordeste <- filter(dat, name_region == "Nordeste")
nrow(nordeste) # Deve retornar 1794
```

### NÃ­vel 2: Combinando CondiÃ§Ãµes

#### Exemplo 2.1: Usando mÃºltiplas condiÃ§Ãµes (E)

```{r}
# Cidades grandes E da regiÃ£o Sul
resultado <- dat |>
  filter(
    population > 500000,
    name_region == "Sul"
  )

print_table(resultado |> select(name_muni, abbrev_state, population))
```

::: {.callout-important}
**Importante**: VÃ­rgulas entre condiÃ§Ãµes significam "E" (todas devem ser verdadeiras)
:::

#### Exemplo 2.2: Usando OU

```{r}
# Cidades de SP OU RJ
sp_ou_rj <- dat |>
  filter(abbrev_state == "SP" | abbrev_state == "RJ")

# Forma mais elegante usando %in%
sp_ou_rj <- dat |>
  filter(abbrev_state %in% c("SP", "RJ"))

unique(sp_ou_rj$abbrev_state)
```

### ğŸ§ª Checkpoint 2: CombinaÃ§Ãµes

**ExercÃ­cio**: Encontre cidades com:
- PopulaÃ§Ã£o entre 100.000 e 500.000 habitantes
- Localizadas nas regiÃµes Sul ou Sudeste

```{r}
#| eval: false
#| code-fold: true
#| code-summary: "Clique para ver a soluÃ§Ã£o"

# SoluÃ§Ã£o:
resultado <- dat |>
  filter(
    population >= 100000,
    population <= 500000,
    name_region %in% c("Sul", "Sudeste")
  )

nrow(resultado) # Deve retornar 141
```

### NÃ­vel 3: Filtros AvanÃ§ados

#### Exemplo 3.1: Filtros com funÃ§Ãµes

```{r}
# Cidades com PIB acima da mÃ©dia nacional
pib_alto <- dat |>
  filter(pib > mean(pib, na.rm = TRUE))

paste("Cidades com PIB acima da mÃ©dia:", nrow(pib_alto))
```

#### Exemplo 3.2: Filtros por grupo

```{r}
# A maior cidade de cada estado
maior_por_estado <- dat |>
  filter(population == max(population), .by = "abbrev_state")

print_table(maior_por_estado |> select(name_muni, abbrev_state, population))
```

::: {.callout-note}
**Nova sintaxe**: `.by = "coluna"` aplica o filtro dentro de cada grupo
:::

### NÃ­vel 4: FunÃ§Ãµes Auxiliares

#### if_any() e if_all()

```{r}
# Cidades onde QUALQUER indicador econÃ´mico estÃ¡ no top 1%
top_economico <- dat |>
  filter(if_any(c(pib, pib_per_capita), ~ . > quantile(., 0.99, na.rm = TRUE)))

paste("Cidades no top 1% econÃ´mico:", nrow(top_economico))
```

```{r}
# Cidades onde TODOS os indicadores sÃ£o positivos
todos_positivos <- dat |>
  filter(if_all(where(is.numeric), ~ . > 0 | is.na(.)))

paste("Cidades com todos indicadores positivos:", nrow(todos_positivos))
```

## ğŸš€ Sua Vez: Desafio PrÃ¡tico

### Desafio 1: AnÃ¡lise Regional

Crie uma anÃ¡lise que responda: Quais sÃ£o as 5 cidades mais populosas de cada regiÃ£o que NÃƒO sÃ£o capitais estaduais?

```{r}
#| eval: false
# Seu cÃ³digo aqui:
resultado <- dat |>
  filter(___) |>
  ___
```

::: {.callout-tip collapse="true"}
## ğŸ’¡ Dica
1. Primeiro, identifique as capitais (talvez pela populaÃ§Ã£o?)
2. Use `!` para negar a condiÃ§Ã£o
3. Use `.by = "name_region"` para agrupar
:::

```{r}
#| eval: false
#| code-fold: true
#| code-summary: "SoluÃ§Ã£o completa"

# SoluÃ§Ã£o:
# Primeiro, identificar as capitais (geralmente as maiores cidades do estado)
capitais <- dat |>
  slice_max(population, n = 1, by = abbrev_state) |>
  pull(name_muni)

# Filtrar nÃ£o-capitais e pegar top 5 por regiÃ£o
top5_nao_capitais <- dat |>
  filter(!name_muni %in% capitais) |>
  slice_max(population, n = 5, by = name_region) |>
  arrange(name_region, desc(population))

print_table(top5_nao_capitais |>
  select(name_region, name_muni, abbrev_state, population))
```

### Desafio 2: Filtro Complexo

Encontre cidades que atendam TODOS estes critÃ©rios:
1. PopulaÃ§Ã£o entre 50.000 e 200.000
2. PIB per capita acima da mÃ©dia do seu estado
3. Localizada no interior (nÃ£o litorÃ¢nea)

```{r}
#| eval: false
#| code-fold: true
#| code-summary: "SoluÃ§Ã£o completa"

# SoluÃ§Ã£o:
resultado <- dat |>
  filter(
    population >= 50000,
    population <= 200000,
    pib_per_capita > mean(pib_per_capita, na.rm = TRUE),
    .by = "abbrev_state"
  ) |>
  # Assumindo que temos uma variÃ¡vel indicando cidade litorÃ¢nea
  # filter(!coastal)

  select(name_muni, abbrev_state, population, pib_per_capita)

# Como nÃ£o temos variÃ¡vel de litoral nos dados,
# este Ã© um exemplo conceitual
```

## âœ… SoluÃ§Ãµes Detalhadas

### Por que estas soluÃ§Ãµes funcionam?

1. **CombinaÃ§Ã£o de condiÃ§Ãµes**: Usar vÃ­rgulas Ã© mais legÃ­vel que `&`
2. **Operador %in%**: Mais eficiente que mÃºltiplos `|` (OU)
3. **Filtros por grupo**: Permitem comparaÃ§Ãµes relativas
4. **if_any/if_all**: Simplificam condiÃ§Ãµes em mÃºltiplas colunas

## ğŸ“ Principais Aprendizados

âœ… **filter()** seleciona linhas baseadas em condiÃ§Ãµes lÃ³gicas

âœ… **VÃ­rgulas** entre condiÃ§Ãµes = E (AND)

âœ… **%in%** verifica se valor estÃ¡ em um vetor

âœ… **.by** aplica filtros dentro de grupos

âœ… **if_any()** e **if_all()** trabalham com mÃºltiplas colunas

## ğŸ“Š ReferÃªncia RÃ¡pida

```r
# Sintaxe bÃ¡sica
filter(dados, condiÃ§Ã£o)

# Operadores principais
==   # igual a
!=   # diferente de
>    # maior que
<    # menor que
>=   # maior ou igual
<=   # menor ou igual
%in% # estÃ¡ contido em
!    # negaÃ§Ã£o

# CombinaÃ§Ãµes
filter(dados, cond1, cond2)      # E
filter(dados, cond1 | cond2)     # OU
filter(dados, !(condiÃ§Ã£o))       # NÃƒO

# Por grupo
filter(dados, condiÃ§Ã£o, .by = "coluna")

# MÃºltiplas colunas
filter(dados, if_any(cols, ~ . > 0))
filter(dados, if_all(cols, ~ . > 0))
```

## ğŸ” Problemas Comuns e SoluÃ§Ãµes

| Problema | Causa | SoluÃ§Ã£o |
|----------|-------|---------|
| "Error: object not found" | VariÃ¡vel nÃ£o existe | Verifique nomes com `names(dados)` |
| Resultado vazio | CondiÃ§Ã£o muito restritiva | Teste condiÃ§Ãµes separadamente |
| Resultado inesperado | ConfusÃ£o entre `&` e `\|` | Revise lÃ³gica booleana |
| NA nos resultados | Valores ausentes | Use `!is.na()` na condiÃ§Ã£o |

## ğŸš¦ Auto-avaliaÃ§Ã£o

Rate seu entendimento:

- [ ] Consigo filtrar por uma condiÃ§Ã£o simples
- [ ] Combino mÃºltiplas condiÃ§Ãµes com confianÃ§a
- [ ] Uso %in% para mÃºltiplos valores
- [ ] Aplico filtros por grupo
- [ ] Domino if_any() e if_all()

Se vocÃª marcou 4+ itens, parabÃ©ns! ğŸ‰ VocÃª dominou o filter()!

## ğŸ”— PrÃ³ximos Passos

**Pronto para mais?** Continue sua jornada tidyverse:

1. ğŸ“˜ [select() - Escolhendo colunas](../02-tidyverse-select)
2. ğŸ“— [mutate() - Criando variÃ¡veis](../03-tidyverse-mutate)
3. ğŸ“™ [summarise() - Resumindo dados](../04-tidyverse-summarise)
4. ğŸ“• [Combinando todos os verbos](../05-tidyverse-completo)

## ğŸ’¬ Feedback

Como foi sua experiÃªncia com este tutorial?

::: {.callout-note}
**Compartilhe**: Encontrou um erro ou tem sugestÃµes? Abra uma issue no [GitHub](https://github.com/viniciusoike/restateinsight/issues)
:::

---

**Tempo estimado gasto**: 30 minutos | **NÃ­vel**: Iniciante | **Ãšltima atualizaÃ§Ã£o**: Janeiro 2025

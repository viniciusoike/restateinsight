<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vinicius Oike">
<meta name="dcterms.date" content="2023-07-07">
<meta name="description" content="Este post revisa as principais funções para manipulação de dados do Tidyverse. O material serve mais como referência e apoio ao tutorial de ggplot2 do que como introdução ao assunto.">

<title>Apêndice: manipular para enxergar – Vinicius Oike</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-65ceba22b1a2bc45b1f8c349a1513ec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-1d3a31d95e5cb5c8e68bd63598ea7077.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EJF8PGT67H"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-EJF8PGT67H', { 'anonymize_ip': true});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Apêndice: manipular para enxergar – Vinicius Oike">
<meta property="og:description" content="Este post revisa as principais funções para manipulação de dados do Tidyverse. O material serve mais como referência e apoio ao tutorial de ggplot2 do que como introdução ao assunto.">
<meta property="og:site_name" content="Vinicius Oike">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vinicius Oike</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../aboutme.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../cv.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../my_apps.html"> 
<span class="menu-text">Apps</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../press.html"> 
<span class="menu-text">Press</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/viniciusoike"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/viniciusoike"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Apêndice: manipular para enxergar</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Este post revisa as principais funções para manipulação de dados do Tidyverse. O material serve mais como referência e apoio ao tutorial de ggplot2 do que como introdução ao assunto.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">data-visualization</div>
                <div class="quarto-category">ggplot2</div>
                <div class="quarto-category">tutorial-R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Vinicius Oike </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 7, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introdução" id="toc-introdução" class="nav-link active" data-scroll-target="#introdução">Introdução</a></li>
  <li><a href="#limpeza-de-dados" id="toc-limpeza-de-dados" class="nav-link" data-scroll-target="#limpeza-de-dados">Limpeza de dados</a>
  <ul class="collapse">
  <li><a href="#você-tem-um-momento-para-falar-sobre-o-tidyverse" id="toc-você-tem-um-momento-para-falar-sobre-o-tidyverse" class="nav-link" data-scroll-target="#você-tem-um-momento-para-falar-sobre-o-tidyverse">Você tem um momento para falar sobre o <code>tidyverse</code>?</a></li>
  <li><a href="#a-filosofia-do-tidyverse" id="toc-a-filosofia-do-tidyverse" class="nav-link" data-scroll-target="#a-filosofia-do-tidyverse">A filosofia do <code>tidyverse</code></a></li>
  <li><a href="#tabelas" id="toc-tabelas" class="nav-link" data-scroll-target="#tabelas">Tabelas</a>
  <ul class="collapse">
  <li><a href="#construindo-tabelas" id="toc-construindo-tabelas" class="nav-link" data-scroll-target="#construindo-tabelas">Construindo tabelas</a></li>
  <li><a href="#propriedades-de-tabelas" id="toc-propriedades-de-tabelas" class="nav-link" data-scroll-target="#propriedades-de-tabelas">Propriedades de tabelas</a></li>
  <li><a href="#importando-tabelas" id="toc-importando-tabelas" class="nav-link" data-scroll-target="#importando-tabelas">Importando tabelas</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#manipulando-dados" id="toc-manipulando-dados" class="nav-link" data-scroll-target="#manipulando-dados">Manipulando dados</a>
  <ul class="collapse">
  <li><a href="#rename" id="toc-rename" class="nav-link" data-scroll-target="#rename">rename</a></li>
  <li><a href="#select" id="toc-select" class="nav-link" data-scroll-target="#select">select</a></li>
  <li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter">filter</a></li>
  <li><a href="#arrange" id="toc-arrange" class="nav-link" data-scroll-target="#arrange">arrange</a></li>
  <li><a href="#mutate" id="toc-mutate" class="nav-link" data-scroll-target="#mutate">mutate</a></li>
  <li><a href="#summarise-e-group_by" id="toc-summarise-e-group_by" class="nav-link" data-scroll-target="#summarise-e-group_by">summarise e group_by</a>
  <ul class="collapse">
  <li><a href="#uso-básico" id="toc-uso-básico" class="nav-link" data-scroll-target="#uso-básico">Uso básico</a></li>
  <li><a href="#um-pouco-mais-de-group_by" id="toc-um-pouco-mais-de-group_by" class="nav-link" data-scroll-target="#um-pouco-mais-de-group_by">Um pouco mais de <code>group_by</code></a></li>
  <li><a href="#um-pouco-mais-de-summarise" id="toc-um-pouco-mais-de-summarise" class="nav-link" data-scroll-target="#um-pouco-mais-de-summarise">Um pouco mais de <code>summarise</code></a></li>
  <li><a href="#adendos-técnicos" id="toc-adendos-técnicos" class="nav-link" data-scroll-target="#adendos-técnicos">Adendos técnicos</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#formato-dos-dados" id="toc-formato-dos-dados" class="nav-link" data-scroll-target="#formato-dos-dados">Formato dos dados</a>
  <ul class="collapse">
  <li><a href="#contra-exemplos" id="toc-contra-exemplos" class="nav-link" data-scroll-target="#contra-exemplos">Contra-exemplos</a>
  <ul class="collapse">
  <li><a href="#vendas-de-casas-e-apartamentos" id="toc-vendas-de-casas-e-apartamentos" class="nav-link" data-scroll-target="#vendas-de-casas-e-apartamentos">Vendas de casas e apartamentos</a></li>
  <li><a href="#vendas-e-alugueis-de-apartamentos-e-casas" id="toc-vendas-e-alugueis-de-apartamentos-e-casas" class="nav-link" data-scroll-target="#vendas-e-alugueis-de-apartamentos-e-casas">Vendas e Alugueis de apartamentos e casas</a></li>
  <li><a href="#teste-ab" id="toc-teste-ab" class="nav-link" data-scroll-target="#teste-ab">Teste AB</a></li>
  <li><a href="#cidades" id="toc-cidades" class="nav-link" data-scroll-target="#cidades">Cidades</a></li>
  <li><a href="#casas-e-apartamentos" id="toc-casas-e-apartamentos" class="nav-link" data-scroll-target="#casas-e-apartamentos">Casas e Apartamentos</a></li>
  </ul></li>
  <li><a href="#organizando" id="toc-organizando" class="nav-link" data-scroll-target="#organizando">Organizando</a>
  <ul class="collapse">
  <li><a href="#exemplo-1" id="toc-exemplo-1" class="nav-link" data-scroll-target="#exemplo-1">Exemplo 1</a></li>
  <li><a href="#exemplo-2" id="toc-exemplo-2" class="nav-link" data-scroll-target="#exemplo-2">Exemplo 2</a></li>
  <li><a href="#exemplo-3" id="toc-exemplo-3" class="nav-link" data-scroll-target="#exemplo-3">Exemplo 3</a></li>
  <li><a href="#exemplo-4" id="toc-exemplo-4" class="nav-link" data-scroll-target="#exemplo-4">Exemplo 4</a></li>
  <li><a href="#exemplo-5" id="toc-exemplo-5" class="nav-link" data-scroll-target="#exemplo-5">Exemplo 5</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#referências-e-comentários" id="toc-referências-e-comentários" class="nav-link" data-scroll-target="#referências-e-comentários">Referências e Comentários</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introdução" class="level1">
<h1>Introdução</h1>
<p>Este tutorial, ao contrário da série “ggplot2: do básico ao intermediário” já assume que se tenha um entendimento razoável de <code>R</code>. O material aqui serve mais para consultar/relembrar ou aprender um truque novo. Da maneira como está escrito, não é adequado para uma primeira leitura. Grosso modo, a referência aqui é Hadley (2017) capítulos 4, 5, 10-12.</p>
</section>
<section id="limpeza-de-dados" class="level1">
<h1>Limpeza de dados</h1>
<p>O primeiro passo para montar uma visualização é ter os dados no formato certo. Em geral, isto envolve três etapas: (1) importar os dados no <code>R</code>; (2) limpar os dados; e (3) transformar os dados no formato apropriado. Neste tutorial vamos focar sobretudo nas últimas duas etapas.</p>
<p>Dados tabulares são armazenados dentro de objetos chamados <code>data.frame</code>. Todo gráfico de <code>ggplot</code> começa com um (ou mais) <code>data.frame</code>. Apesar de ser possível montar gráficos a partir de vetores de dados dispersos, recomendo fortemente que sempre se utilize dados dentro de <code>data.frame.</code> Isto garante um código mais organizado e menos propenso a erros.</p>
<p>Apesar de funcionar como um repositório de pacotes, o <code>R</code> já vem com diversas funções “de fábrica” que permitem a importação e manipulação de dados. Estas funções que já vem carregadas no <code>R</code> são chamadas de funções “base” ou “base-R”. Alguns pacotes foram criados para melhorar estas funções “base”.</p>
<section id="você-tem-um-momento-para-falar-sobre-o-tidyverse" class="level3">
<h3 class="anchored" data-anchor-id="você-tem-um-momento-para-falar-sobre-o-tidyverse">Você tem um momento para falar sobre o <code>tidyverse</code>?</h3>
<p>O <code>tidyverse</code> é um metapacote, ele instala vários pacotes simultaneamente quando instalado e carrega múltiplos pacotes quando chamado. Estes pacotes formam uma família de pacotes que são unidos por uma filosofia e um objetivos comuns: todos os pacotes têm como objetivo a limpeza de dados e, de maneira geral, seguem o princípio de “tidy” data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instala o pacote tidyverse</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Carrega o pacote tidyverse</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyverse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Todos os pacotes e funções que vamos utilizar serão carregados nesta única linha de código.</p>
<ul>
<li><code>readr</code> - importação e exportação de dados.</li>
<li><code>dplyr</code> - manipulação de dados.</li>
<li><code>tidyr</code> - manipulação de dados.</li>
<li><code>stringr</code> - manipulacao de strings (<code>character</code>)</li>
<li><code>forcats</code> - manipulacao de <code>factors</code></li>
<li><code>lubridate</code> - manipulação de datas (<code>Date</code>)</li>
</ul>
<p>O <code>tidyverse</code> inclui ainda mais pacotes, como <code>rvest</code> para webscrapping, ou <code>dbplyr</code> que permite utilizar comandos do <code>dplyr</code> em databases.</p>
</section>
<section id="a-filosofia-do-tidyverse" class="level3">
<h3 class="anchored" data-anchor-id="a-filosofia-do-tidyverse">A filosofia do <code>tidyverse</code></h3>
<p>Numa primeira leitura, esta seção pode ser pulada sem grandes prejuízos; contudo, ela pode ser interessante numa segunda leitura ou para leitores que já tem alguma familiaridade com <code>tidyverse</code>.</p>
<p>A filosofia geral do <code>tidyverse</code> toma muito emprestado da gramática. As funções têm nomes de verbos que costumam ser intuitivos e são encadeados via “pipes”<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> que funcionam como conectivos numa frase. Em tese, isto torna o código mais legível e até mais didático. A tarefa de renomear colunas, criar variáveis e calcular uma média nos grupos torna-se “linear” no mesmo sentido em que uma frase com sujeito-verbo-objeto é linear.</p>
<p>O pipe, essencialmente, carrega o resultado de uma função adiante numa cadeia de comandos: <code>objeto |&gt; função1 |&gt; função2 |&gt; função3</code>. Isto tem duas vantagens: primeiro, evita que você use funções compostas que são lidas “de dentro para fora” como <code>exp(mean(log(x)))</code>; e, segundo, dispensa a criação de objetos intermediários “inúteis” que estão ali somente para segurar um valor que não vai ser utilizado mais adiante.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(AirPassengers) <span class="sc">~</span> <span class="fu">time</span>(AirPassengers))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Função composta</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">exp</span>(<span class="fu">fitted</span>(model)))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Usando pipes</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>model <span class="sc">|&gt;</span> <span class="fu">fitted</span>() <span class="sc">|&gt;</span> <span class="fu">exp</span>() <span class="sc">|&gt;</span> <span class="fu">mean</span>()</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Usando objetos intermediários</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">fitted</span>(model)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">exp</span>(x1)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>x3 <span class="ot">&lt;-</span> <span class="fu">mean</span>(x2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Há um tempo atrás argumentava-se contra o uso de “pipes”, pois estes dificultavam a tarefa de encontrar bugs no código. Isto continua sendo parcialmente verdade, mas as funções do <code>tidyvserse</code> atualmente têm mensagens de erro bastante ricas e permitem encontrar a fonte do erro com relativa facilidade. Ainda assim, não se recomenda encadear funções em excesso, i.e., pipes com 10 funções ou mais.</p>
<p>Outra filosofia do <code>tidyverse</code> é de que tarefas rotineiras devem ser transformadas em funções específicas. Neste sentido, os pacotes <code>dplyr</code>, <code>tidyr</code> e afins são recheados de funções, às vezes com nomes muito semelhantes e com usos redundantes. As funções <code>starts_with</code> e <code>ends_with</code>, por exemplo, são casos específicos da função <code>matches</code>. Há funções que permitem até duas formas de grafia como <code>summarise</code> e <code>summarize</code>. Outras como <code>slice_min</code> e <code>slice_max</code> são convenientes mas são literalmente: <code>arrange + slice</code>.</p>
<p>Somando somente os dois principais pacotes, <code>dplyr</code> e <code>tidyr</code>, há 360 funções disponíveis. Contraste isto com o <code>data.table</code> que permite fazer 95% das transformações de dados somente com <code>dt[i, j, by = c(), .SDcols = cols]</code>.</p>
<p>Mesmo as funções base do <code>R</code> costumam ser mais sucintas do que códigos em <code>tidyverse</code>. No exemplo abaixo, a função <code>tapply</code> consegue o mesmo resultado que o código mais extenso feito com <code>dplyr</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tapply</span>(mtcars<span class="sc">$</span>mpg, mtcars<span class="sc">$</span>cyl, mean)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">|&gt;</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cyl) <span class="sc">|&gt;</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">avg =</span> <span class="fu">mean</span>(cyl))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As vantagens do <code>tidyverse</code> se tornam mais evidentes com o tempo. De fato, o pacote permite abstrações muito poderosas, e eventualmente, pode-se fazer um código centenas de vezes mais sucinto combinando as suas funções.</p>
<p>O lado negativo disto tudo é que para não-falantes de inglês muitas destas “vantagens gramaticais” são despercebidas<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>; e o resultado é somente um código “verborrágico”, cheio de funções. Atualmente, parece haver um consenso crescente de que a melhor forma de começar a aprender R é começando pelo tidyverse; esta visão não é livre de críticos como de <a href="https://github.com/matloff/TidyverseSkeptic">Norm Matloff, professor de estatística da UC Davis</a>.</p>
<p>Um fato particularmente irritante do <code>tidyverse</code> é a frequência com que os pacotes mudam. Na maior parte das vezes, as mudanças são positivas, mas isto faz com que o código escrito em tidyverse não seja sustentável ao longo do tempo.</p>
<p>Eu demorei um bom tempo para entender as funções <code>tidyr::gather</code> e <code>tidyr::spread</code> e, atualmente, ambas foram descontinuadas e substituídas pelas funções <code>pivot_longer</code> e <code>pivot_wider</code>. As funções <code>mutate_if</code>, <code>mutate_at</code> e similares do <code>dplyr</code> foram todas suprimidas pela sinataxe mais geral do <code>across</code>. A função <code>tidyr::separate</code> agora está sendo substituída por <code>separate_wider_position</code> e <code>separate_wider_delim</code>.</p>
<p>Mesmo um código bem escrito há poucos anos atrás tem grandes chances de não funcionar mais porque as funções foram alteradas ou descontinuadas. Em 2021, Hadley Wickham, a principal mente por trás do tidyverse, discutiu este problema abertamente <a href="https://posit.co/resources/videos/maintaining-the-house-the-tidyverse-built/">numa palestra</a>. Desde então, o tidyverse tem melhorado a sua política de <a href="https://lifecycle.r-lib.org/articles/stages.html">manutenção de funções</a>.</p>
</section>
<section id="tabelas" class="level2">
<h2 class="anchored" data-anchor-id="tabelas">Tabelas</h2>
<p>O objeto central da análise de dados é o <code>data.frame</code>. Um <code>data.frame</code> é uma tabela bidimensional que contém informações: em geral, cada coluna é uma variável diferente e cada linha é uma observação. Este objeto possui propriedades bastante simples:</p>
<ol type="1">
<li><strong>Comprimento fixo</strong>. O número de linhas de um <code>data.frame</code> é fixo, assim todas as colunas têm o mesmo comprimento.</li>
<li><strong>Homogeneidade</strong>. Cada coluna de um <code>data.frame</code> é homogênea, isto é, contém um dado de um único tipo. Assim, uma mesma coluna não pode misturar um string e um número, um <code>factor</code> e um string, etc.</li>
<li><strong>Nomes</strong>. Cada coluna tem um nome (único e idiomático). Este nome é utilizado para fazer refrência a esta coluna.</li>
</ol>
<p>Estas três características garantem a funcionalidade e consistência de um <code>data.frame</code>. O comprimento fixo e a homogeneidade, em particular, tornam este tipo de objeto muito conveniente e previsível.</p>
<section id="construindo-tabelas" class="level3">
<h3 class="anchored" data-anchor-id="construindo-tabelas">Construindo tabelas</h3>
<p>Para construir um <code>data.frame</code> basta chamar a função homônima e declarar as suas colunas seguindo as três propriedades acima. Nos exemplos abaixo, ao invés da função <code>data.frame</code> vou utilizar a função <code>tibble</code> que é, essencialmente, equivalente, mas que possui algumas pequenas vantagens. No restante do texto as palavras <code>tibble</code> e <code>data.frame</code> serão utilizadas como sinônimas.</p>
<p>No primeiro exemplo crio uma tabela com três linhas e duas colunas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dados <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">cidade =</span> <span class="fu">c</span>(<span class="st">"Porto Alegre"</span>, <span class="st">"São Paulo"</span>, <span class="st">"Salvador"</span>),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop22 =</span> <span class="fu">c</span>(<span class="fl">1.332</span>, <span class="fl">11.451</span>, <span class="fl">2.418</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para visualizar o resultado basta chamar o objeto por nome ou usar a função <code>print</code>. Uma das vantanges do <code>tibble</code> é de mostrar a classe de cada coluna, onde <code>chr</code> indica <em>character</em> (caractere), isto é, um string e <code>dbl</code> indica <em>double</em>, isto é, um número<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>dados</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pode-se também criar a tabela a partir de vetores/objetos previamente declarados.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cidades <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Porto Alegre"</span>, <span class="st">"São Paulo"</span>, <span class="st">"Salvador"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>populacao <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.332</span>, <span class="fl">11.451</span>, <span class="fl">2.418</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>dados <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">nome_cidade =</span> cidades,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop22 =</span> populacao</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Quando alguma das colunas não tiver o mesmo comprimento das demais, o <code>R</code> vai tentar “reciclar” os valores desta coluna. Em geral, isto vai causar um erro, mas em alguns casos pode funcionar. No caso abaixo o valor <code>"Brasil"</code> (de comprimento unitário) é repetido três vezes para “caber” dentro da tabela.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dados <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">cidade =</span> <span class="fu">c</span>(<span class="st">"Porto Alegre"</span>, <span class="st">"São Paulo"</span>, <span class="st">"Salvador"</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop22 =</span> <span class="fu">c</span>(<span class="fl">1.332</span>, <span class="fl">11.451</span>, <span class="fl">2.418</span>),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pais =</span> <span class="st">"Brasil"</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>dados</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="propriedades-de-tabelas" class="level3">
<h3 class="anchored" data-anchor-id="propriedades-de-tabelas">Propriedades de tabelas</h3>
<p>Toda coluna de um <code>data.frame</code> possui nomes. Para acessar os nomes usa-se <code>names</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(dados)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "cidade" "pop22"  "pais"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Os nomes das colunas sempre devem ser únicos. Aqui, há uma pequena vantagem em utilizar o <code>tibble</code>. Mesmo no caso em que se tenta criar uma tabela com nomes idênticos, a função <code>data.frame</code> evita que isto aconteça, mas emite nenhum tipo de alerta sobre o que está acontecendo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>tab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A função <code>tibble</code> é um pouco mais exigente e retorna um erro neste caso.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para extrair uma coluna de um <code>data.frame</code> temos duas opções. A mais simples e direta é utilizar o operador <code>$</code> e chamar o nome da coluna como se fosse um objeto. A segunda opção é utilizar <code>[[</code> e chamar o nome da coluna como um string<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Extraindo uma coluna </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>dados<span class="sc">$</span>cidade</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "Porto Alegre" "São Paulo"    "Salvador"</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>dados[[<span class="st">"cidade"</span>]]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "Porto Alegre" "São Paulo"    "Salvador"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="importando-tabelas" class="level3">
<h3 class="anchored" data-anchor-id="importando-tabelas">Importando tabelas</h3>
<p>Raramente vamos declarar todas as observações de uma tabela. Na prática, é muito mais comum importar uma tabela de alguma fonte externa como de uma planilha de Excel ou de um arquivo csv. Para cada tipo de arquivo existe uma função <code>read_*</code> diferente. Importar dados costuma ser uma tarefa frustrante por três motivos:</p>
<ol type="1">
<li>Há muitos arquivos para se importar.</li>
<li>É difícil fazer o <code>R</code> encontrar o arquivo.</li>
<li>Os arquivos têm problemas (valores corrompidos, linhas vazias, etc.)</li>
</ol>
<p>Os dois primeiros problemas são simples de se resolver. Pode-se importar múltiplos arquivos ao mesmo tempo usando um loop; importar todos os arquivos dentro de uma mesma pasta é trivial, desde que os arquivos sigam o mesmo padrão.</p>
<p>Garantir que o <code>R</code> consiga encontrar os arquivos também é simples. Idealmente, todos os arquivos externos devem estar organizados dentro de uma pasta chamada <code>dados</code> ou <code>data</code> e deve-se chamar estes dados usando funções <code>read_*</code>. Uma boa prática é sempre usar “caminhos relativos” ao invés de caminhos absolutos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Ruim</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"/Users/viniciusoike/Documents/GitHub/projeto/data/income.csv"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Bom </span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/income.csv"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Ainda melhor</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/income.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>O terceiro problema é muito mais complexo e vai exigir mais conhecimento e prática. Em geral, resolve-se a maior parte dos problemas usando algum dos argumentos dentro da função <code>read_*</code> como:</p>
<ul>
<li><p><code>skip</code>: Pula as primeiras k linhas.</p></li>
<li><p><code>na</code>: Define quais valores devem ser interpretados como valores ausentes.</p></li>
<li><p><code>col_types</code>: Permite que se declare explicitamente qual o tipo de dado (numérico, data, texto) que está armazenado em cada coluna.</p></li>
<li><p><code>col_names</code> ou <code>name_repair</code>: O primeiro permite que se declare explicitamente o nome que cada coluna vai ter dentro do <code>R</code> enquanto o segundo permite que se use uma função que renomeia as colunas.</p></li>
<li><p><code>locale</code>: Permite selecionar diferentes tipos de padrão de local. Em geral, usa-se <code>locale = locale("pt_BR")</code>.</p></li>
<li><p>range: Este argumento só vale no caso de planilhas de Excel e permite que se importe uma seleção específica da planilha (e.g.&nbsp;“D4:H115”)</p></li>
</ul>
<p>O código abaixo mostra um exemplo particularmente tenebroso. O título da segunda coluna inclui símbolos como <code>$</code> e <code>/</code>; as datas estão em português com o mês escrito por extenso e em formato dia-mês-ano; os números usam a vírgula (ao invés do ponto) para separar o decimal e o valor ausente é sinalizado com “X”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Input de um csv sujo</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>dados <span class="ot">&lt;-</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="st">'Data; Valor (R$/m2)</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="st">"01-maio-2020";22,3</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="st">"01-junho-2020";21,5</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="st">"06-julho-2021";X</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="st">"07-novembro-2022";22'</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Lendo o arquivo</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Substitui esta linha pelo 'path' até o csv</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">I</span>(dados),</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">delim =</span> <span class="st">";"</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Usa , como separador decimal; lê meses em português (e.g. maio, junho, etc.)</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">locale =</span> <span class="fu">locale</span>(<span class="at">decimal_mark =</span> <span class="st">","</span>, <span class="at">date_names =</span> <span class="st">"pt"</span>, <span class="at">date_format =</span> <span class="st">"%d-%B-%Y"</span>),</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Interpreta X como valores ausentes (NA)</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="st">"x"</span>,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Renomeia as colunas</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">name_repair =</span> janitor<span class="sc">::</span>clean_names</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="manipulando-dados" class="level1">
<h1>Manipulando dados</h1>
<p>O pacote <code>dplyr</code> é uma das ferramentas mais populares e úteis para manipulação de dados no R. Ele fornece uma série de funções simples e poderosas para filtrar, agrupar, modificar e resumir dados. Neste tutorial, vamos explorar algumas dessas funções e ver como elas podem ser usadas para realizar tarefas comuns de manipulação de dados.</p>
<p>Agora, vamos ver algumas das funções mais úteis do dplyr:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 18%">
<col style="width: 65%">
</colgroup>
<thead>
<tr class="header">
<th>Nome da Função</th>
<th>Tradução</th>
<th>O que faz</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>rename</code></td>
<td>Renomear</td>
<td>Modifica o nome das colunas.</td>
</tr>
<tr class="even">
<td><code>select</code></td>
<td>Selecionar</td>
<td>Seleciona as colunas.</td>
</tr>
<tr class="odd">
<td><code>filter</code></td>
<td>Filtrar</td>
<td>Filtra/seleciona as linhas segundo alguma condição.</td>
</tr>
<tr class="even">
<td><code>arrange</code></td>
<td>Arranjar/ordenar</td>
<td>Ordena as linhas (crescente/decrescente) segundo alguma variável.</td>
</tr>
<tr class="odd">
<td><code>mutate</code></td>
<td>Mutar/transformar</td>
<td>Cria uma nova coluna a partir de outras colunas ou dados.</td>
</tr>
<tr class="even">
<td><code>summarise</code></td>
<td>Sumarizar/resumir</td>
<td>Aplica alguma função sobre as linhas. Cria uma tabela “resumo”.</td>
</tr>
<tr class="odd">
<td><code>group by</code></td>
<td>Agrupar</td>
<td>Agrupa as linhas segundo alguma variável.</td>
</tr>
</tbody>
</table>
<p>As funções <code>rename</code>, <code>mutate</code>, <code>select</code> e <code>filter</code> são utilizadas para preparar e limpar os dados, enquanto as funções <code>group_by</code> e <code>summarise</code> são utilizadas para transformar/resumir os dados. Estas são as seis principais funções do pacote e veremos cada uma delas em maior detalhes.</p>
<p>Para praticar as funções vamos utilizar uma tabela que traz informações sobre as cidades do Brasil.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>tbl <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"..."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="rename" class="level2">
<h2 class="anchored" data-anchor-id="rename">rename</h2>
<p>Para renomear as colunas de <code>data.frame</code> usa-se a função <code>rename</code> (renomear) com <code>rename(tbl, novo_nome = velho_nome)</code>. Vale lembrar que para checar os nomes da tabela usa-se <code>names(tbl)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Renomear colunas</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>tbl_renamed <span class="ot">&lt;-</span> <span class="fu">rename</span>(tbl, <span class="at">codigo_municipio =</span> code_muni, <span class="at">pop =</span> population)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Os nomes das colunas de um <code>data.frame</code> devem</p>
<ol type="1">
<li>Ser únicos (não-duplicados) e evitar caracteres maiúsculos.</li>
<li>Não devem incluir caracteres especiais (e.g.&nbsp;!*&amp;@%), nem começar com um número ou caractere especial.</li>
<li>Evitar espaços em branco, que devem ser substituídos por <code>_</code> ou omitidos (e.g.&nbsp;<code>PIB Agro</code> deve ser reescrito como <code>pibAgro</code> ou <code>pib_agro</code>.</li>
</ol>
<p>Também é possível renomear colunas com auxílio de um vetor ou lista e usando ou <code>all_of</code> (todos) ou <code>any_of</code> (algum/alguns). O exemplo abaixo mostra a lógica geral: temos um vetor que indica o novo nome e o antigo nome de cada coluna que se quer trocar. Caso se queira trocar exatamente todos os nomes indicados no vetor usa-se <code>all_of</code> (mais rigoroso), caso se queira trocar todos os nomes indicados no vetor, ignorando os casos que não batem com nomes de colunas existentes, usa-se <code>any_of</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>new_names <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"codigo_municipio"</span> <span class="ot">=</span> <span class="st">"code_muni"</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pop"</span> <span class="ot">=</span> <span class="st">"population"</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pop_rate"</span> <span class="ot">=</span> <span class="st">"population_growth_rate"</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>tbl_renamed <span class="ot">&lt;-</span> <span class="fu">rename</span>(tbl, <span class="fu">all_of</span>(new_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>No exemplo abaixo incluo uma “nova coluna” chamada <code>unit</code> que desejo renomear para <code>unidade</code>. Usando <code>any_of</code> o retorno é exatamente igual ao caso acima, pois a função ignora a coluna inexistente <code>unit</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>new_names <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"codigo_municipio"</span> <span class="ot">=</span> <span class="st">"code_muni"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pop"</span> <span class="ot">=</span> <span class="st">"population"</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pop_rate"</span> <span class="ot">=</span> <span class="st">"population_growth_rate"</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"unidade"</span> <span class="ot">=</span> <span class="st">"unit"</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>tbl_renamed <span class="ot">&lt;-</span> <span class="fu">rename</span>(tbl, <span class="fu">any_of</span>(new_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Já a função <code>all_of</code> é mais rigorosa e retorna um erro indicando que a coluna <code>unit</code> não existe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tbl_renamed <span class="ot">&lt;-</span> <span class="fu">rename</span>(tbl, <span class="fu">all_of</span>(new_names))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>O uso de um vetor externo para renomear colunas é conveniente não somente porque permite melhor organizar o código; na prática, este vetor externo funciona como um <strong>dicionário de variáveis</strong> que pode ser inclusive utilizado para tratar várias bases de dados ou mesmo em outros códigos. Além disso, tratar o nome das colunas como strings é útil pois nos permite transformar este dado mais facilmente.</p>
<p>Por fim, pode-se aplicar uma função para renomear as colunas usando <code>rename_with</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>tbl_renamed <span class="ot">&lt;-</span> <span class="fu">rename_with</span>(tbl, toupper)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tbl_renamed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Uma dica final para rapidamente renomear colunas é a função <code>janitor::clean_names</code> que obedece aos três princípios elencados acima. Ela pode ser utilizada diretamente num <code>data.frame</code> como se vê no exemplo abaixo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>test_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">6</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(test_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"firstName"</span>, <span class="st">"ábc@!*"</span>, <span class="st">"% successful (2009)"</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"REPEAT VALUE"</span>, <span class="st">"REPEAT VALUE"</span>, <span class="st">""</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>janitor<span class="sc">::</span><span class="fu">clean_names</span>(test_df)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   first_name abc percent_successful_2009 repeat_value repeat_value_2  x</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1         NA  NA                      NA           NA             NA NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="select" class="level2">
<h2 class="anchored" data-anchor-id="select">select</h2>
<p>A função <code>select</code> serve para selecionar colunas num <code>data.frame</code>, permitindo-se trabalhar com uma versão menor dos dados. Similarmente à função <code>rename</code> é possível selecionar colunas diretamente <code>select(tbl, coluna_1, coluna_2, …)</code> ou selecionando os nomes via um vetor de strings com auxílio de <code>any_of</code> of <code>all_of</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona diretamente as colunas</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, code_muni, pib, pib_agriculture)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Cria um vetor de nomes</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>colunas <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"code_muni"</span>, <span class="st">"pib"</span>, <span class="st">"pib_agriculture"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona as colunas baseado no vetor</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, <span class="fu">all_of</span>(colunas))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>sel_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para remover uma coluna, basta usar o sinal de menos na frente do nome.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona diretamente as colunas</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, <span class="sc">-</span>pib, <span class="sc">-</span>city_area, <span class="sc">-</span>population_density)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Cria um vetor de nomes</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>colunas <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pib"</span>, <span class="st">"city_area"</span>, <span class="st">"population_density"</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona as colunas baseado no vetor</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, <span class="sc">-</span><span class="fu">all_of</span>(colunas))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>sel_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pode-se também selecionar várias colunas ao mesmo tempo se elas estiverem em sequência (uma ao lado da outra). O código abaixo, por exemplo, seleciona a coluna <code>code_muni</code> e todas as colunas entre <code>pib</code> e <code>pib_added_value</code> (inclusive).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, code_muni, pib<span class="sc">:</span>pib_added_value)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>sel_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Também é possível renomear e selecionar ao mesmo tempo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, <span class="at">codigo_municipio =</span> code_muni, pib)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>sel_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Por fim, existem algumas funções auxiliares que facilitam a seleção de múltiplas colunas. Vou apresentar apenas três destas funções:</p>
<ul>
<li><p><code>starts_with</code>/<code>ends_with</code> - selecionam colunas que começam ou terminam com determindo string.</p></li>
<li><p><code>where</code> - seleciona colunas de uma determinada classe (<code>numeric</code>, <code>factor</code>, etc.)</p></li>
<li><p><code>matches</code> - seleciona colunas com base num <em>match</em>, usando regex. Esta função é mais geral e engloba as duas primeiras.</p></li>
</ul>
<p>O código abaixo mostra alguns exemplos simples. Vou omitir as saídas do código, max experimente reproduzir o resultado.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona code_muni mais as colunas que começam com 'pib'</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, code_muni, <span class="fu">starts_with</span>(<span class="st">"pib"</span>))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona as colunas que terminam com 'muni'</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, <span class="fu">ends_with</span>(<span class="st">"muni"</span>))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona code_muni mais as colunas que contêm números</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, code_muni, <span class="fu">where</span>(is.numeric))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona as colunas que tem o padrão '_texto_'</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, <span class="fu">matches</span>(<span class="st">"_[a-z].+_"</span>))</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Selciona todas as colunas que começam com 'pib'</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, <span class="fu">matches</span>(<span class="st">"^pib"</span>))</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona todas as colunas que terminam com 'muni'</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, <span class="fu">matches</span>(<span class="st">"muni$"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="filter" class="level2">
<h2 class="anchored" data-anchor-id="filter">filter</h2>
<p>A função <code>filter</code> serve para filtrar as linhas de um <code>data.frame</code> segundo alguma condição lógica.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>filtered_tbl <span class="ot">&lt;-</span> <span class="fu">filter</span>(tbl, population_growth <span class="sc">&lt;</span> <span class="dv">0</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>filtered_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Os principais opereadores lógicos no R:</p>
<ul>
<li><p>“Maior que”, “Menor que”: <code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code></p></li>
<li><p>E/ou: <code>&amp;</code>, <code>|</code></p></li>
<li><p>“Negação”: <code>!</code></p></li>
<li><p>“Igual a”: <code>==</code></p></li>
<li><p>“Dentro de”: <code>%in%</code></p></li>
</ul>
<p>Existem alguns outros operadores, mas estes costumam resolver 95% dos casos. O exemplo abaixo mostra como filtrar linhas baseado num string. Note que quando se usa múltiplos strings é preciso usar o <code>%in%</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, name_muni <span class="sc">==</span> <span class="st">"São Paulo"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, name_muni <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"São Paulo"</span>, <span class="st">"Rio de Janeiro"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para negar a igualdade, basta usar o operador <code>!</code>. No caso do operador <code>%in%</code> há duas maneiras válidas de negá-lo: pode-se colocar o ! no começo da expressão ou colocar a expressão inteira dentro de um parêntesis. Eu tendo a preferir a segunda sintaxe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Remove todas as cidades da região Sudeste</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, name_region <span class="sc">!=</span> <span class="st">"Sudeste"</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Remove todas as cidades das regiões Sudeste e Norte</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, <span class="sc">!</span>name_region <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sudeste"</span>, <span class="st">"Norte"</span>))</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Remove todas as cidades das regiões Sudeste e Norte</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, <span class="sc">!</span>(name_region <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sudeste"</span>, <span class="st">"Norte"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Em geral, não é preciso utilizar o E (<code>&amp;</code>), já que pode-se colocar várias condições lógicas dentro de uma mesma chamada para função <code>filter</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  tbl,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  name_region <span class="sc">==</span> <span class="st">"Nordeste"</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span>(name_state <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Pernambuco"</span>, <span class="st">"Piauí"</span>)),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span>(name_muni <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Natal"</span>, <span class="st">"Fortaleza"</span>, <span class="st">"Maceió"</span>))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>No caso de relações de grandeza, pode-se colocar um número absoluto, mas também pode-se usar alguma função. No exemplo abaixo filtra-se apenas os municípios com PIB acima da média, por exemplo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, pib <span class="sc">&gt;</span> <span class="fu">mean</span>(pib))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, population <span class="sc">&gt;=</span> <span class="dv">1000000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="arrange" class="level2">
<h2 class="anchored" data-anchor-id="arrange">arrange</h2>
<p>A função <code>arrange</code> é talvez a mais simples e serve para rearranjar as linhas de um <code>data.frame</code>. Em geral, ela é utilizada mais para fins estéticos ou exploratórios, como para ordenar as cidades pelo maior PIB, ou menor população. Contudo, no caso de uma tabela que contenha séries de tempo, pode ser importante validar que as observações estão na ordem correta.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>tbl_arranged <span class="ot">&lt;-</span> <span class="fu">arrange</span>(tbl, pib)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>tbl_arranged</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>O padrão da função é de sempre ordenar de maneira crescente (do menor para o maior). Para inverter este comportamento pode-se usar a função <code>desc</code> ou o sinal de menos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Ordena as cidades por PIB em ordem decrescente (maior ao menor)</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(tbl, <span class="fu">desc</span>(pib))</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Ordena as cidades por PIB em ordem decrescente (maior ao menor)</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(tbl, <span class="sc">-</span>pib)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A função <code>arrange</code> ordena strings em ordem alfabética e Datas em ordem cronológica.</p>
</section>
<section id="mutate" class="level2">
<h2 class="anchored" data-anchor-id="mutate">mutate</h2>
<p>A função <code>mutate</code> cria novas colunas. Em geral, cria-se uma nova coluna com base nas colunas pré-existentes, mas a expressão é bastante geral na forma <code>mutate(tbl, nova_coluna = …)</code>. Novamente, vou omitir as saídas para poupar espaço.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Cria uma coluna onde todas as entradas são iguais a 1</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="at">id =</span> <span class="dv">1</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Cria a coluna 'lpib' igual ao logaritmo natural do 'pib'</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="at">lpib =</span> <span class="fu">log</span>(pib))</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Cria a coluna hh igual a 'household' dividido por 1 milhão</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="at">hh =</span> household <span class="sc">/</span> <span class="fl">1e6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Um fato conveniente da função <code>mutate</code> é que ela vai criando as colunas sequencialmente, assim é possível fazer diversas transformações numa mesma chamada à função. No caso abaixo, pode-se criar a variável <code>lpibpc</code> a partir das colunas <code>lpib</code> e <code>lpop</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl,</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">lpib =</span> <span class="fu">log</span>(pib),</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">lpop =</span> <span class="fu">log</span>(population),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Criando uma variável a partir de duas colunas criadas anteriormente</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">lpibpc =</span> lpib <span class="sc">-</span> lpop,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pibserv =</span> pib_services <span class="sc">+</span> pib_govmt_services,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">lpibs =</span> <span class="fu">log</span>(pibserv)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Por fim, é possível transformar múltiplas colunas simultaneamente usando a função <code>across</code> da seguinte maneira: <code>across(colunas, função)</code>. Para indicar quais colunas quer-se transformar podemos usar a mesma lógica da função <code>select</code>: isto é, declarando o nome das colunas, usando <code>col1:col2</code>, ou mesmo uma função como <code>starts_with</code>/<code>matches</code>, etc.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>tbl <span class="sc">|&gt;</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(pib<span class="sc">:</span>pib_services, log)) <span class="sc">|&gt;</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pib<span class="sc">:</span>pib_services)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Aplica uma transformação log em todas as colunas entre pib e pib_services</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="fu">across</span>(pib<span class="sc">:</span>pib_services, log))</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Aplica uma transformação log em todas as colunas que começam com pib</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"pib"</span>), log))</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Divide por pib e multiplica por 100 todas as colunas entre pib_taxes e</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; pib_govmt_services</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="fu">across</span>(pib_taxes<span class="sc">:</span>pib_govmt_services, <span class="sc">~</span>.x <span class="sc">/</span> pib <span class="sc">*</span> <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="summarise-e-group_by" class="level2">
<h2 class="anchored" data-anchor-id="summarise-e-group_by">summarise e group_by</h2>
<section id="uso-básico" class="level3">
<h3 class="anchored" data-anchor-id="uso-básico">Uso básico</h3>
<p>As funções <code>summarise</code><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> e <code>group_by</code> são (quase) sempre utilizadas em conjunto e servem para resumir ou “sumarizar” os dados. A função <code>group_by</code> agrupa os dados segundo alguma coluna. No caso da nossa base de cidades, poderíamos agrupar os dados por estado ou região, por exemplo. A função <code>summarise</code> aplica transformações nestes dados agrupados: pode-se, por exemplo, calcular a população total de cada estado, o PIB per capita médio de cada região, etc.</p>
<p>A tabela abaixo calcula a população total de cada região e ordena os dados, de maneira decrescente, segundo a população. A partir de agora começo a usar mais o pipe nos códigos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>tbl <span class="sc">|&gt;</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Agrupa por região</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_region) <span class="sc">|&gt;</span> </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Soma o total da população (dentro de cada região)</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">pop =</span> <span class="fu">sum</span>(population)) <span class="sc">|&gt;</span> </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Rearranja o resultado final</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(pop))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="um-pouco-mais-de-group_by" class="level3">
<h3 class="anchored" data-anchor-id="um-pouco-mais-de-group_by">Um pouco mais de <code>group_by</code></h3>
<p>A função <code>group_by</code> agrupa os dados de um <code>tibble</code> e permite que se faça operações sobre estes grupos. Pode-se, por exemplo, calcular o share da população de cada cidade, dentro do seu estado usando <code>mutate</code>. No caso abaixo, eu calculo o share percentual e mostro o resultado para a capital paulista. Vê-se que a capital tem cerca de 11,45 milhão de habitantes, equivalente a 25,78% da população do estado.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>tbl_share_pop <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_state) <span class="sc">|&gt;</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pop_share =</span> population <span class="sc">/</span> <span class="fu">sum</span>(population) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>tbl_share_pop <span class="sc">|&gt;</span> </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(name_muni <span class="sc">==</span> <span class="st">"São Paulo"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name_muni, population, pop_share)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similarmente, pode-se combinar outras funções como <code>filter</code>. O código abaixo filtra somente as cidades que possuem população acima da média do seu estado. Vale comparar os resultados e entender as diferenças entre cada uma das tabelas</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Filtra cidades que possuem população acima da média do seu estado</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>tbl_pop_grouped <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_state) <span class="sc">|&gt;</span> </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(population <span class="sc">&gt;</span> <span class="fu">mean</span>(population))</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Filtra cidades que possuem população acima da média do país</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>tbl_pop_ungrouped <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(population <span class="sc">&gt;</span> <span class="fu">mean</span>(population))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="um-pouco-mais-de-summarise" class="level3">
<h3 class="anchored" data-anchor-id="um-pouco-mais-de-summarise">Um pouco mais de <code>summarise</code></h3>
<p>É possível fazer várias novas colunas num mesmo <code>summarise</code>. Assim como em <code>mutate</code> também é possível fazer transformações com colunas que foram criadas anteriormente na mesma função. No caso abaixo eu calculo o PIB e população totais de cada estado do nordeste e depois calculo o PIB per capita baseado nestes valores agregados.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>tbl <span class="sc">|&gt;</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(name_region <span class="sc">==</span> <span class="st">"Nordeste"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_state) <span class="sc">|&gt;</span> </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pib_uf =</span> <span class="fu">sum</span>(pib) <span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_uf =</span> <span class="fu">sum</span>(population),</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pibpc_uf =</span> pib_uf <span class="sc">/</span> pop_uf</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(pibpc_uf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A função <code>summarise</code> é bastante potente. O exemplo abaixo filtra as cidades de médio-grande porte (acima de 100.000 habitantes), agrupa os dados por estado e faz:</p>
<ul>
<li><p>O total (soma) da população (cidades com mais de 100.000 habitantes, por estado).</p></li>
<li><p>Calcula a média da população (entre as cidades com mais de 100.000 habitantes, por estado).</p></li>
<li><p>Calcula a população máxima (idem).</p></li>
<li><p>Calcula os quintis da distribuição da população (idem).</p></li>
<li><p>Faz uma regressão linear entre a população e o PIB (idem).</p></li>
<li><p>Faz uma regressão linear entre a população e o PIB e extrai o R2 (idem).</p></li>
<li><p>Conta o número de cidades (idem).</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>tbl_summary <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(population <span class="sc">&gt;</span> <span class="dv">100000</span>) <span class="sc">|&gt;</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_state) <span class="sc">|&gt;</span> </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_uf =</span> <span class="fu">sum</span>(population),</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_avg =</span> <span class="fu">mean</span>(population),</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_max =</span> <span class="fu">max</span>(population),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_ntile =</span> <span class="fu">list</span>(<span class="fu">quantile</span>(population, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span>))),</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">reg =</span> <span class="fu">list</span>(<span class="fu">lm</span>(population <span class="sc">~</span> pib)),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">reg_r2 =</span> <span class="fu">summary</span>(<span class="fu">lm</span>(population <span class="sc">~</span> pib))<span class="sc">$</span>r.squared,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">count =</span> <span class="fu">n</span>()</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(count))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Nem tudo o que fiz acima faz muito sentido, mas ilustra a capacidade da função <code>summarise</code> de gerar informação e a flexibilidade de um <code>tibble</code> para armazenar diferentes tipos de output. Note que as funções foram todas executadas dentro dos respectivos grupos.</p>
<p>No código abaixo pode-se verificar os quintis da população das cidades de Minas Gerais.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>tbl_summary <span class="sc">|&gt;</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(name_state <span class="sc">==</span> <span class="st">"Minas Gerais"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(pop_ntile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Já no código abaixo pode-se verificar o resultado da regressão entre população e PIB feita somente nos municípios grandes de São Paulo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>reg_sp <span class="ot">&lt;-</span> <span class="fu">filter</span>(tbl_summary, name_state <span class="sc">==</span> <span class="st">"São Paulo"</span>)[[<span class="st">"reg"</span>]]</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>reg_sp <span class="ot">&lt;-</span> reg_sp[[<span class="dv">1</span>]]</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(reg_sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="adendos-técnicos" class="level3">
<h3 class="anchored" data-anchor-id="adendos-técnicos">Adendos técnicos</h3>
<p>Vale notar que a função <code>group_by</code> trasnforma um <code>tibble</code> num <code>grouped_df</code>. Para desfazer esta transformação é preciso usar <code>ungroup</code>. De fato, é uma boa prática sempre utilizar <code>ungroup</code> depois de usar um <code>group_by</code>. Por exemplo, no caso em que se calcula o share percentual da população de cada município em seu respectivo estado, é importante desagrupar os dados.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>tbl_share_pop <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_state) <span class="sc">|&gt;</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pop_share =</span> population <span class="sc">/</span> <span class="fu">sum</span>(population) <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Esta prática serve para evitar erros potenciais e, infelizmente, é necessária em alguns casos, como quando se quer combinar duas bases distintas. Atualmente, existe uma sintaxe experimental, fortemente inspirada na sintaxe do <code>data.table</code>, que desagrupa os dados por padrão. No caso do código abaixo não é preciso utilizar <code>ungroup()</code>.</p>
<p>Pessoalmente, gosto bastante desta sintaxe, mas como ela ainda está em fase experimental, é melhor esperar um pouco para utilizá-la.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>tbl_share_pop <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_share =</span> population <span class="sc">/</span> <span class="fu">sum</span>(population) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="st">"name_state"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Este mesmo <code>.by</code> pode ser utilizado dentro de <code>summarise</code>, <code>filter</code>, etc.</p>
</section>
</section>
</section>
<section id="formato-dos-dados" class="level1">
<h1>Formato dos dados</h1>
<p>O princípio geral da formatação dos dados, dentro do <code>tidyverse</code>, segue a lógica exposta em Wickham (2014):</p>
<ol type="1">
<li>Toda variável é uma coluna.</li>
<li>Cada observação é uma linha.</li>
<li>Todo tipo de “unidade observacional” é uma tabela única.</li>
</ol>
<p>Vale adicionar que o nome da coluna deve ser o nome de uma <em>variável</em> e não de um <em>valor</em>.</p>
<p>É importante frisar este ponto: uma tabela é uma coleção organizada de <strong>valores</strong> (números ou texto). Cada <em>valor</em> pertence a uma <em>única variável e uma única observação</em>. Por exemplo: 171 é a altura (variável) de João (observação) em centímetros. Uma <strong>variável</strong> contém todos os valores que mensuram o mesmo atributo (e.g.&nbsp;altura, peso, IMC, etc.). Uma <strong>observação</strong> contém todos os valores mensurados no mesmo sujeito/objeto (e.g.&nbsp;um indivíduo, um dia específico, uma rodada de um experimento, etc.).</p>
<section id="contra-exemplos" class="level2">
<h2 class="anchored" data-anchor-id="contra-exemplos">Contra-exemplos</h2>
<p>Vamos começar explorando alguns contra-exemplos de dados que não estão em formato “tidy”.</p>
<section id="vendas-de-casas-e-apartamentos" class="level3">
<h3 class="anchored" data-anchor-id="vendas-de-casas-e-apartamentos">Vendas de casas e apartamentos</h3>
<p>A tabela abaixo segue um formato tipicamente encontrando em planilhas de Excel. A primeira coluna define: (vendas de) apartamentos, casas e o total. Cada coluna subsequente representa um mês diferente; os valores de cada linha representam o número de vendas de cada tipo em cada mês.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">nome =</span> <span class="fu">c</span>(<span class="st">"Apartamentos"</span>, <span class="st">"Casas"</span>, <span class="st">"Total"</span>),</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-01</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">900</span>, <span class="dv">100</span>, <span class="dv">1000</span>),</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-02</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">850</span>, <span class="dv">120</span>, <span class="dv">970</span>),</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-03</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">875</span>, <span class="dv">125</span>, <span class="dv">1000</span>),</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-04</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">920</span>, <span class="dv">100</span>, <span class="dv">1020</span>),</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>dat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note que:</p>
<ol type="1">
<li><p>Cada coluna não é uma variável. A maior parte das colunas são datas, que deveriam estar todas numa única coluna.</p></li>
<li><p>Cada linha não é uma observação. Cada linha é uma série de valores de observações que varia mês a mês.</p></li>
</ol>
</section>
<section id="vendas-e-alugueis-de-apartamentos-e-casas" class="level3">
<h3 class="anchored" data-anchor-id="vendas-e-alugueis-de-apartamentos-e-casas">Vendas e Alugueis de apartamentos e casas</h3>
<p>Esta segunda tabela é uma versão piorada da versão acima.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>dat2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">nome =</span> <span class="fu">c</span>(<span class="st">"Apartamentos"</span>, <span class="st">"Casas"</span>, <span class="st">"Total"</span>, <span class="st">"Apartamentos"</span>, <span class="st">"Casas"</span>, <span class="st">"Total"</span>),</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">tipo =</span> <span class="fu">c</span>(<span class="st">"Venda"</span>, <span class="st">"Venda"</span>, <span class="st">"Venda"</span>, <span class="st">"Aluguel"</span>, <span class="st">"Aluguel"</span>, <span class="st">"Aluguel"</span>),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-01</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">900</span>, <span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-02</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">850</span>, <span class="dv">120</span>, <span class="dv">970</span>, <span class="dv">60</span>, <span class="dv">80</span>, <span class="dv">140</span>),</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-03</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">875</span>, <span class="dv">125</span>, <span class="dv">1000</span>, <span class="dv">70</span>, <span class="dv">90</span>, <span class="dv">160</span>),</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-04</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">920</span>, <span class="dv">100</span>, <span class="dv">1020</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">100</span>),</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>dat2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note que:</p>
<ol type="1">
<li>O nome das colunas mistura variáveis e valores.</li>
<li>A linha continua não sendo uma observação.</li>
</ol>
</section>
<section id="teste-ab" class="level3">
<h3 class="anchored" data-anchor-id="teste-ab">Teste AB</h3>
<p>A tabela abaixo mostra um teste AB num formato (bem) problemático. No experimento, Bernardo e Álvares estão no grupo de tratamento, enquanto Fernando e Ricardo estão no grupo controle.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>dat3 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="fu">c</span>(<span class="st">"Bernardo"</span>, <span class="st">"Álvares"</span>, <span class="st">"Fernando"</span>, <span class="st">"Ricardo"</span>),</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">controle =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">7.2</span>, <span class="fl">5.1</span>),</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tratamento =</span> <span class="fu">c</span>(<span class="fl">6.4</span>, <span class="fl">5.5</span>, <span class="cn">NA</span>, <span class="cn">NA</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>dat3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note que:</p>
<ol type="1">
<li>Nem ‘controle’ e nem ‘tratamento’ são variáveis, já que são valores de uma mesma variável “qual grupo que está o indivíduo”.</li>
</ol>
<p>Alternativamente, pode-se ter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>dat31 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">grupo =</span> <span class="fu">c</span>(<span class="st">"controle"</span>, <span class="st">"tratamento"</span>),</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Bernardo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fl">6.4</span>),</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Álvares</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fl">5.5</span>),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Fernando</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">7.2</span>, <span class="cn">NA</span>),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Ricardo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">5.1</span>, <span class="cn">NA</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>dat31</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Agora ‘controle’ e ‘tratamento’ estão corretamente dentro de uma mesma coluna, mas cada coluna representa um indivíduo diferente e não uma variável. “Bernardo” não é uma variável e sim um valor (nome do indivíduo).</p>
</section>
<section id="cidades" class="level3">
<h3 class="anchored" data-anchor-id="cidades">Cidades</h3>
<p>A tabela abaixo mostra dados hipóteticos de PIB e população de duas cidades.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>dat4 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">nome_cidade =</span> <span class="fu">c</span>(<span class="st">"São Paulo"</span>, <span class="st">"Porto Alegre"</span>),</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pib_2020 =</span> <span class="fu">c</span>(<span class="dv">1000</span>, <span class="dv">500</span>),</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pib_2021 =</span> <span class="fu">c</span>(<span class="dv">1200</span>, <span class="dv">700</span>),</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop_2020 =</span> <span class="fu">c</span>(<span class="dv">1100</span>, <span class="dv">110</span>),</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop_2021 =</span> <span class="fu">c</span>(<span class="dv">1200</span>, <span class="dv">120</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>dat4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note que:</p>
<ol type="1">
<li>Há mais de uma variável por coluna: a coluna pib_2020 indica duas informações: o ano da observação e o que está sendo mensurado (PIB).</li>
</ol>
</section>
<section id="casas-e-apartamentos" class="level3">
<h3 class="anchored" data-anchor-id="casas-e-apartamentos">Casas e Apartamentos</h3>
<p>Nesta tabela o nome das colunas mistura variáveis e valores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">cidade =</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>),</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">financiado_apto_2020 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">vista_apto_2020 =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">permuta_casa_2020 =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">vista_casa_2020 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="organizando" class="level2">
<h2 class="anchored" data-anchor-id="organizando">Organizando</h2>
<p>Sendo bastante franco, acho difícil explicar a intuição por trás das funções <code>pivot_longer</code> e <code>pivot_wider</code>. No caso da primeira função tem-se:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> ...,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#&gt; Argumentos opcionais</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"name"</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>onde <code>cols</code> indica quais colunas devem ser convertidas em formato longitudinal. Este argumento é bastante flexível e segue as mesmas regras da função <code>select</code>. Por exemplo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>date)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"pib"</span>))</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"x1"</span>, <span class="st">"x2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Já a função <code>pivot_wider</code> é mais exigente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> ...,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> ...,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> ...</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>O primeiro argumento indica qual coluna identifica unicamente os valores; o segundo argumento indica quais valores devem ser convertidos em colunas (variáveis); o terceiro argumento indica quais valores devem ser convertido em valores (sim, é isto mesmo). A função “desfaz” o que a <code>pivot_longer</code> “faz”, mas também pode fazer novas tabelas e também condensar informação. Pra piorar a situação, ambas as funções tem vários argumentos opcionais, que muitas vezes são super úteis.</p>
<p>Como num jogo, explicar as regras em voz-alta parece torná-lo mais complicado do que é. A melhor dica que posso dar é que se pratique bastante. Alternativamente, considere também as funções:</p>
<ul>
<li><code>data.table::melt</code> ou <code>reshape2::melt</code>. É preciso escolher as colunas “identificadoras” e as colunas de “mensuração”. Eu penso no “id” como o que identifica unicamente cada linha e “measure” como o que identifica o que está sendo mensurado. Por exemplo: na tabela abaixo temos o preços de duas ações em dois dias distintos.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">c</span>(<span class="fu">as.Date</span>(<span class="st">"2023-05-04"</span>), <span class="fu">as.Date</span>(<span class="st">"2023-05-05"</span>)),</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">PETR4 =</span> <span class="fu">c</span>(<span class="fl">23.02</span>, <span class="dv">24</span>),</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">CYRE3 =</span> <span class="fu">c</span>(<span class="fl">15.54</span>, <span class="fl">15.97</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>tab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para converter em formato “tidy” ou longitudinal, declara-se quais as colunas identificam a observação e quais as colunas indicam o que está sendo mensurado.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>reshape2<span class="sc">::</span><span class="fu">melt</span>(tab, <span class="at">id.vars =</span> <span class="st">"data"</span>, <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">"PETR4"</span>, <span class="st">"CYRE3"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Neste caso particular, é útil saber que o argumento <code>measure.vars</code> pode ser omitido</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>reshape2<span class="sc">::</span><span class="fu">melt</span>(tab, <span class="at">id.vars =</span> <span class="st">"data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>O contrário destas funções é <code>data.table::dcast</code> ou <code>reshape2::dcast</code>, cuja sintaxe é um pouco mais estranha, mas bastante intuitiva.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>long <span class="ot">&lt;-</span> reshape2<span class="sc">::</span><span class="fu">melt</span>(tab, <span class="at">id.vars =</span> <span class="st">"data"</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>reshape2<span class="sc">::</span><span class="fu">dcast</span>(long, data <span class="sc">~</span> variable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>tidyr::gather</code> que é a versão antiga de <code>pivot_longer</code>. Pessoalmente, sempre achei esta função bastante confusa, mas, ela talvez seja mais intuitiva para você.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gather</span>(tab, <span class="st">"ticker"</span>, <span class="st">"price"</span>, <span class="sc">-</span>data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>long <span class="ot">&lt;-</span> <span class="fu">gather</span>(tab, <span class="st">"ticker"</span>, <span class="st">"price"</span>, <span class="sc">-</span>data)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">spread</span>(long, <span class="st">"ticker"</span>, <span class="st">"price"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Neste caso simples, o par <code>gather</code>/<code>spread</code> parece bastante conveniente, mas em casos mais complexos esta sintaxe limitada torna-se bastante problemática.</p>
<section id="exemplo-1" class="level3">
<h3 class="anchored" data-anchor-id="exemplo-1">Exemplo 1</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>dat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Este caso é bem simples, pois todas as colunas, exceto a primeira, são uma única variável (as datas do mês). A função <code>rename</code> é usada somente para deixar mais evidente que a primeira coluna contém a tipologia do que foi vendido. O argumento <code>values_to</code> também é opcional.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tipologia =</span> nome) <span class="sc">|&gt;</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>tipologia, <span class="at">names_to =</span> <span class="st">"data"</span>, <span class="at">values_to =</span> <span class="st">"unidades"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note que agora:</p>
<ol type="1">
<li>Cada linha é uma observação: 900 é o valor de apartamentos vendidos em 2022-01.</li>
<li>Cada coluna é uma variável: a primeira coluna define a ‘tipologia’, a segunda coluna define a ‘data’ e a terceira coluna é o número de ‘unidades’.</li>
</ol>
<p>Por fim, para ser mais completo pode-se converter a data num formato padrão.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tipologia =</span> nome) <span class="sc">|&gt;</span> </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>tipologia, <span class="at">names_to =</span> <span class="st">"data"</span>, <span class="at">values_to =</span> <span class="st">"unidades"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> readr<span class="sc">::</span><span class="fu">parse_date</span>(data, <span class="at">format =</span> <span class="st">"%Y-%m"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exemplo-2" class="level3">
<h3 class="anchored" data-anchor-id="exemplo-2">Exemplo 2</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>dat2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>O segundo exemplo é quase idêntico ao primeiro.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>dat2 <span class="sc">|&gt;</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tipologia =</span> nome, <span class="at">mercado =</span> tipo) <span class="sc">|&gt;</span> </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(tipologia, mercado),</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"data"</span>,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"unidades"</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">24</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exemplo-3" class="level3">
<h3 class="anchored" data-anchor-id="exemplo-3">Exemplo 3</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>dat3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>dat3 <span class="sc">|&gt;</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>id, <span class="at">names_to =</span> <span class="st">"grupo"</span>, <span class="at">values_to =</span> <span class="st">"valor"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exemplo-4" class="level3">
<h3 class="anchored" data-anchor-id="exemplo-4">Exemplo 4</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>dat4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Neste exemplo pode-se separar as colunas facilmente usando <code>names_sep</code> e <code>names_to</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>dat4 <span class="sc">|&gt;</span> </span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span>nome_cidade,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">"_"</span>,</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"variavel"</span>, <span class="st">"ano"</span>),</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"valor"</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exemplo-5" class="level3">
<h3 class="anchored" data-anchor-id="exemplo-5">Exemplo 5</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Confesso que só coloquei este exemplo aqui para mostrar que é possível usar dois <code>pivot_longer</code> em sequência para chegar num resultado útil.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span>cidade,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">"_"</span>,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>, <span class="st">"tipologia"</span>, <span class="st">"ano"</span>)</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> financiado<span class="sc">:</span>permuta,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"forma_pagamento"</span>,</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"unidades"</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="referências-e-comentários" class="level1">
<h1>Referências e Comentários</h1>
<ul>
<li><p><a href="https://r4ds.hadley.nz">Wickham, H. Centinkaya-Rundel, M. Grolemund, G. R for Data Science. 2ed.</a> - Uma introdução didática ao tidyverse com aplicações para ciências de dados.</p></li>
<li><p><a href="https://www.tidyverse.org/blog/2023/08/teach-tidyverse-23/">Centinkaya-Rundel, M. Teaching the tidyverse in 2023</a> - Uma visão geral de como ensinar o <code>tidyverse</code> na sua versão mais atual. Discute um pouco dos desafios de ensinar tantos pacotes e funções.</p></li>
<li><p><a href="https://www.jstatsoft.org/article/view/v059i10">Wickham, H. Tidy Data. Journal of Statistical Software. 2014.</a> - Artigo seminal com o conceito de tidy. Este artigo foi acompanhado dos pacotes <code>plyr</code> e <code>reshape2</code> que foram os embriões do <code>dplyr</code> e <code>tidyr</code>.</p></li>
</ul>
<p>Como comentei no texto, a popularidade do <code>tidyverse</code> criou um certo consenso de que esta é a melhor forma de começar a aprender R. Ainda assim, acho que vale a pena considerar alguns dos contra-argumentos:</p>
<ul>
<li><p><a href="https://github.com/matloff/TidyverseSkeptic">Matloff, N. Teach Base-R, Not Just the Tidyverse</a> - Um famoso argumento contra o ensino do <code>tidyverse</code>. Essencialmente, argumenta-se que o tidyverse além de ser bastante complexo, esconde alguns aspectos fundamentais do R como vetores e operadores <code>$</code>, o que dificulta o aprendizado da linguagem.</p></li>
<li><p><a href="https://matloff.wordpress.com/2022/04/02/greatly-revised-edition-of-tidyverse-skeptic/">Matloff, N. Greatly Revised Edition of Tidyverse Skeptic</a> - Atualização do texto anterior.</p></li>
<li><p><a href="https://blog.ephorie.de/why-i-dont-use-the-tidyverse">Why I don’t use the Tidyverse</a></p></li>
</ul>


<!-- -->

</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Para saber mais sobre pipes e a diferença entre o novo pipe nativo <code>|&gt;</code> e o pipe <code>%&gt;%</code> do <code>magrittr</code> veja meu post sobre o assunto.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>No fundo, isto é ainda mais um incentivo para aprender inglês.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>A classe mais geral de números do R é a <code>numeric</code>. Aqui, “double” faz referência à precisão do número, que é um “double-precision value”, que equivale a uma precisão de 53 bits, com aplitude de <span class="math inline">\(2\times 10^{-308}\)</span> a <span class="math inline">\(2\times 10^{-308}\)</span>. Em geral, a maioria dos números (com exceção de inteiros) é armazenada desta forma.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>De fato, esta é a mesma sintaxe que se utiliza para extrair um elemento de uma lista. Isto acontece pois um <code>data.frame</code> é essencialmente, uma lista com um pouco mais de estrutura. Isto pode ser verificado usando <code>typeof</code> em um objeto <code>data.frame</code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>O <code>dplyr</code> também aceita a função <code>summarize</code> com ‘z’ ao invés de ‘s’. As funções são exatamente iguais e podem ser intercambiadas sem maiores problemas.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https::\/\/www\.restateinsight\.com");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb72" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Apêndice: manipular para enxergar"</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> '2023-07-07'</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> ['data-visualization', 'ggplot2', 'tutorial-R']</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Este post revisa as principais funções para manipulação de dados do Tidyverse. O material serve mais como referência e apoio ao tutorial de ggplot2 do que como introdução ao assunto."</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-align: center</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-asp: 0.618</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a><span class="an">freeze:</span><span class="co"> true</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include = FALSE}</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.align =</span> <span class="st">"center"</span>,</span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.asp =</span> <span class="fl">0.618</span>,</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.width =</span> <span class="dv">8</span>,</span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">out.width =</span> <span class="st">"80%"</span>,</span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.dev =</span> <span class="st">"svg"</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>print_table <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">|&gt;</span> </span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">align =</span> <span class="st">"c"</span>, <span class="at">digits =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(</span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">full_width =</span> <span class="cn">FALSE</span>,</span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"condensed"</span>, <span class="st">"responsive"</span>, <span class="st">"hover"</span>, <span class="st">"striped"</span>)</span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introdução</span></span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>Este tutorial, ao contrário da série "ggplot2: do básico ao intermediário" já assume que se tenha um entendimento razoável de <span class="in">`R`</span>. O material aqui serve mais para consultar/relembrar ou aprender um truque novo. Da maneira como está escrito, não é adequado para uma primeira leitura. Grosso modo, a referência aqui é Hadley (2017) capítulos 4, 5, 10-12.</span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a><span class="fu"># Limpeza de dados</span></span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a>O primeiro passo para montar uma visualização é ter os dados no formato certo. Em geral, isto envolve três etapas: (1) importar os dados no <span class="in">`R`</span>; (2) limpar os dados; e (3) transformar os dados no formato apropriado. Neste tutorial vamos focar sobretudo nas últimas duas etapas.</span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a>Dados tabulares são armazenados dentro de objetos chamados <span class="in">`data.frame`</span>. Todo gráfico de <span class="in">`ggplot`</span> começa com um (ou mais) <span class="in">`data.frame`</span>. Apesar de ser possível montar gráficos a partir de vetores de dados dispersos, recomendo fortemente que sempre se utilize dados dentro de <span class="in">`data.frame.`</span> Isto garante um código mais organizado e menos propenso a erros.</span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a>Apesar de funcionar como um repositório de pacotes, o <span class="in">`R`</span> já vem com diversas funções "de fábrica" que permitem a importação e manipulação de dados. Estas funções que já vem carregadas no <span class="in">`R`</span> são chamadas de funções "base" ou "base-R". Alguns pacotes foram criados para melhorar estas funções "base".</span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a><span class="fu">### Você tem um momento para falar sobre o `tidyverse`?</span></span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-58"><a href="#cb72-58" aria-hidden="true" tabindex="-1"></a>O <span class="in">`tidyverse`</span> é um metapacote, ele instala vários pacotes simultaneamente quando instalado e carrega múltiplos pacotes quando chamado. Estes pacotes formam uma família de pacotes que são unidos por uma filosofia e um objetivos comuns: todos os pacotes têm como objetivo a limpeza de dados e, de maneira geral, seguem o princípio de "tidy" data.</span>
<span id="cb72-59"><a href="#cb72-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-60"><a href="#cb72-60" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = FALSE}</span></span>
<span id="cb72-61"><a href="#cb72-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Instala o pacote tidyverse</span></span>
<span id="cb72-62"><a href="#cb72-62" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb72-63"><a href="#cb72-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Carrega o pacote tidyverse</span></span>
<span id="cb72-64"><a href="#cb72-64" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb72-65"><a href="#cb72-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-66"><a href="#cb72-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-67"><a href="#cb72-67" aria-hidden="true" tabindex="-1"></a>Todos os pacotes e funções que vamos utilizar serão carregados nesta única linha de código.</span>
<span id="cb72-68"><a href="#cb72-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-69"><a href="#cb72-69" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`readr`</span> - importação e exportação de dados.</span>
<span id="cb72-70"><a href="#cb72-70" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`dplyr`</span> - manipulação de dados.</span>
<span id="cb72-71"><a href="#cb72-71" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`tidyr`</span> - manipulação de dados.</span>
<span id="cb72-72"><a href="#cb72-72" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`stringr`</span> - manipulacao de strings (<span class="in">`character`</span>)</span>
<span id="cb72-73"><a href="#cb72-73" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`forcats`</span> - manipulacao de <span class="in">`factors`</span></span>
<span id="cb72-74"><a href="#cb72-74" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`lubridate`</span> - manipulação de datas (<span class="in">`Date`</span>)</span>
<span id="cb72-75"><a href="#cb72-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-76"><a href="#cb72-76" aria-hidden="true" tabindex="-1"></a>O <span class="in">`tidyverse`</span> inclui ainda mais pacotes, como <span class="in">`rvest`</span> para webscrapping, ou <span class="in">`dbplyr`</span> que permite utilizar comandos do <span class="in">`dplyr`</span> em databases.</span>
<span id="cb72-77"><a href="#cb72-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-78"><a href="#cb72-78" aria-hidden="true" tabindex="-1"></a><span class="fu">### A filosofia do `tidyverse`</span></span>
<span id="cb72-79"><a href="#cb72-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-80"><a href="#cb72-80" aria-hidden="true" tabindex="-1"></a>Numa primeira leitura, esta seção pode ser pulada sem grandes prejuízos; contudo, ela pode ser interessante numa segunda leitura ou para leitores que já tem alguma familiaridade com <span class="in">`tidyverse`</span>.</span>
<span id="cb72-81"><a href="#cb72-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-82"><a href="#cb72-82" aria-hidden="true" tabindex="-1"></a>A filosofia geral do <span class="in">`tidyverse`</span> toma muito emprestado da gramática. As funções têm nomes de verbos que costumam ser intuitivos e são encadeados via "pipes"<span class="ot">[^1]</span> que funcionam como conectivos numa frase. Em tese, isto torna o código mais legível e até mais didático. A tarefa de renomear colunas, criar variáveis e calcular uma média nos grupos torna-se "linear" no mesmo sentido em que uma frase com sujeito-verbo-objeto é linear.</span>
<span id="cb72-83"><a href="#cb72-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-84"><a href="#cb72-84" aria-hidden="true" tabindex="-1"></a><span class="ot">[^1]: </span>Para saber mais sobre pipes e a diferença entre o novo pipe nativo <span class="in">`|&gt;`</span> e o pipe <span class="in">`%&gt;%`</span> do <span class="in">`magrittr`</span> veja meu post sobre o assunto.</span>
<span id="cb72-85"><a href="#cb72-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-86"><a href="#cb72-86" aria-hidden="true" tabindex="-1"></a>O pipe, essencialmente, carrega o resultado de uma função adiante numa cadeia de comandos: <span class="in">`objeto |&gt; função1 |&gt; função2 |&gt; função3`</span>. Isto tem duas vantagens: primeiro, evita que você use funções compostas que são lidas "de dentro para fora" como <span class="in">`exp(mean(log(x)))`</span>; e, segundo, dispensa a criação de objetos intermediários "inúteis" que estão ali somente para segurar um valor que não vai ser utilizado mais adiante.</span>
<span id="cb72-87"><a href="#cb72-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-90"><a href="#cb72-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-91"><a href="#cb72-91" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-92"><a href="#cb72-92" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(AirPassengers) <span class="sc">~</span> <span class="fu">time</span>(AirPassengers))</span>
<span id="cb72-93"><a href="#cb72-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-94"><a href="#cb72-94" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Função composta</span></span>
<span id="cb72-95"><a href="#cb72-95" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">exp</span>(<span class="fu">fitted</span>(model)))</span>
<span id="cb72-96"><a href="#cb72-96" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Usando pipes</span></span>
<span id="cb72-97"><a href="#cb72-97" aria-hidden="true" tabindex="-1"></a>model <span class="sc">|&gt;</span> <span class="fu">fitted</span>() <span class="sc">|&gt;</span> <span class="fu">exp</span>() <span class="sc">|&gt;</span> <span class="fu">mean</span>()</span>
<span id="cb72-98"><a href="#cb72-98" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Usando objetos intermediários</span></span>
<span id="cb72-99"><a href="#cb72-99" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">fitted</span>(model)</span>
<span id="cb72-100"><a href="#cb72-100" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">exp</span>(x1)</span>
<span id="cb72-101"><a href="#cb72-101" aria-hidden="true" tabindex="-1"></a>x3 <span class="ot">&lt;-</span> <span class="fu">mean</span>(x2)</span>
<span id="cb72-102"><a href="#cb72-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-103"><a href="#cb72-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-104"><a href="#cb72-104" aria-hidden="true" tabindex="-1"></a>Há um tempo atrás argumentava-se contra o uso de "pipes", pois estes dificultavam a tarefa de encontrar bugs no código. Isto continua sendo parcialmente verdade, mas as funções do <span class="in">`tidyvserse`</span> atualmente têm mensagens de erro bastante ricas e permitem encontrar a fonte do erro com relativa facilidade. Ainda assim, não se recomenda encadear funções em excesso, i.e., pipes com 10 funções ou mais.</span>
<span id="cb72-105"><a href="#cb72-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-106"><a href="#cb72-106" aria-hidden="true" tabindex="-1"></a>Outra filosofia do <span class="in">`tidyverse`</span> é de que tarefas rotineiras devem ser transformadas em funções específicas. Neste sentido, os pacotes <span class="in">`dplyr`</span>, <span class="in">`tidyr`</span> e afins são recheados de funções, às vezes com nomes muito semelhantes e com usos redundantes. As funções <span class="in">`starts_with`</span> e <span class="in">`ends_with`</span>, por exemplo, são casos específicos da função <span class="in">`matches`</span>. Há funções que permitem até duas formas de grafia como <span class="in">`summarise`</span> e <span class="in">`summarize`</span>. Outras como <span class="in">`slice_min`</span> e <span class="in">`slice_max`</span> são convenientes mas são literalmente: <span class="in">`arrange + slice`</span>.</span>
<span id="cb72-107"><a href="#cb72-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-108"><a href="#cb72-108" aria-hidden="true" tabindex="-1"></a>Somando somente os dois principais pacotes, <span class="in">`dplyr`</span> e <span class="in">`tidyr`</span>, há 360 funções disponíveis. Contraste isto com o <span class="in">`data.table`</span> que permite fazer 95% das transformações de dados somente com <span class="in">`dt[i, j, by = c(), .SDcols = cols]`</span>.</span>
<span id="cb72-109"><a href="#cb72-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-110"><a href="#cb72-110" aria-hidden="true" tabindex="-1"></a>Mesmo as funções base do <span class="in">`R`</span> costumam ser mais sucintas do que códigos em <span class="in">`tidyverse`</span>. No exemplo abaixo, a função <span class="in">`tapply`</span> consegue o mesmo resultado que o código mais extenso feito com <span class="in">`dplyr`</span>.</span>
<span id="cb72-111"><a href="#cb72-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-114"><a href="#cb72-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-115"><a href="#cb72-115" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-116"><a href="#cb72-116" aria-hidden="true" tabindex="-1"></a><span class="fu">tapply</span>(mtcars<span class="sc">$</span>mpg, mtcars<span class="sc">$</span>cyl, mean)</span>
<span id="cb72-117"><a href="#cb72-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-118"><a href="#cb72-118" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">|&gt;</span> </span>
<span id="cb72-119"><a href="#cb72-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cyl) <span class="sc">|&gt;</span> </span>
<span id="cb72-120"><a href="#cb72-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">avg =</span> <span class="fu">mean</span>(cyl))</span>
<span id="cb72-121"><a href="#cb72-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-122"><a href="#cb72-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-123"><a href="#cb72-123" aria-hidden="true" tabindex="-1"></a>As vantagens do <span class="in">`tidyverse`</span> se tornam mais evidentes com o tempo. De fato, o pacote permite abstrações muito poderosas, e eventualmente, pode-se fazer um código centenas de vezes mais sucinto combinando as suas funções.</span>
<span id="cb72-124"><a href="#cb72-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-125"><a href="#cb72-125" aria-hidden="true" tabindex="-1"></a>O lado negativo disto tudo é que para não-falantes de inglês muitas destas "vantagens gramaticais" são despercebidas<span class="ot">[^2]</span>; e o resultado é somente um código "verborrágico", cheio de funções. Atualmente, parece haver um consenso crescente de que a melhor forma de começar a aprender R é começando pelo tidyverse; esta visão não é livre de críticos como de <span class="co">[</span><span class="ot">Norm Matloff, professor de estatística da UC Davis</span><span class="co">](https://github.com/matloff/TidyverseSkeptic)</span>.</span>
<span id="cb72-126"><a href="#cb72-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-127"><a href="#cb72-127" aria-hidden="true" tabindex="-1"></a><span class="ot">[^2]: </span>No fundo, isto é ainda mais um incentivo para aprender inglês.</span>
<span id="cb72-128"><a href="#cb72-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-129"><a href="#cb72-129" aria-hidden="true" tabindex="-1"></a>Um fato particularmente irritante do <span class="in">`tidyverse`</span> é a frequência com que os pacotes mudam. Na maior parte das vezes, as mudanças são positivas, mas isto faz com que o código escrito em tidyverse não seja sustentável ao longo do tempo.</span>
<span id="cb72-130"><a href="#cb72-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-131"><a href="#cb72-131" aria-hidden="true" tabindex="-1"></a>Eu demorei um bom tempo para entender as funções <span class="in">`tidyr::gather`</span> e <span class="in">`tidyr::spread`</span> e, atualmente, ambas foram descontinuadas e substituídas pelas funções <span class="in">`pivot_longer`</span> e <span class="in">`pivot_wider`</span>. As funções <span class="in">`mutate_if`</span>, <span class="in">`mutate_at`</span> e similares do <span class="in">`dplyr`</span> foram todas suprimidas pela sinataxe mais geral do <span class="in">`across`</span>. A função <span class="in">`tidyr::separate`</span> agora está sendo substituída por <span class="in">`separate_wider_position`</span> e <span class="in">`separate_wider_delim`</span>.</span>
<span id="cb72-132"><a href="#cb72-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-133"><a href="#cb72-133" aria-hidden="true" tabindex="-1"></a>Mesmo um código bem escrito há poucos anos atrás tem grandes chances de não funcionar mais porque as funções foram alteradas ou descontinuadas. Em 2021, Hadley Wickham, a principal mente por trás do tidyverse, discutiu este problema abertamente <span class="co">[</span><span class="ot">numa palestra</span><span class="co">](https://posit.co/resources/videos/maintaining-the-house-the-tidyverse-built/)</span>. Desde então, o tidyverse tem melhorado a sua política de <span class="co">[</span><span class="ot">manutenção de funções</span><span class="co">](https://lifecycle.r-lib.org/articles/stages.html)</span>.</span>
<span id="cb72-134"><a href="#cb72-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-135"><a href="#cb72-135" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tabelas</span></span>
<span id="cb72-136"><a href="#cb72-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-137"><a href="#cb72-137" aria-hidden="true" tabindex="-1"></a>O objeto central da análise de dados é o <span class="in">`data.frame`</span>. Um <span class="in">`data.frame`</span> é uma tabela bidimensional que contém informações: em geral, cada coluna é uma variável diferente e cada linha é uma observação. Este objeto possui propriedades bastante simples:</span>
<span id="cb72-138"><a href="#cb72-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-139"><a href="#cb72-139" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Comprimento fixo**. O número de linhas de um <span class="in">`data.frame`</span> é fixo, assim todas as colunas têm o mesmo comprimento.</span>
<span id="cb72-140"><a href="#cb72-140" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Homogeneidade**. Cada coluna de um <span class="in">`data.frame`</span> é homogênea, isto é, contém um dado de um único tipo. Assim, uma mesma coluna não pode misturar um string e um número, um <span class="in">`factor`</span> e um string, etc.</span>
<span id="cb72-141"><a href="#cb72-141" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Nomes**. Cada coluna tem um nome (único e idiomático). Este nome é utilizado para fazer refrência a esta coluna.</span>
<span id="cb72-142"><a href="#cb72-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-143"><a href="#cb72-143" aria-hidden="true" tabindex="-1"></a>Estas três características garantem a funcionalidade e consistência de um <span class="in">`data.frame`</span>. O comprimento fixo e a homogeneidade, em particular, tornam este tipo de objeto muito conveniente e previsível.</span>
<span id="cb72-144"><a href="#cb72-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-145"><a href="#cb72-145" aria-hidden="true" tabindex="-1"></a><span class="fu">### Construindo tabelas</span></span>
<span id="cb72-146"><a href="#cb72-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-147"><a href="#cb72-147" aria-hidden="true" tabindex="-1"></a>Para construir um <span class="in">`data.frame`</span> basta chamar a função homônima e declarar as suas colunas seguindo as três propriedades acima. Nos exemplos abaixo, ao invés da função <span class="in">`data.frame`</span> vou utilizar a função <span class="in">`tibble`</span> que é, essencialmente, equivalente, mas que possui algumas pequenas vantagens. No restante do texto as palavras <span class="in">`tibble`</span> e <span class="in">`data.frame`</span> serão utilizadas como sinônimas.</span>
<span id="cb72-148"><a href="#cb72-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-149"><a href="#cb72-149" aria-hidden="true" tabindex="-1"></a>No primeiro exemplo crio uma tabela com três linhas e duas colunas.</span>
<span id="cb72-150"><a href="#cb72-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-153"><a href="#cb72-153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-154"><a href="#cb72-154" aria-hidden="true" tabindex="-1"></a>dados <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-155"><a href="#cb72-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">cidade =</span> <span class="fu">c</span>(<span class="st">"Porto Alegre"</span>, <span class="st">"São Paulo"</span>, <span class="st">"Salvador"</span>),</span>
<span id="cb72-156"><a href="#cb72-156" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop22 =</span> <span class="fu">c</span>(<span class="fl">1.332</span>, <span class="fl">11.451</span>, <span class="fl">2.418</span>)</span>
<span id="cb72-157"><a href="#cb72-157" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-158"><a href="#cb72-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-159"><a href="#cb72-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-160"><a href="#cb72-160" aria-hidden="true" tabindex="-1"></a>Para visualizar o resultado basta chamar o objeto por nome ou usar a função <span class="in">`print`</span>. Uma das vantanges do <span class="in">`tibble`</span> é de mostrar a classe de cada coluna, onde <span class="in">`chr`</span> indica *character* (caractere), isto é, um string e `dbl` indica *double*, isto é, um número<span class="ot">[^3]</span>.</span>
<span id="cb72-161"><a href="#cb72-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-162"><a href="#cb72-162" aria-hidden="true" tabindex="-1"></a><span class="ot">[^3]: </span>A classe mais geral de números do R é a <span class="in">`numeric`</span>. Aqui, "double" faz referência à precisão do número, que é um "double-precision value", que equivale a uma precisão de 53 bits, com aplitude de $2\times 10^{-308}$ a $2\times 10^{-308}$. Em geral, a maioria dos números (com exceção de inteiros) é armazenada desta forma.</span>
<span id="cb72-163"><a href="#cb72-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-166"><a href="#cb72-166" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-167"><a href="#cb72-167" aria-hidden="true" tabindex="-1"></a>dados</span>
<span id="cb72-168"><a href="#cb72-168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-169"><a href="#cb72-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-170"><a href="#cb72-170" aria-hidden="true" tabindex="-1"></a>Pode-se também criar a tabela a partir de vetores/objetos previamente declarados.</span>
<span id="cb72-171"><a href="#cb72-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-174"><a href="#cb72-174" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-175"><a href="#cb72-175" aria-hidden="true" tabindex="-1"></a>cidades <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Porto Alegre"</span>, <span class="st">"São Paulo"</span>, <span class="st">"Salvador"</span>)</span>
<span id="cb72-176"><a href="#cb72-176" aria-hidden="true" tabindex="-1"></a>populacao <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.332</span>, <span class="fl">11.451</span>, <span class="fl">2.418</span>)</span>
<span id="cb72-177"><a href="#cb72-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-178"><a href="#cb72-178" aria-hidden="true" tabindex="-1"></a>dados <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-179"><a href="#cb72-179" aria-hidden="true" tabindex="-1"></a>  <span class="at">nome_cidade =</span> cidades,</span>
<span id="cb72-180"><a href="#cb72-180" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop22 =</span> populacao</span>
<span id="cb72-181"><a href="#cb72-181" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-182"><a href="#cb72-182" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-183"><a href="#cb72-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-184"><a href="#cb72-184" aria-hidden="true" tabindex="-1"></a>Quando alguma das colunas não tiver o mesmo comprimento das demais, o <span class="in">`R`</span> vai tentar "reciclar" os valores desta coluna. Em geral, isto vai causar um erro, mas em alguns casos pode funcionar. No caso abaixo o valor <span class="in">`"Brasil"`</span> (de comprimento unitário) é repetido três vezes para "caber" dentro da tabela.</span>
<span id="cb72-185"><a href="#cb72-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-188"><a href="#cb72-188" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-189"><a href="#cb72-189" aria-hidden="true" tabindex="-1"></a>dados <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-190"><a href="#cb72-190" aria-hidden="true" tabindex="-1"></a>  <span class="at">cidade =</span> <span class="fu">c</span>(<span class="st">"Porto Alegre"</span>, <span class="st">"São Paulo"</span>, <span class="st">"Salvador"</span>),</span>
<span id="cb72-191"><a href="#cb72-191" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop22 =</span> <span class="fu">c</span>(<span class="fl">1.332</span>, <span class="fl">11.451</span>, <span class="fl">2.418</span>),</span>
<span id="cb72-192"><a href="#cb72-192" aria-hidden="true" tabindex="-1"></a>  <span class="at">pais =</span> <span class="st">"Brasil"</span></span>
<span id="cb72-193"><a href="#cb72-193" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-194"><a href="#cb72-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-195"><a href="#cb72-195" aria-hidden="true" tabindex="-1"></a>dados</span>
<span id="cb72-196"><a href="#cb72-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-197"><a href="#cb72-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-198"><a href="#cb72-198" aria-hidden="true" tabindex="-1"></a><span class="fu">### Propriedades de tabelas</span></span>
<span id="cb72-199"><a href="#cb72-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-200"><a href="#cb72-200" aria-hidden="true" tabindex="-1"></a>Toda coluna de um <span class="in">`data.frame`</span> possui nomes. Para acessar os nomes usa-se <span class="in">`names`</span>.</span>
<span id="cb72-201"><a href="#cb72-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-204"><a href="#cb72-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-205"><a href="#cb72-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-206"><a href="#cb72-206" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(dados)</span>
<span id="cb72-207"><a href="#cb72-207" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "cidade" "pop22"  "pais"</span></span>
<span id="cb72-208"><a href="#cb72-208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-209"><a href="#cb72-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-210"><a href="#cb72-210" aria-hidden="true" tabindex="-1"></a>Os nomes das colunas sempre devem ser únicos. Aqui, há uma pequena vantagem em utilizar o <span class="in">`tibble`</span>. Mesmo no caso em que se tenta criar uma tabela com nomes idênticos, a função <span class="in">`data.frame`</span> evita que isto aconteça, mas emite nenhum tipo de alerta sobre o que está acontecendo.</span>
<span id="cb72-211"><a href="#cb72-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-214"><a href="#cb72-214" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-215"><a href="#cb72-215" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb72-216"><a href="#cb72-216" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb72-217"><a href="#cb72-217" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>)</span>
<span id="cb72-218"><a href="#cb72-218" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-219"><a href="#cb72-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-220"><a href="#cb72-220" aria-hidden="true" tabindex="-1"></a>tab</span>
<span id="cb72-221"><a href="#cb72-221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-222"><a href="#cb72-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-223"><a href="#cb72-223" aria-hidden="true" tabindex="-1"></a>A função <span class="in">`tibble`</span> é um pouco mais exigente e retorna um erro neste caso.</span>
<span id="cb72-224"><a href="#cb72-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-227"><a href="#cb72-227" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-228"><a href="#cb72-228" aria-hidden="true" tabindex="-1"></a><span class="co">#| error: true</span></span>
<span id="cb72-229"><a href="#cb72-229" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-230"><a href="#cb72-230" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb72-231"><a href="#cb72-231" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>)</span>
<span id="cb72-232"><a href="#cb72-232" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-233"><a href="#cb72-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-234"><a href="#cb72-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-235"><a href="#cb72-235" aria-hidden="true" tabindex="-1"></a>Para extrair uma coluna de um <span class="in">`data.frame`</span> temos duas opções. A mais simples e direta é utilizar o operador <span class="in">`$`</span> e chamar o nome da coluna como se fosse um objeto. A segunda opção é utilizar <span class="in">`[[`</span> e chamar o nome da coluna como um string<span class="ot">[^4]</span>.</span>
<span id="cb72-236"><a href="#cb72-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-237"><a href="#cb72-237" aria-hidden="true" tabindex="-1"></a><span class="ot">[^4]: </span>De fato, esta é a mesma sintaxe que se utiliza para extrair um elemento de uma lista. Isto acontece pois um <span class="in">`data.frame`</span> é essencialmente, uma lista com um pouco mais de estrutura. Isto pode ser verificado usando <span class="in">`typeof`</span> em um objeto <span class="in">`data.frame`</span>.</span>
<span id="cb72-238"><a href="#cb72-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-241"><a href="#cb72-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-242"><a href="#cb72-242" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-243"><a href="#cb72-243" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Extraindo uma coluna </span></span>
<span id="cb72-244"><a href="#cb72-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-245"><a href="#cb72-245" aria-hidden="true" tabindex="-1"></a>dados<span class="sc">$</span>cidade</span>
<span id="cb72-246"><a href="#cb72-246" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "Porto Alegre" "São Paulo"    "Salvador"</span></span>
<span id="cb72-247"><a href="#cb72-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-248"><a href="#cb72-248" aria-hidden="true" tabindex="-1"></a>dados[[<span class="st">"cidade"</span>]]</span>
<span id="cb72-249"><a href="#cb72-249" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "Porto Alegre" "São Paulo"    "Salvador"</span></span>
<span id="cb72-250"><a href="#cb72-250" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-251"><a href="#cb72-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-252"><a href="#cb72-252" aria-hidden="true" tabindex="-1"></a><span class="fu">### Importando tabelas</span></span>
<span id="cb72-253"><a href="#cb72-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-254"><a href="#cb72-254" aria-hidden="true" tabindex="-1"></a>Raramente vamos declarar todas as observações de uma tabela. Na prática, é muito mais comum importar uma tabela de alguma fonte externa como de uma planilha de Excel ou de um arquivo csv. Para cada tipo de arquivo existe uma função <span class="in">`read_*`</span> diferente. Importar dados costuma ser uma tarefa frustrante por três motivos:</span>
<span id="cb72-255"><a href="#cb72-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-256"><a href="#cb72-256" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Há muitos arquivos para se importar.</span>
<span id="cb72-257"><a href="#cb72-257" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>É difícil fazer o <span class="in">`R`</span> encontrar o arquivo.</span>
<span id="cb72-258"><a href="#cb72-258" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Os arquivos têm problemas (valores corrompidos, linhas vazias, etc.)</span>
<span id="cb72-259"><a href="#cb72-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-260"><a href="#cb72-260" aria-hidden="true" tabindex="-1"></a>Os dois primeiros problemas são simples de se resolver. Pode-se importar múltiplos arquivos ao mesmo tempo usando um loop; importar todos os arquivos dentro de uma mesma pasta é trivial, desde que os arquivos sigam o mesmo padrão.</span>
<span id="cb72-261"><a href="#cb72-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-262"><a href="#cb72-262" aria-hidden="true" tabindex="-1"></a>Garantir que o <span class="in">`R`</span> consiga encontrar os arquivos também é simples. Idealmente, todos os arquivos externos devem estar organizados dentro de uma pasta chamada <span class="in">`dados`</span> ou <span class="in">`data`</span> e deve-se chamar estes dados usando funções <span class="in">`read_*`</span>. Uma boa prática é sempre usar "caminhos relativos" ao invés de caminhos absolutos.</span>
<span id="cb72-263"><a href="#cb72-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-266"><a href="#cb72-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-267"><a href="#cb72-267" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-268"><a href="#cb72-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-269"><a href="#cb72-269" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Ruim</span></span>
<span id="cb72-270"><a href="#cb72-270" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"/Users/viniciusoike/Documents/GitHub/projeto/data/income.csv"</span>)</span>
<span id="cb72-271"><a href="#cb72-271" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Bom </span></span>
<span id="cb72-272"><a href="#cb72-272" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/income.csv"</span>)</span>
<span id="cb72-273"><a href="#cb72-273" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Ainda melhor</span></span>
<span id="cb72-274"><a href="#cb72-274" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/income.csv"</span>))</span>
<span id="cb72-275"><a href="#cb72-275" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-276"><a href="#cb72-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-277"><a href="#cb72-277" aria-hidden="true" tabindex="-1"></a>O terceiro problema é muito mais complexo e vai exigir mais conhecimento e prática. Em geral, resolve-se a maior parte dos problemas usando algum dos argumentos dentro da função <span class="in">`read_*`</span> como:</span>
<span id="cb72-278"><a href="#cb72-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-279"><a href="#cb72-279" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`skip`</span>: Pula as primeiras k linhas.</span>
<span id="cb72-280"><a href="#cb72-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-281"><a href="#cb72-281" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`na`</span>: Define quais valores devem ser interpretados como valores ausentes.</span>
<span id="cb72-282"><a href="#cb72-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-283"><a href="#cb72-283" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`col_types`</span>: Permite que se declare explicitamente qual o tipo de dado (numérico, data, texto) que está armazenado em cada coluna.</span>
<span id="cb72-284"><a href="#cb72-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-285"><a href="#cb72-285" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`col_names`</span> ou <span class="in">`name_repair`</span>: O primeiro permite que se declare explicitamente o nome que cada coluna vai ter dentro do <span class="in">`R`</span> enquanto o segundo permite que se use uma função que renomeia as colunas.</span>
<span id="cb72-286"><a href="#cb72-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-287"><a href="#cb72-287" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`locale`</span>: Permite selecionar diferentes tipos de padrão de local. Em geral, usa-se <span class="in">`locale = locale("pt_BR")`</span>.</span>
<span id="cb72-288"><a href="#cb72-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-289"><a href="#cb72-289" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>range: Este argumento só vale no caso de planilhas de Excel e permite que se importe uma seleção específica da planilha (e.g. "D4:H115")</span>
<span id="cb72-290"><a href="#cb72-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-291"><a href="#cb72-291" aria-hidden="true" tabindex="-1"></a>O código abaixo mostra um exemplo particularmente tenebroso. O título da segunda coluna inclui símbolos como <span class="in">`$`</span> e <span class="in">`/`</span>; as datas estão em português com o mês escrito por extenso e em formato dia-mês-ano; os números usam a vírgula (ao invés do ponto) para separar o decimal e o valor ausente é sinalizado com "X".</span>
<span id="cb72-292"><a href="#cb72-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-295"><a href="#cb72-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-296"><a href="#cb72-296" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-297"><a href="#cb72-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-298"><a href="#cb72-298" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Input de um csv sujo</span></span>
<span id="cb72-299"><a href="#cb72-299" aria-hidden="true" tabindex="-1"></a>dados <span class="ot">&lt;-</span></span>
<span id="cb72-300"><a href="#cb72-300" aria-hidden="true" tabindex="-1"></a><span class="st">'Data; Valor (R$/m2)</span></span>
<span id="cb72-301"><a href="#cb72-301" aria-hidden="true" tabindex="-1"></a><span class="st">"01-maio-2020";22,3</span></span>
<span id="cb72-302"><a href="#cb72-302" aria-hidden="true" tabindex="-1"></a><span class="st">"01-junho-2020";21,5</span></span>
<span id="cb72-303"><a href="#cb72-303" aria-hidden="true" tabindex="-1"></a><span class="st">"06-julho-2021";X</span></span>
<span id="cb72-304"><a href="#cb72-304" aria-hidden="true" tabindex="-1"></a><span class="st">"07-novembro-2022";22'</span></span>
<span id="cb72-305"><a href="#cb72-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-306"><a href="#cb72-306" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Lendo o arquivo</span></span>
<span id="cb72-307"><a href="#cb72-307" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(</span>
<span id="cb72-308"><a href="#cb72-308" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Substitui esta linha pelo 'path' até o csv</span></span>
<span id="cb72-309"><a href="#cb72-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">I</span>(dados),</span>
<span id="cb72-310"><a href="#cb72-310" aria-hidden="true" tabindex="-1"></a>  <span class="at">delim =</span> <span class="st">";"</span>,</span>
<span id="cb72-311"><a href="#cb72-311" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Usa , como separador decimal; lê meses em português (e.g. maio, junho, etc.)</span></span>
<span id="cb72-312"><a href="#cb72-312" aria-hidden="true" tabindex="-1"></a>  <span class="at">locale =</span> <span class="fu">locale</span>(<span class="at">decimal_mark =</span> <span class="st">","</span>, <span class="at">date_names =</span> <span class="st">"pt"</span>, <span class="at">date_format =</span> <span class="st">"%d-%B-%Y"</span>),</span>
<span id="cb72-313"><a href="#cb72-313" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Interpreta X como valores ausentes (NA)</span></span>
<span id="cb72-314"><a href="#cb72-314" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="st">"x"</span>,</span>
<span id="cb72-315"><a href="#cb72-315" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Renomeia as colunas</span></span>
<span id="cb72-316"><a href="#cb72-316" aria-hidden="true" tabindex="-1"></a>  <span class="at">name_repair =</span> janitor<span class="sc">::</span>clean_names</span>
<span id="cb72-317"><a href="#cb72-317" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-318"><a href="#cb72-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-319"><a href="#cb72-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-320"><a href="#cb72-320" aria-hidden="true" tabindex="-1"></a><span class="fu"># Manipulando dados</span></span>
<span id="cb72-321"><a href="#cb72-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-322"><a href="#cb72-322" aria-hidden="true" tabindex="-1"></a>O pacote <span class="in">`dplyr`</span> é uma das ferramentas mais populares e úteis para manipulação de dados no R. Ele fornece uma série de funções simples e poderosas para filtrar, agrupar, modificar e resumir dados. Neste tutorial, vamos explorar algumas dessas funções e ver como elas podem ser usadas para realizar tarefas comuns de manipulação de dados.</span>
<span id="cb72-323"><a href="#cb72-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-324"><a href="#cb72-324" aria-hidden="true" tabindex="-1"></a>Agora, vamos ver algumas das funções mais úteis do dplyr:</span>
<span id="cb72-325"><a href="#cb72-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-326"><a href="#cb72-326" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Nome da Função <span class="pp">|</span> Tradução          <span class="pp">|</span> O que faz                                                         <span class="pp">|</span></span>
<span id="cb72-327"><a href="#cb72-327" aria-hidden="true" tabindex="-1"></a><span class="pp">|----------------|-------------------|-------------------------------------------------------------------|</span></span>
<span id="cb72-328"><a href="#cb72-328" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`rename`</span>       <span class="pp">|</span> Renomear          <span class="pp">|</span> Modifica o nome das colunas.                                      <span class="pp">|</span></span>
<span id="cb72-329"><a href="#cb72-329" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`select`</span>       <span class="pp">|</span> Selecionar        <span class="pp">|</span> Seleciona as colunas.                                             <span class="pp">|</span></span>
<span id="cb72-330"><a href="#cb72-330" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`filter`</span>       <span class="pp">|</span> Filtrar           <span class="pp">|</span> Filtra/seleciona as linhas segundo alguma condição.               <span class="pp">|</span></span>
<span id="cb72-331"><a href="#cb72-331" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`arrange`</span>      <span class="pp">|</span> Arranjar/ordenar  <span class="pp">|</span> Ordena as linhas (crescente/decrescente) segundo alguma variável. <span class="pp">|</span></span>
<span id="cb72-332"><a href="#cb72-332" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`mutate`</span>       <span class="pp">|</span> Mutar/transformar <span class="pp">|</span> Cria uma nova coluna a partir de outras colunas ou dados.         <span class="pp">|</span></span>
<span id="cb72-333"><a href="#cb72-333" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`summarise`</span>    <span class="pp">|</span> Sumarizar/resumir <span class="pp">|</span> Aplica alguma função sobre as linhas. Cria uma tabela "resumo".   <span class="pp">|</span></span>
<span id="cb72-334"><a href="#cb72-334" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> <span class="in">`group by`</span>     <span class="pp">|</span> Agrupar           <span class="pp">|</span> Agrupa as linhas segundo alguma variável.                         <span class="pp">|</span></span>
<span id="cb72-335"><a href="#cb72-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-336"><a href="#cb72-336" aria-hidden="true" tabindex="-1"></a>As funções <span class="in">`rename`</span>, <span class="in">`mutate`</span>, <span class="in">`select`</span> e <span class="in">`filter`</span> são utilizadas para preparar e limpar os dados, enquanto as funções <span class="in">`group_by`</span> e <span class="in">`summarise`</span> são utilizadas para transformar/resumir os dados. Estas são as seis principais funções do pacote e veremos cada uma delas em maior detalhes.</span>
<span id="cb72-337"><a href="#cb72-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-338"><a href="#cb72-338" aria-hidden="true" tabindex="-1"></a>Para praticar as funções vamos utilizar uma tabela que traz informações sobre as cidades do Brasil.</span>
<span id="cb72-339"><a href="#cb72-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-342"><a href="#cb72-342" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-343"><a href="#cb72-343" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-344"><a href="#cb72-344" aria-hidden="true" tabindex="-1"></a>tbl <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"..."</span>)</span>
<span id="cb72-345"><a href="#cb72-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-346"><a href="#cb72-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-349"><a href="#cb72-349" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-350"><a href="#cb72-350" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb72-351"><a href="#cb72-351" aria-hidden="true" tabindex="-1"></a>tbl <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"static/data/cities_brazil.csv"</span>))</span>
<span id="cb72-352"><a href="#cb72-352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-353"><a href="#cb72-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-356"><a href="#cb72-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-357"><a href="#cb72-357" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb72-358"><a href="#cb72-358" aria-hidden="true" tabindex="-1"></a>DT<span class="sc">::</span><span class="fu">datatable</span>(tbl)</span>
<span id="cb72-359"><a href="#cb72-359" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-360"><a href="#cb72-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-361"><a href="#cb72-361" aria-hidden="true" tabindex="-1"></a><span class="fu">## rename</span></span>
<span id="cb72-362"><a href="#cb72-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-363"><a href="#cb72-363" aria-hidden="true" tabindex="-1"></a>Para renomear as colunas de <span class="in">`data.frame`</span> usa-se a função <span class="in">`rename`</span> (renomear) com <span class="in">`rename(tbl, novo_nome = velho_nome)`</span>. Vale lembrar que para checar os nomes da tabela usa-se <span class="in">`names(tbl)`</span>.</span>
<span id="cb72-364"><a href="#cb72-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-367"><a href="#cb72-367" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-368"><a href="#cb72-368" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Renomear colunas</span></span>
<span id="cb72-369"><a href="#cb72-369" aria-hidden="true" tabindex="-1"></a>tbl_renamed <span class="ot">&lt;-</span> <span class="fu">rename</span>(tbl, <span class="at">codigo_municipio =</span> code_muni, <span class="at">pop =</span> population)</span>
<span id="cb72-370"><a href="#cb72-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-371"><a href="#cb72-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-372"><a href="#cb72-372" aria-hidden="true" tabindex="-1"></a>Os nomes das colunas de um <span class="in">`data.frame`</span> devem</span>
<span id="cb72-373"><a href="#cb72-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-374"><a href="#cb72-374" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Ser únicos (não-duplicados) e evitar caracteres maiúsculos.</span>
<span id="cb72-375"><a href="#cb72-375" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Não devem incluir caracteres especiais (e.g. !<span class="sc">\*</span>&amp;\@%), nem começar com um número ou caractere especial.</span>
<span id="cb72-376"><a href="#cb72-376" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Evitar espaços em branco, que devem ser substituídos por <span class="in">`_`</span> ou omitidos (e.g. <span class="in">`PIB Agro`</span> deve ser reescrito como <span class="in">`pibAgro`</span> ou <span class="in">`pib_agro`</span>.</span>
<span id="cb72-377"><a href="#cb72-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-378"><a href="#cb72-378" aria-hidden="true" tabindex="-1"></a>Também é possível renomear colunas com auxílio de um vetor ou lista e usando ou <span class="in">`all_of`</span> (todos) ou <span class="in">`any_of`</span> (algum/alguns). O exemplo abaixo mostra a lógica geral: temos um vetor que indica o novo nome e o antigo nome de cada coluna que se quer trocar. Caso se queira trocar exatamente todos os nomes indicados no vetor usa-se <span class="in">`all_of`</span> (mais rigoroso), caso se queira trocar todos os nomes indicados no vetor, ignorando os casos que não batem com nomes de colunas existentes, usa-se <span class="in">`any_of`</span>.</span>
<span id="cb72-379"><a href="#cb72-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-382"><a href="#cb72-382" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-383"><a href="#cb72-383" aria-hidden="true" tabindex="-1"></a>new_names <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb72-384"><a href="#cb72-384" aria-hidden="true" tabindex="-1"></a>  <span class="st">"codigo_municipio"</span> <span class="ot">=</span> <span class="st">"code_muni"</span>,</span>
<span id="cb72-385"><a href="#cb72-385" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pop"</span> <span class="ot">=</span> <span class="st">"population"</span>,</span>
<span id="cb72-386"><a href="#cb72-386" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pop_rate"</span> <span class="ot">=</span> <span class="st">"population_growth_rate"</span></span>
<span id="cb72-387"><a href="#cb72-387" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-388"><a href="#cb72-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-389"><a href="#cb72-389" aria-hidden="true" tabindex="-1"></a>tbl_renamed <span class="ot">&lt;-</span> <span class="fu">rename</span>(tbl, <span class="fu">all_of</span>(new_names))</span>
<span id="cb72-390"><a href="#cb72-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-391"><a href="#cb72-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-392"><a href="#cb72-392" aria-hidden="true" tabindex="-1"></a>No exemplo abaixo incluo uma "nova coluna" chamada <span class="in">`unit`</span> que desejo renomear para <span class="in">`unidade`</span>. Usando <span class="in">`any_of`</span> o retorno é exatamente igual ao caso acima, pois a função ignora a coluna inexistente <span class="in">`unit`</span>.</span>
<span id="cb72-393"><a href="#cb72-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-396"><a href="#cb72-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-397"><a href="#cb72-397" aria-hidden="true" tabindex="-1"></a>new_names <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb72-398"><a href="#cb72-398" aria-hidden="true" tabindex="-1"></a>  <span class="st">"codigo_municipio"</span> <span class="ot">=</span> <span class="st">"code_muni"</span>,</span>
<span id="cb72-399"><a href="#cb72-399" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pop"</span> <span class="ot">=</span> <span class="st">"population"</span>,</span>
<span id="cb72-400"><a href="#cb72-400" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pop_rate"</span> <span class="ot">=</span> <span class="st">"population_growth_rate"</span>,</span>
<span id="cb72-401"><a href="#cb72-401" aria-hidden="true" tabindex="-1"></a>  <span class="st">"unidade"</span> <span class="ot">=</span> <span class="st">"unit"</span></span>
<span id="cb72-402"><a href="#cb72-402" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-403"><a href="#cb72-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-404"><a href="#cb72-404" aria-hidden="true" tabindex="-1"></a>tbl_renamed <span class="ot">&lt;-</span> <span class="fu">rename</span>(tbl, <span class="fu">any_of</span>(new_names))</span>
<span id="cb72-405"><a href="#cb72-405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-406"><a href="#cb72-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-407"><a href="#cb72-407" aria-hidden="true" tabindex="-1"></a>Já a função <span class="in">`all_of`</span> é mais rigorosa e retorna um erro indicando que a coluna <span class="in">`unit`</span> não existe.</span>
<span id="cb72-408"><a href="#cb72-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-411"><a href="#cb72-411" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-412"><a href="#cb72-412" aria-hidden="true" tabindex="-1"></a><span class="co">#| error: true</span></span>
<span id="cb72-413"><a href="#cb72-413" aria-hidden="true" tabindex="-1"></a>tbl_renamed <span class="ot">&lt;-</span> <span class="fu">rename</span>(tbl, <span class="fu">all_of</span>(new_names))</span>
<span id="cb72-414"><a href="#cb72-414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-415"><a href="#cb72-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-416"><a href="#cb72-416" aria-hidden="true" tabindex="-1"></a>O uso de um vetor externo para renomear colunas é conveniente não somente porque permite melhor organizar o código; na prática, este vetor externo funciona como um **dicionário de variáveis** que pode ser inclusive utilizado para tratar várias bases de dados ou mesmo em outros códigos. Além disso, tratar o nome das colunas como strings é útil pois nos permite transformar este dado mais facilmente.</span>
<span id="cb72-417"><a href="#cb72-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-418"><a href="#cb72-418" aria-hidden="true" tabindex="-1"></a>Por fim, pode-se aplicar uma função para renomear as colunas usando <span class="in">`rename_with`</span>.</span>
<span id="cb72-419"><a href="#cb72-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-422"><a href="#cb72-422" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-423"><a href="#cb72-423" aria-hidden="true" tabindex="-1"></a>tbl_renamed <span class="ot">&lt;-</span> <span class="fu">rename_with</span>(tbl, toupper)</span>
<span id="cb72-424"><a href="#cb72-424" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tbl_renamed)</span>
<span id="cb72-425"><a href="#cb72-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-426"><a href="#cb72-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-427"><a href="#cb72-427" aria-hidden="true" tabindex="-1"></a>Uma dica final para rapidamente renomear colunas é a função <span class="in">`janitor::clean_names`</span> que obedece aos três princípios elencados acima. Ela pode ser utilizada diretamente num <span class="in">`data.frame`</span> como se vê no exemplo abaixo.</span>
<span id="cb72-428"><a href="#cb72-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-431"><a href="#cb72-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-432"><a href="#cb72-432" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-433"><a href="#cb72-433" aria-hidden="true" tabindex="-1"></a>test_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">6</span>))</span>
<span id="cb72-434"><a href="#cb72-434" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(test_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"firstName"</span>, <span class="st">"ábc@!*"</span>, <span class="st">"% successful (2009)"</span>,</span>
<span id="cb72-435"><a href="#cb72-435" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"REPEAT VALUE"</span>, <span class="st">"REPEAT VALUE"</span>, <span class="st">""</span>)</span>
<span id="cb72-436"><a href="#cb72-436" aria-hidden="true" tabindex="-1"></a>janitor<span class="sc">::</span><span class="fu">clean_names</span>(test_df)</span>
<span id="cb72-437"><a href="#cb72-437" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   first_name abc percent_successful_2009 repeat_value repeat_value_2  x</span></span>
<span id="cb72-438"><a href="#cb72-438" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1         NA  NA                      NA           NA             NA NA</span></span>
<span id="cb72-439"><a href="#cb72-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-440"><a href="#cb72-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-441"><a href="#cb72-441" aria-hidden="true" tabindex="-1"></a><span class="fu">## select</span></span>
<span id="cb72-442"><a href="#cb72-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-443"><a href="#cb72-443" aria-hidden="true" tabindex="-1"></a>A função <span class="in">`select`</span> serve para selecionar colunas num <span class="in">`data.frame`</span>, permitindo-se trabalhar com uma versão menor dos dados. Similarmente à função <span class="in">`rename`</span> é possível selecionar colunas diretamente <span class="in">`select(tbl, coluna_1, coluna_2, …)`</span> ou selecionando os nomes via um vetor de strings com auxílio de <span class="in">`any_of`</span> of <span class="in">`all_of`</span>.</span>
<span id="cb72-444"><a href="#cb72-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-447"><a href="#cb72-447" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-448"><a href="#cb72-448" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona diretamente as colunas</span></span>
<span id="cb72-449"><a href="#cb72-449" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, code_muni, pib, pib_agriculture)</span>
<span id="cb72-450"><a href="#cb72-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-451"><a href="#cb72-451" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Cria um vetor de nomes</span></span>
<span id="cb72-452"><a href="#cb72-452" aria-hidden="true" tabindex="-1"></a>colunas <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"code_muni"</span>, <span class="st">"pib"</span>, <span class="st">"pib_agriculture"</span>)</span>
<span id="cb72-453"><a href="#cb72-453" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona as colunas baseado no vetor</span></span>
<span id="cb72-454"><a href="#cb72-454" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, <span class="fu">all_of</span>(colunas))</span>
<span id="cb72-455"><a href="#cb72-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-456"><a href="#cb72-456" aria-hidden="true" tabindex="-1"></a>sel_tbl</span>
<span id="cb72-457"><a href="#cb72-457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-458"><a href="#cb72-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-459"><a href="#cb72-459" aria-hidden="true" tabindex="-1"></a>Para remover uma coluna, basta usar o sinal de menos na frente do nome.</span>
<span id="cb72-460"><a href="#cb72-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-463"><a href="#cb72-463" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-464"><a href="#cb72-464" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona diretamente as colunas</span></span>
<span id="cb72-465"><a href="#cb72-465" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, <span class="sc">-</span>pib, <span class="sc">-</span>city_area, <span class="sc">-</span>population_density)</span>
<span id="cb72-466"><a href="#cb72-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-467"><a href="#cb72-467" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Cria um vetor de nomes</span></span>
<span id="cb72-468"><a href="#cb72-468" aria-hidden="true" tabindex="-1"></a>colunas <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"pib"</span>, <span class="st">"city_area"</span>, <span class="st">"population_density"</span>)</span>
<span id="cb72-469"><a href="#cb72-469" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona as colunas baseado no vetor</span></span>
<span id="cb72-470"><a href="#cb72-470" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, <span class="sc">-</span><span class="fu">all_of</span>(colunas))</span>
<span id="cb72-471"><a href="#cb72-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-472"><a href="#cb72-472" aria-hidden="true" tabindex="-1"></a>sel_tbl</span>
<span id="cb72-473"><a href="#cb72-473" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-474"><a href="#cb72-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-475"><a href="#cb72-475" aria-hidden="true" tabindex="-1"></a>Pode-se também selecionar várias colunas ao mesmo tempo se elas estiverem em sequência (uma ao lado da outra). O código abaixo, por exemplo, seleciona a coluna <span class="in">`code_muni`</span> e todas as colunas entre <span class="in">`pib`</span> e <span class="in">`pib_added_value`</span> (inclusive).</span>
<span id="cb72-476"><a href="#cb72-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-479"><a href="#cb72-479" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-480"><a href="#cb72-480" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, code_muni, pib<span class="sc">:</span>pib_added_value)</span>
<span id="cb72-481"><a href="#cb72-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-482"><a href="#cb72-482" aria-hidden="true" tabindex="-1"></a>sel_tbl</span>
<span id="cb72-483"><a href="#cb72-483" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-484"><a href="#cb72-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-485"><a href="#cb72-485" aria-hidden="true" tabindex="-1"></a>Também é possível renomear e selecionar ao mesmo tempo.</span>
<span id="cb72-486"><a href="#cb72-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-489"><a href="#cb72-489" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-490"><a href="#cb72-490" aria-hidden="true" tabindex="-1"></a>sel_tbl <span class="ot">&lt;-</span> <span class="fu">select</span>(tbl, <span class="at">codigo_municipio =</span> code_muni, pib)</span>
<span id="cb72-491"><a href="#cb72-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-492"><a href="#cb72-492" aria-hidden="true" tabindex="-1"></a>sel_tbl</span>
<span id="cb72-493"><a href="#cb72-493" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-494"><a href="#cb72-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-495"><a href="#cb72-495" aria-hidden="true" tabindex="-1"></a>Por fim, existem algumas funções auxiliares que facilitam a seleção de múltiplas colunas. Vou apresentar apenas três destas funções:</span>
<span id="cb72-496"><a href="#cb72-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-497"><a href="#cb72-497" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`starts_with`</span>/<span class="in">`ends_with`</span> - selecionam colunas que começam ou terminam com determindo string.</span>
<span id="cb72-498"><a href="#cb72-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-499"><a href="#cb72-499" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`where`</span> - seleciona colunas de uma determinada classe (<span class="in">`numeric`</span>, <span class="in">`factor`</span>, etc.)</span>
<span id="cb72-500"><a href="#cb72-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-501"><a href="#cb72-501" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`matches`</span> - seleciona colunas com base num *match*, usando regex. Esta função é mais geral e engloba as duas primeiras.</span>
<span id="cb72-502"><a href="#cb72-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-503"><a href="#cb72-503" aria-hidden="true" tabindex="-1"></a>O código abaixo mostra alguns exemplos simples. Vou omitir as saídas do código, max experimente reproduzir o resultado.</span>
<span id="cb72-504"><a href="#cb72-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-507"><a href="#cb72-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-508"><a href="#cb72-508" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-509"><a href="#cb72-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-510"><a href="#cb72-510" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona code_muni mais as colunas que começam com 'pib'</span></span>
<span id="cb72-511"><a href="#cb72-511" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, code_muni, <span class="fu">starts_with</span>(<span class="st">"pib"</span>))</span>
<span id="cb72-512"><a href="#cb72-512" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona as colunas que terminam com 'muni'</span></span>
<span id="cb72-513"><a href="#cb72-513" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, <span class="fu">ends_with</span>(<span class="st">"muni"</span>))</span>
<span id="cb72-514"><a href="#cb72-514" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona code_muni mais as colunas que contêm números</span></span>
<span id="cb72-515"><a href="#cb72-515" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, code_muni, <span class="fu">where</span>(is.numeric))</span>
<span id="cb72-516"><a href="#cb72-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-517"><a href="#cb72-517" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona as colunas que tem o padrão '_texto_'</span></span>
<span id="cb72-518"><a href="#cb72-518" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, <span class="fu">matches</span>(<span class="st">"_[a-z].+_"</span>))</span>
<span id="cb72-519"><a href="#cb72-519" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Selciona todas as colunas que começam com 'pib'</span></span>
<span id="cb72-520"><a href="#cb72-520" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, <span class="fu">matches</span>(<span class="st">"^pib"</span>))</span>
<span id="cb72-521"><a href="#cb72-521" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Seleciona todas as colunas que terminam com 'muni'</span></span>
<span id="cb72-522"><a href="#cb72-522" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(tbl, <span class="fu">matches</span>(<span class="st">"muni$"</span>))</span>
<span id="cb72-523"><a href="#cb72-523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-524"><a href="#cb72-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-525"><a href="#cb72-525" aria-hidden="true" tabindex="-1"></a><span class="fu">## filter</span></span>
<span id="cb72-526"><a href="#cb72-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-527"><a href="#cb72-527" aria-hidden="true" tabindex="-1"></a>A função <span class="in">`filter`</span> serve para filtrar as linhas de um <span class="in">`data.frame`</span> segundo alguma condição lógica.</span>
<span id="cb72-528"><a href="#cb72-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-531"><a href="#cb72-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-532"><a href="#cb72-532" aria-hidden="true" tabindex="-1"></a>filtered_tbl <span class="ot">&lt;-</span> <span class="fu">filter</span>(tbl, population_growth <span class="sc">&lt;</span> <span class="dv">0</span>)</span>
<span id="cb72-533"><a href="#cb72-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-534"><a href="#cb72-534" aria-hidden="true" tabindex="-1"></a>filtered_tbl</span>
<span id="cb72-535"><a href="#cb72-535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-536"><a href="#cb72-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-537"><a href="#cb72-537" aria-hidden="true" tabindex="-1"></a>Os principais opereadores lógicos no R:</span>
<span id="cb72-538"><a href="#cb72-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-539"><a href="#cb72-539" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>"Maior que", "Menor que": <span class="in">`&gt;`</span>, <span class="in">`&lt;`</span>, <span class="in">`&gt;=`</span>, <span class="in">`&lt;=`</span></span>
<span id="cb72-540"><a href="#cb72-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-541"><a href="#cb72-541" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>E/ou: <span class="in">`&amp;`</span>, <span class="in">`|`</span></span>
<span id="cb72-542"><a href="#cb72-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-543"><a href="#cb72-543" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>"Negação": <span class="in">`!`</span></span>
<span id="cb72-544"><a href="#cb72-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-545"><a href="#cb72-545" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>"Igual a": <span class="in">`==`</span></span>
<span id="cb72-546"><a href="#cb72-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-547"><a href="#cb72-547" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>"Dentro de": <span class="in">`%in%`</span></span>
<span id="cb72-548"><a href="#cb72-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-549"><a href="#cb72-549" aria-hidden="true" tabindex="-1"></a>Existem alguns outros operadores, mas estes costumam resolver 95% dos casos. O exemplo abaixo mostra como filtrar linhas baseado num string. Note que quando se usa múltiplos strings é preciso usar o <span class="in">`%in%`</span>.</span>
<span id="cb72-550"><a href="#cb72-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-553"><a href="#cb72-553" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-554"><a href="#cb72-554" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, name_muni <span class="sc">==</span> <span class="st">"São Paulo"</span>)</span>
<span id="cb72-555"><a href="#cb72-555" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, name_muni <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"São Paulo"</span>, <span class="st">"Rio de Janeiro"</span>))</span>
<span id="cb72-556"><a href="#cb72-556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-557"><a href="#cb72-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-558"><a href="#cb72-558" aria-hidden="true" tabindex="-1"></a>Para negar a igualdade, basta usar o operador <span class="in">`!`</span>. No caso do operador <span class="in">`%in%`</span> há duas maneiras válidas de negá-lo: pode-se colocar o ! no começo da expressão ou colocar a expressão inteira dentro de um parêntesis. Eu tendo a preferir a segunda sintaxe.</span>
<span id="cb72-559"><a href="#cb72-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-562"><a href="#cb72-562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-563"><a href="#cb72-563" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-564"><a href="#cb72-564" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Remove todas as cidades da região Sudeste</span></span>
<span id="cb72-565"><a href="#cb72-565" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, name_region <span class="sc">!=</span> <span class="st">"Sudeste"</span>)</span>
<span id="cb72-566"><a href="#cb72-566" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Remove todas as cidades das regiões Sudeste e Norte</span></span>
<span id="cb72-567"><a href="#cb72-567" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, <span class="sc">!</span>name_region <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sudeste"</span>, <span class="st">"Norte"</span>))</span>
<span id="cb72-568"><a href="#cb72-568" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Remove todas as cidades das regiões Sudeste e Norte</span></span>
<span id="cb72-569"><a href="#cb72-569" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, <span class="sc">!</span>(name_region <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sudeste"</span>, <span class="st">"Norte"</span>)))</span>
<span id="cb72-570"><a href="#cb72-570" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-571"><a href="#cb72-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-572"><a href="#cb72-572" aria-hidden="true" tabindex="-1"></a>Em geral, não é preciso utilizar o E (<span class="in">`&amp;`</span>), já que pode-se colocar várias condições lógicas dentro de uma mesma chamada para função <span class="in">`filter`</span>.</span>
<span id="cb72-573"><a href="#cb72-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-576"><a href="#cb72-576" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-577"><a href="#cb72-577" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-578"><a href="#cb72-578" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(</span>
<span id="cb72-579"><a href="#cb72-579" aria-hidden="true" tabindex="-1"></a>  tbl,</span>
<span id="cb72-580"><a href="#cb72-580" aria-hidden="true" tabindex="-1"></a>  name_region <span class="sc">==</span> <span class="st">"Nordeste"</span>,</span>
<span id="cb72-581"><a href="#cb72-581" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span>(name_state <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Pernambuco"</span>, <span class="st">"Piauí"</span>)),</span>
<span id="cb72-582"><a href="#cb72-582" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span>(name_muni <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Natal"</span>, <span class="st">"Fortaleza"</span>, <span class="st">"Maceió"</span>))</span>
<span id="cb72-583"><a href="#cb72-583" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-584"><a href="#cb72-584" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-585"><a href="#cb72-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-586"><a href="#cb72-586" aria-hidden="true" tabindex="-1"></a>No caso de relações de grandeza, pode-se colocar um número absoluto, mas também pode-se usar alguma função. No exemplo abaixo filtra-se apenas os municípios com PIB acima da média, por exemplo.</span>
<span id="cb72-587"><a href="#cb72-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-590"><a href="#cb72-590" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-591"><a href="#cb72-591" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-592"><a href="#cb72-592" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, pib <span class="sc">&gt;</span> <span class="fu">mean</span>(pib))</span>
<span id="cb72-593"><a href="#cb72-593" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(tbl, population <span class="sc">&gt;=</span> <span class="dv">1000000</span>)</span>
<span id="cb72-594"><a href="#cb72-594" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-595"><a href="#cb72-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-596"><a href="#cb72-596" aria-hidden="true" tabindex="-1"></a><span class="fu">## arrange</span></span>
<span id="cb72-597"><a href="#cb72-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-598"><a href="#cb72-598" aria-hidden="true" tabindex="-1"></a>A função <span class="in">`arrange`</span> é talvez a mais simples e serve para rearranjar as linhas de um <span class="in">`data.frame`</span>. Em geral, ela é utilizada mais para fins estéticos ou exploratórios, como para ordenar as cidades pelo maior PIB, ou menor população. Contudo, no caso de uma tabela que contenha séries de tempo, pode ser importante validar que as observações estão na ordem correta.</span>
<span id="cb72-599"><a href="#cb72-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-602"><a href="#cb72-602" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-603"><a href="#cb72-603" aria-hidden="true" tabindex="-1"></a>tbl_arranged <span class="ot">&lt;-</span> <span class="fu">arrange</span>(tbl, pib)</span>
<span id="cb72-604"><a href="#cb72-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-605"><a href="#cb72-605" aria-hidden="true" tabindex="-1"></a>tbl_arranged</span>
<span id="cb72-606"><a href="#cb72-606" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-607"><a href="#cb72-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-608"><a href="#cb72-608" aria-hidden="true" tabindex="-1"></a>O padrão da função é de sempre ordenar de maneira crescente (do menor para o maior). Para inverter este comportamento pode-se usar a função <span class="in">`desc`</span> ou o sinal de menos.</span>
<span id="cb72-609"><a href="#cb72-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-612"><a href="#cb72-612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-613"><a href="#cb72-613" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-614"><a href="#cb72-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-615"><a href="#cb72-615" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Ordena as cidades por PIB em ordem decrescente (maior ao menor)</span></span>
<span id="cb72-616"><a href="#cb72-616" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(tbl, <span class="fu">desc</span>(pib))</span>
<span id="cb72-617"><a href="#cb72-617" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Ordena as cidades por PIB em ordem decrescente (maior ao menor)</span></span>
<span id="cb72-618"><a href="#cb72-618" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(tbl, <span class="sc">-</span>pib)</span>
<span id="cb72-619"><a href="#cb72-619" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-620"><a href="#cb72-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-621"><a href="#cb72-621" aria-hidden="true" tabindex="-1"></a>A função <span class="in">`arrange`</span> ordena strings em ordem alfabética e Datas em ordem cronológica.</span>
<span id="cb72-622"><a href="#cb72-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-623"><a href="#cb72-623" aria-hidden="true" tabindex="-1"></a><span class="fu">## mutate</span></span>
<span id="cb72-624"><a href="#cb72-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-625"><a href="#cb72-625" aria-hidden="true" tabindex="-1"></a>A função <span class="in">`mutate`</span> cria novas colunas. Em geral, cria-se uma nova coluna com base nas colunas pré-existentes, mas a expressão é bastante geral na forma <span class="in">`mutate(tbl, nova_coluna = …)`</span>. Novamente, vou omitir as saídas para poupar espaço.</span>
<span id="cb72-626"><a href="#cb72-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-629"><a href="#cb72-629" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-630"><a href="#cb72-630" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-631"><a href="#cb72-631" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Cria uma coluna onde todas as entradas são iguais a 1</span></span>
<span id="cb72-632"><a href="#cb72-632" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="at">id =</span> <span class="dv">1</span>)</span>
<span id="cb72-633"><a href="#cb72-633" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Cria a coluna 'lpib' igual ao logaritmo natural do 'pib'</span></span>
<span id="cb72-634"><a href="#cb72-634" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="at">lpib =</span> <span class="fu">log</span>(pib))</span>
<span id="cb72-635"><a href="#cb72-635" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Cria a coluna hh igual a 'household' dividido por 1 milhão</span></span>
<span id="cb72-636"><a href="#cb72-636" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="at">hh =</span> household <span class="sc">/</span> <span class="fl">1e6</span>)</span>
<span id="cb72-637"><a href="#cb72-637" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-638"><a href="#cb72-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-639"><a href="#cb72-639" aria-hidden="true" tabindex="-1"></a>Um fato conveniente da função <span class="in">`mutate`</span> é que ela vai criando as colunas sequencialmente, assim é possível fazer diversas transformações numa mesma chamada à função. No caso abaixo, pode-se criar a variável <span class="in">`lpibpc`</span> a partir das colunas <span class="in">`lpib`</span> e <span class="in">`lpop`</span>.</span>
<span id="cb72-640"><a href="#cb72-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-643"><a href="#cb72-643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-644"><a href="#cb72-644" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-645"><a href="#cb72-645" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl,</span>
<span id="cb72-646"><a href="#cb72-646" aria-hidden="true" tabindex="-1"></a>  <span class="at">lpib =</span> <span class="fu">log</span>(pib),</span>
<span id="cb72-647"><a href="#cb72-647" aria-hidden="true" tabindex="-1"></a>  <span class="at">lpop =</span> <span class="fu">log</span>(population),</span>
<span id="cb72-648"><a href="#cb72-648" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Criando uma variável a partir de duas colunas criadas anteriormente</span></span>
<span id="cb72-649"><a href="#cb72-649" aria-hidden="true" tabindex="-1"></a>  <span class="at">lpibpc =</span> lpib <span class="sc">-</span> lpop,</span>
<span id="cb72-650"><a href="#cb72-650" aria-hidden="true" tabindex="-1"></a>  <span class="at">pibserv =</span> pib_services <span class="sc">+</span> pib_govmt_services,</span>
<span id="cb72-651"><a href="#cb72-651" aria-hidden="true" tabindex="-1"></a>  <span class="at">lpibs =</span> <span class="fu">log</span>(pibserv)</span>
<span id="cb72-652"><a href="#cb72-652" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-653"><a href="#cb72-653" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-654"><a href="#cb72-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-655"><a href="#cb72-655" aria-hidden="true" tabindex="-1"></a>Por fim, é possível transformar múltiplas colunas simultaneamente usando a função <span class="in">`across`</span> da seguinte maneira: <span class="in">`across(colunas, função)`</span>. Para indicar quais colunas quer-se transformar podemos usar a mesma lógica da função <span class="in">`select`</span>: isto é, declarando o nome das colunas, usando <span class="in">`col1:col2`</span>, ou mesmo uma função como <span class="in">`starts_with`</span>/<span class="in">`matches`</span>, etc.</span>
<span id="cb72-656"><a href="#cb72-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-659"><a href="#cb72-659" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-660"><a href="#cb72-660" aria-hidden="true" tabindex="-1"></a>tbl <span class="sc">|&gt;</span> </span>
<span id="cb72-661"><a href="#cb72-661" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(pib<span class="sc">:</span>pib_services, log)) <span class="sc">|&gt;</span> </span>
<span id="cb72-662"><a href="#cb72-662" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pib<span class="sc">:</span>pib_services)</span>
<span id="cb72-663"><a href="#cb72-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-664"><a href="#cb72-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-667"><a href="#cb72-667" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-668"><a href="#cb72-668" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-669"><a href="#cb72-669" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Aplica uma transformação log em todas as colunas entre pib e pib_services</span></span>
<span id="cb72-670"><a href="#cb72-670" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="fu">across</span>(pib<span class="sc">:</span>pib_services, log))</span>
<span id="cb72-671"><a href="#cb72-671" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Aplica uma transformação log em todas as colunas que começam com pib</span></span>
<span id="cb72-672"><a href="#cb72-672" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"pib"</span>), log))</span>
<span id="cb72-673"><a href="#cb72-673" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Divide por pib e multiplica por 100 todas as colunas entre pib_taxes e</span></span>
<span id="cb72-674"><a href="#cb72-674" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; pib_govmt_services</span></span>
<span id="cb72-675"><a href="#cb72-675" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(tbl, <span class="fu">across</span>(pib_taxes<span class="sc">:</span>pib_govmt_services, <span class="sc">~</span>.x <span class="sc">/</span> pib <span class="sc">*</span> <span class="dv">100</span>))</span>
<span id="cb72-676"><a href="#cb72-676" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-677"><a href="#cb72-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-678"><a href="#cb72-678" aria-hidden="true" tabindex="-1"></a><span class="fu">## summarise e group_by</span></span>
<span id="cb72-679"><a href="#cb72-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-680"><a href="#cb72-680" aria-hidden="true" tabindex="-1"></a><span class="fu">### Uso básico</span></span>
<span id="cb72-681"><a href="#cb72-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-682"><a href="#cb72-682" aria-hidden="true" tabindex="-1"></a>As funções <span class="in">`summarise`</span><span class="ot">[^5]</span> e <span class="in">`group_by`</span> são (quase) sempre utilizadas em conjunto e servem para resumir ou "sumarizar" os dados. A função <span class="in">`group_by`</span> agrupa os dados segundo alguma coluna. No caso da nossa base de cidades, poderíamos agrupar os dados por estado ou região, por exemplo. A função <span class="in">`summarise`</span> aplica transformações nestes dados agrupados: pode-se, por exemplo, calcular a população total de cada estado, o PIB per capita médio de cada região, etc.</span>
<span id="cb72-683"><a href="#cb72-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-684"><a href="#cb72-684" aria-hidden="true" tabindex="-1"></a><span class="ot">[^5]: </span>O <span class="in">`dplyr`</span> também aceita a função <span class="in">`summarize`</span> com 'z' ao invés de 's'. As funções são exatamente iguais e podem ser intercambiadas sem maiores problemas.</span>
<span id="cb72-685"><a href="#cb72-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-686"><a href="#cb72-686" aria-hidden="true" tabindex="-1"></a>A tabela abaixo calcula a população total de cada região e ordena os dados, de maneira decrescente, segundo a população. A partir de agora começo a usar mais o pipe nos códigos.</span>
<span id="cb72-687"><a href="#cb72-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-690"><a href="#cb72-690" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-691"><a href="#cb72-691" aria-hidden="true" tabindex="-1"></a>tbl <span class="sc">|&gt;</span> </span>
<span id="cb72-692"><a href="#cb72-692" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Agrupa por região</span></span>
<span id="cb72-693"><a href="#cb72-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_region) <span class="sc">|&gt;</span> </span>
<span id="cb72-694"><a href="#cb72-694" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Soma o total da população (dentro de cada região)</span></span>
<span id="cb72-695"><a href="#cb72-695" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">pop =</span> <span class="fu">sum</span>(population)) <span class="sc">|&gt;</span> </span>
<span id="cb72-696"><a href="#cb72-696" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&gt; Rearranja o resultado final</span></span>
<span id="cb72-697"><a href="#cb72-697" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(pop))</span>
<span id="cb72-698"><a href="#cb72-698" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-699"><a href="#cb72-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-700"><a href="#cb72-700" aria-hidden="true" tabindex="-1"></a><span class="fu">### Um pouco mais de `group_by`</span></span>
<span id="cb72-701"><a href="#cb72-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-702"><a href="#cb72-702" aria-hidden="true" tabindex="-1"></a>A função <span class="in">`group_by`</span> agrupa os dados de um <span class="in">`tibble`</span> e permite que se faça operações sobre estes grupos. Pode-se, por exemplo, calcular o share da população de cada cidade, dentro do seu estado usando <span class="in">`mutate`</span>. No caso abaixo, eu calculo o share percentual e mostro o resultado para a capital paulista. Vê-se que a capital tem cerca de 11,45 milhão de habitantes, equivalente a 25,78% da população do estado.</span>
<span id="cb72-703"><a href="#cb72-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-706"><a href="#cb72-706" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-707"><a href="#cb72-707" aria-hidden="true" tabindex="-1"></a>tbl_share_pop <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb72-708"><a href="#cb72-708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_state) <span class="sc">|&gt;</span> </span>
<span id="cb72-709"><a href="#cb72-709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pop_share =</span> population <span class="sc">/</span> <span class="fu">sum</span>(population) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb72-710"><a href="#cb72-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-711"><a href="#cb72-711" aria-hidden="true" tabindex="-1"></a>tbl_share_pop <span class="sc">|&gt;</span> </span>
<span id="cb72-712"><a href="#cb72-712" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(name_muni <span class="sc">==</span> <span class="st">"São Paulo"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-713"><a href="#cb72-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name_muni, population, pop_share)</span>
<span id="cb72-714"><a href="#cb72-714" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-715"><a href="#cb72-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-716"><a href="#cb72-716" aria-hidden="true" tabindex="-1"></a>Similarmente, pode-se combinar outras funções como <span class="in">`filter`</span>. O código abaixo filtra somente as cidades que possuem população acima da média do seu estado. Vale comparar os resultados e entender as diferenças entre cada uma das tabelas</span>
<span id="cb72-717"><a href="#cb72-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-720"><a href="#cb72-720" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-721"><a href="#cb72-721" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Filtra cidades que possuem população acima da média do seu estado</span></span>
<span id="cb72-722"><a href="#cb72-722" aria-hidden="true" tabindex="-1"></a>tbl_pop_grouped <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb72-723"><a href="#cb72-723" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_state) <span class="sc">|&gt;</span> </span>
<span id="cb72-724"><a href="#cb72-724" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(population <span class="sc">&gt;</span> <span class="fu">mean</span>(population))</span>
<span id="cb72-725"><a href="#cb72-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-726"><a href="#cb72-726" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Filtra cidades que possuem população acima da média do país</span></span>
<span id="cb72-727"><a href="#cb72-727" aria-hidden="true" tabindex="-1"></a>tbl_pop_ungrouped <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb72-728"><a href="#cb72-728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(population <span class="sc">&gt;</span> <span class="fu">mean</span>(population))</span>
<span id="cb72-729"><a href="#cb72-729" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-730"><a href="#cb72-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-731"><a href="#cb72-731" aria-hidden="true" tabindex="-1"></a><span class="fu">### Um pouco mais de `summarise`</span></span>
<span id="cb72-732"><a href="#cb72-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-733"><a href="#cb72-733" aria-hidden="true" tabindex="-1"></a>É possível fazer várias novas colunas num mesmo <span class="in">`summarise`</span>. Assim como em <span class="in">`mutate`</span> também é possível fazer transformações com colunas que foram criadas anteriormente na mesma função. No caso abaixo eu calculo o PIB e população totais de cada estado do nordeste e depois calculo o PIB per capita baseado nestes valores agregados.</span>
<span id="cb72-734"><a href="#cb72-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-737"><a href="#cb72-737" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-738"><a href="#cb72-738" aria-hidden="true" tabindex="-1"></a>tbl <span class="sc">|&gt;</span> </span>
<span id="cb72-739"><a href="#cb72-739" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(name_region <span class="sc">==</span> <span class="st">"Nordeste"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-740"><a href="#cb72-740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_state) <span class="sc">|&gt;</span> </span>
<span id="cb72-741"><a href="#cb72-741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb72-742"><a href="#cb72-742" aria-hidden="true" tabindex="-1"></a>    <span class="at">pib_uf =</span> <span class="fu">sum</span>(pib) <span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb72-743"><a href="#cb72-743" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_uf =</span> <span class="fu">sum</span>(population),</span>
<span id="cb72-744"><a href="#cb72-744" aria-hidden="true" tabindex="-1"></a>    <span class="at">pibpc_uf =</span> pib_uf <span class="sc">/</span> pop_uf</span>
<span id="cb72-745"><a href="#cb72-745" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb72-746"><a href="#cb72-746" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(pibpc_uf)</span>
<span id="cb72-747"><a href="#cb72-747" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-748"><a href="#cb72-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-749"><a href="#cb72-749" aria-hidden="true" tabindex="-1"></a>A função <span class="in">`summarise`</span> é bastante potente. O exemplo abaixo filtra as cidades de médio-grande porte (acima de 100.000 habitantes), agrupa os dados por estado e faz:</span>
<span id="cb72-750"><a href="#cb72-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-751"><a href="#cb72-751" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>O total (soma) da população (cidades com mais de 100.000 habitantes, por estado).</span>
<span id="cb72-752"><a href="#cb72-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-753"><a href="#cb72-753" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Calcula a média da população (entre as cidades com mais de 100.000 habitantes, por estado).</span>
<span id="cb72-754"><a href="#cb72-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-755"><a href="#cb72-755" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Calcula a população máxima (idem).</span>
<span id="cb72-756"><a href="#cb72-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-757"><a href="#cb72-757" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Calcula os quintis da distribuição da população (idem).</span>
<span id="cb72-758"><a href="#cb72-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-759"><a href="#cb72-759" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Faz uma regressão linear entre a população e o PIB (idem).</span>
<span id="cb72-760"><a href="#cb72-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-761"><a href="#cb72-761" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Faz uma regressão linear entre a população e o PIB e extrai o R2 (idem).</span>
<span id="cb72-762"><a href="#cb72-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-763"><a href="#cb72-763" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Conta o número de cidades (idem).</span>
<span id="cb72-764"><a href="#cb72-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-767"><a href="#cb72-767" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-768"><a href="#cb72-768" aria-hidden="true" tabindex="-1"></a>tbl_summary <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb72-769"><a href="#cb72-769" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(population <span class="sc">&gt;</span> <span class="dv">100000</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-770"><a href="#cb72-770" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_state) <span class="sc">|&gt;</span> </span>
<span id="cb72-771"><a href="#cb72-771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb72-772"><a href="#cb72-772" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_uf =</span> <span class="fu">sum</span>(population),</span>
<span id="cb72-773"><a href="#cb72-773" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_avg =</span> <span class="fu">mean</span>(population),</span>
<span id="cb72-774"><a href="#cb72-774" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_max =</span> <span class="fu">max</span>(population),</span>
<span id="cb72-775"><a href="#cb72-775" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_ntile =</span> <span class="fu">list</span>(<span class="fu">quantile</span>(population, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span>))),</span>
<span id="cb72-776"><a href="#cb72-776" aria-hidden="true" tabindex="-1"></a>    <span class="at">reg =</span> <span class="fu">list</span>(<span class="fu">lm</span>(population <span class="sc">~</span> pib)),</span>
<span id="cb72-777"><a href="#cb72-777" aria-hidden="true" tabindex="-1"></a>    <span class="at">reg_r2 =</span> <span class="fu">summary</span>(<span class="fu">lm</span>(population <span class="sc">~</span> pib))<span class="sc">$</span>r.squared,</span>
<span id="cb72-778"><a href="#cb72-778" aria-hidden="true" tabindex="-1"></a>    <span class="at">count =</span> <span class="fu">n</span>()</span>
<span id="cb72-779"><a href="#cb72-779" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb72-780"><a href="#cb72-780" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(count))</span>
<span id="cb72-781"><a href="#cb72-781" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-782"><a href="#cb72-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-783"><a href="#cb72-783" aria-hidden="true" tabindex="-1"></a>Nem tudo o que fiz acima faz muito sentido, mas ilustra a capacidade da função <span class="in">`summarise`</span> de gerar informação e a flexibilidade de um <span class="in">`tibble`</span> para armazenar diferentes tipos de output. Note que as funções foram todas executadas dentro dos respectivos grupos.</span>
<span id="cb72-784"><a href="#cb72-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-785"><a href="#cb72-785" aria-hidden="true" tabindex="-1"></a>No código abaixo pode-se verificar os quintis da população das cidades de Minas Gerais.</span>
<span id="cb72-786"><a href="#cb72-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-789"><a href="#cb72-789" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-790"><a href="#cb72-790" aria-hidden="true" tabindex="-1"></a>tbl_summary <span class="sc">|&gt;</span> </span>
<span id="cb72-791"><a href="#cb72-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(name_state <span class="sc">==</span> <span class="st">"Minas Gerais"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-792"><a href="#cb72-792" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(pop_ntile)</span>
<span id="cb72-793"><a href="#cb72-793" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-794"><a href="#cb72-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-795"><a href="#cb72-795" aria-hidden="true" tabindex="-1"></a>Já no código abaixo pode-se verificar o resultado da regressão entre população e PIB feita somente nos municípios grandes de São Paulo.</span>
<span id="cb72-796"><a href="#cb72-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-799"><a href="#cb72-799" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-800"><a href="#cb72-800" aria-hidden="true" tabindex="-1"></a>reg_sp <span class="ot">&lt;-</span> <span class="fu">filter</span>(tbl_summary, name_state <span class="sc">==</span> <span class="st">"São Paulo"</span>)[[<span class="st">"reg"</span>]]</span>
<span id="cb72-801"><a href="#cb72-801" aria-hidden="true" tabindex="-1"></a>reg_sp <span class="ot">&lt;-</span> reg_sp[[<span class="dv">1</span>]]</span>
<span id="cb72-802"><a href="#cb72-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-803"><a href="#cb72-803" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(reg_sp)</span>
<span id="cb72-804"><a href="#cb72-804" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-805"><a href="#cb72-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-806"><a href="#cb72-806" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adendos técnicos</span></span>
<span id="cb72-807"><a href="#cb72-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-808"><a href="#cb72-808" aria-hidden="true" tabindex="-1"></a>Vale notar que a função <span class="in">`group_by`</span> trasnforma um <span class="in">`tibble`</span> num <span class="in">`grouped_df`</span>. Para desfazer esta transformação é preciso usar <span class="in">`ungroup`</span>. De fato, é uma boa prática sempre utilizar <span class="in">`ungroup`</span> depois de usar um <span class="in">`group_by`</span>. Por exemplo, no caso em que se calcula o share percentual da população de cada município em seu respectivo estado, é importante desagrupar os dados.</span>
<span id="cb72-809"><a href="#cb72-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-812"><a href="#cb72-812" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-813"><a href="#cb72-813" aria-hidden="true" tabindex="-1"></a>tbl_share_pop <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb72-814"><a href="#cb72-814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name_state) <span class="sc">|&gt;</span> </span>
<span id="cb72-815"><a href="#cb72-815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pop_share =</span> population <span class="sc">/</span> <span class="fu">sum</span>(population) <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-816"><a href="#cb72-816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb72-817"><a href="#cb72-817" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-818"><a href="#cb72-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-819"><a href="#cb72-819" aria-hidden="true" tabindex="-1"></a>Esta prática serve para evitar erros potenciais e, infelizmente, é necessária em alguns casos, como quando se quer combinar duas bases distintas. Atualmente, existe uma sintaxe experimental, fortemente inspirada na sintaxe do <span class="in">`data.table`</span>, que desagrupa os dados por padrão. No caso do código abaixo não é preciso utilizar <span class="in">`ungroup()`</span>.</span>
<span id="cb72-820"><a href="#cb72-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-821"><a href="#cb72-821" aria-hidden="true" tabindex="-1"></a>Pessoalmente, gosto bastante desta sintaxe, mas como ela ainda está em fase experimental, é melhor esperar um pouco para utilizá-la.</span>
<span id="cb72-822"><a href="#cb72-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-825"><a href="#cb72-825" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-826"><a href="#cb72-826" aria-hidden="true" tabindex="-1"></a>tbl_share_pop <span class="ot">&lt;-</span> tbl <span class="sc">|&gt;</span> </span>
<span id="cb72-827"><a href="#cb72-827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb72-828"><a href="#cb72-828" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_share =</span> population <span class="sc">/</span> <span class="fu">sum</span>(population) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb72-829"><a href="#cb72-829" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="st">"name_state"</span>)</span>
<span id="cb72-830"><a href="#cb72-830" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-831"><a href="#cb72-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-832"><a href="#cb72-832" aria-hidden="true" tabindex="-1"></a>Este mesmo <span class="in">`.by`</span> pode ser utilizado dentro de <span class="in">`summarise`</span>, <span class="in">`filter`</span>, etc.</span>
<span id="cb72-833"><a href="#cb72-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-834"><a href="#cb72-834" aria-hidden="true" tabindex="-1"></a><span class="fu"># Formato dos dados</span></span>
<span id="cb72-835"><a href="#cb72-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-836"><a href="#cb72-836" aria-hidden="true" tabindex="-1"></a>O princípio geral da formatação dos dados, dentro do <span class="in">`tidyverse`</span>, segue a lógica exposta em Wickham (2014):</span>
<span id="cb72-837"><a href="#cb72-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-838"><a href="#cb72-838" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Toda variável é uma coluna.</span>
<span id="cb72-839"><a href="#cb72-839" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Cada observação é uma linha.</span>
<span id="cb72-840"><a href="#cb72-840" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Todo tipo de "unidade observacional" é uma tabela única.</span>
<span id="cb72-841"><a href="#cb72-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-842"><a href="#cb72-842" aria-hidden="true" tabindex="-1"></a>Vale adicionar que o nome da coluna deve ser o nome de uma *variável* e não de um *valor*.</span>
<span id="cb72-843"><a href="#cb72-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-844"><a href="#cb72-844" aria-hidden="true" tabindex="-1"></a>É importante frisar este ponto: uma tabela é uma coleção organizada de **valores** (números ou texto). Cada *valor* pertence a uma *única variável e uma única observação*. Por exemplo: 171 é a altura (variável) de João (observação) em centímetros. Uma **variável** contém todos os valores que mensuram o mesmo atributo (e.g. altura, peso, IMC, etc.). Uma **observação** contém todos os valores mensurados no mesmo sujeito/objeto (e.g. um indivíduo, um dia específico, uma rodada de um experimento, etc.).</span>
<span id="cb72-845"><a href="#cb72-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-846"><a href="#cb72-846" aria-hidden="true" tabindex="-1"></a><span class="fu">## Contra-exemplos</span></span>
<span id="cb72-847"><a href="#cb72-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-848"><a href="#cb72-848" aria-hidden="true" tabindex="-1"></a>Vamos começar explorando alguns contra-exemplos de dados que não estão em formato "tidy".</span>
<span id="cb72-849"><a href="#cb72-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-850"><a href="#cb72-850" aria-hidden="true" tabindex="-1"></a><span class="fu">### Vendas de casas e apartamentos</span></span>
<span id="cb72-851"><a href="#cb72-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-852"><a href="#cb72-852" aria-hidden="true" tabindex="-1"></a>A tabela abaixo segue um formato tipicamente encontrando em planilhas de Excel. A primeira coluna define: (vendas de) apartamentos, casas e o total. Cada coluna subsequente representa um mês diferente; os valores de cada linha representam o número de vendas de cada tipo em cada mês.</span>
<span id="cb72-853"><a href="#cb72-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-856"><a href="#cb72-856" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-857"><a href="#cb72-857" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-858"><a href="#cb72-858" aria-hidden="true" tabindex="-1"></a>  <span class="at">nome =</span> <span class="fu">c</span>(<span class="st">"Apartamentos"</span>, <span class="st">"Casas"</span>, <span class="st">"Total"</span>),</span>
<span id="cb72-859"><a href="#cb72-859" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-01</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">900</span>, <span class="dv">100</span>, <span class="dv">1000</span>),</span>
<span id="cb72-860"><a href="#cb72-860" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-02</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">850</span>, <span class="dv">120</span>, <span class="dv">970</span>),</span>
<span id="cb72-861"><a href="#cb72-861" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-03</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">875</span>, <span class="dv">125</span>, <span class="dv">1000</span>),</span>
<span id="cb72-862"><a href="#cb72-862" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-04</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">920</span>, <span class="dv">100</span>, <span class="dv">1020</span>),</span>
<span id="cb72-863"><a href="#cb72-863" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-864"><a href="#cb72-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-865"><a href="#cb72-865" aria-hidden="true" tabindex="-1"></a>dat</span>
<span id="cb72-866"><a href="#cb72-866" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-867"><a href="#cb72-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-868"><a href="#cb72-868" aria-hidden="true" tabindex="-1"></a>Note que:</span>
<span id="cb72-869"><a href="#cb72-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-870"><a href="#cb72-870" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Cada coluna não é uma variável. A maior parte das colunas são datas, que deveriam estar todas numa única coluna.</span>
<span id="cb72-871"><a href="#cb72-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-872"><a href="#cb72-872" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Cada linha não é uma observação. Cada linha é uma série de valores de observações que varia mês a mês.</span>
<span id="cb72-873"><a href="#cb72-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-874"><a href="#cb72-874" aria-hidden="true" tabindex="-1"></a><span class="fu">### Vendas e Alugueis de apartamentos e casas</span></span>
<span id="cb72-875"><a href="#cb72-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-876"><a href="#cb72-876" aria-hidden="true" tabindex="-1"></a>Esta segunda tabela é uma versão piorada da versão acima.</span>
<span id="cb72-877"><a href="#cb72-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-880"><a href="#cb72-880" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-881"><a href="#cb72-881" aria-hidden="true" tabindex="-1"></a>dat2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-882"><a href="#cb72-882" aria-hidden="true" tabindex="-1"></a>  <span class="at">nome =</span> <span class="fu">c</span>(<span class="st">"Apartamentos"</span>, <span class="st">"Casas"</span>, <span class="st">"Total"</span>, <span class="st">"Apartamentos"</span>, <span class="st">"Casas"</span>, <span class="st">"Total"</span>),</span>
<span id="cb72-883"><a href="#cb72-883" aria-hidden="true" tabindex="-1"></a>  <span class="at">tipo =</span> <span class="fu">c</span>(<span class="st">"Venda"</span>, <span class="st">"Venda"</span>, <span class="st">"Venda"</span>, <span class="st">"Aluguel"</span>, <span class="st">"Aluguel"</span>, <span class="st">"Aluguel"</span>),</span>
<span id="cb72-884"><a href="#cb72-884" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-01</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">900</span>, <span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>),</span>
<span id="cb72-885"><a href="#cb72-885" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-02</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">850</span>, <span class="dv">120</span>, <span class="dv">970</span>, <span class="dv">60</span>, <span class="dv">80</span>, <span class="dv">140</span>),</span>
<span id="cb72-886"><a href="#cb72-886" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-03</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">875</span>, <span class="dv">125</span>, <span class="dv">1000</span>, <span class="dv">70</span>, <span class="dv">90</span>, <span class="dv">160</span>),</span>
<span id="cb72-887"><a href="#cb72-887" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2022-04</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">920</span>, <span class="dv">100</span>, <span class="dv">1020</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">100</span>),</span>
<span id="cb72-888"><a href="#cb72-888" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-889"><a href="#cb72-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-890"><a href="#cb72-890" aria-hidden="true" tabindex="-1"></a>dat2</span>
<span id="cb72-891"><a href="#cb72-891" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-892"><a href="#cb72-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-893"><a href="#cb72-893" aria-hidden="true" tabindex="-1"></a>Note que:</span>
<span id="cb72-894"><a href="#cb72-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-895"><a href="#cb72-895" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>O nome das colunas mistura variáveis e valores.</span>
<span id="cb72-896"><a href="#cb72-896" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>A linha continua não sendo uma observação.</span>
<span id="cb72-897"><a href="#cb72-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-898"><a href="#cb72-898" aria-hidden="true" tabindex="-1"></a><span class="fu">### Teste AB</span></span>
<span id="cb72-899"><a href="#cb72-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-900"><a href="#cb72-900" aria-hidden="true" tabindex="-1"></a>A tabela abaixo mostra um teste AB num formato (bem) problemático. No experimento, Bernardo e Álvares estão no grupo de tratamento, enquanto Fernando e Ricardo estão no grupo controle.</span>
<span id="cb72-901"><a href="#cb72-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-904"><a href="#cb72-904" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-905"><a href="#cb72-905" aria-hidden="true" tabindex="-1"></a>dat3 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-906"><a href="#cb72-906" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="fu">c</span>(<span class="st">"Bernardo"</span>, <span class="st">"Álvares"</span>, <span class="st">"Fernando"</span>, <span class="st">"Ricardo"</span>),</span>
<span id="cb72-907"><a href="#cb72-907" aria-hidden="true" tabindex="-1"></a>  <span class="at">controle =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">7.2</span>, <span class="fl">5.1</span>),</span>
<span id="cb72-908"><a href="#cb72-908" aria-hidden="true" tabindex="-1"></a>  <span class="at">tratamento =</span> <span class="fu">c</span>(<span class="fl">6.4</span>, <span class="fl">5.5</span>, <span class="cn">NA</span>, <span class="cn">NA</span>)</span>
<span id="cb72-909"><a href="#cb72-909" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-910"><a href="#cb72-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-911"><a href="#cb72-911" aria-hidden="true" tabindex="-1"></a>dat3</span>
<span id="cb72-912"><a href="#cb72-912" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-913"><a href="#cb72-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-914"><a href="#cb72-914" aria-hidden="true" tabindex="-1"></a>Note que:</span>
<span id="cb72-915"><a href="#cb72-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-916"><a href="#cb72-916" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Nem 'controle' e nem 'tratamento' são variáveis, já que são valores de uma mesma variável "qual grupo que está o indivíduo".</span>
<span id="cb72-917"><a href="#cb72-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-918"><a href="#cb72-918" aria-hidden="true" tabindex="-1"></a>Alternativamente, pode-se ter:</span>
<span id="cb72-919"><a href="#cb72-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-922"><a href="#cb72-922" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-923"><a href="#cb72-923" aria-hidden="true" tabindex="-1"></a>dat31 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-924"><a href="#cb72-924" aria-hidden="true" tabindex="-1"></a>  <span class="at">grupo =</span> <span class="fu">c</span>(<span class="st">"controle"</span>, <span class="st">"tratamento"</span>),</span>
<span id="cb72-925"><a href="#cb72-925" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Bernardo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fl">6.4</span>),</span>
<span id="cb72-926"><a href="#cb72-926" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Álvares</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fl">5.5</span>),</span>
<span id="cb72-927"><a href="#cb72-927" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Fernando</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">7.2</span>, <span class="cn">NA</span>),</span>
<span id="cb72-928"><a href="#cb72-928" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Ricardo</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">5.1</span>, <span class="cn">NA</span>)</span>
<span id="cb72-929"><a href="#cb72-929" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-930"><a href="#cb72-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-931"><a href="#cb72-931" aria-hidden="true" tabindex="-1"></a>dat31</span>
<span id="cb72-932"><a href="#cb72-932" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-933"><a href="#cb72-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-934"><a href="#cb72-934" aria-hidden="true" tabindex="-1"></a>Agora 'controle' e 'tratamento' estão corretamente dentro de uma mesma coluna, mas cada coluna representa um indivíduo diferente e não uma variável. "Bernardo" não é uma variável e sim um valor (nome do indivíduo).</span>
<span id="cb72-935"><a href="#cb72-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-936"><a href="#cb72-936" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cidades</span></span>
<span id="cb72-937"><a href="#cb72-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-938"><a href="#cb72-938" aria-hidden="true" tabindex="-1"></a>A tabela abaixo mostra dados hipóteticos de PIB e população de duas cidades.</span>
<span id="cb72-939"><a href="#cb72-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-942"><a href="#cb72-942" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-943"><a href="#cb72-943" aria-hidden="true" tabindex="-1"></a>dat4 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-944"><a href="#cb72-944" aria-hidden="true" tabindex="-1"></a>  <span class="at">nome_cidade =</span> <span class="fu">c</span>(<span class="st">"São Paulo"</span>, <span class="st">"Porto Alegre"</span>),</span>
<span id="cb72-945"><a href="#cb72-945" aria-hidden="true" tabindex="-1"></a>  <span class="at">pib_2020 =</span> <span class="fu">c</span>(<span class="dv">1000</span>, <span class="dv">500</span>),</span>
<span id="cb72-946"><a href="#cb72-946" aria-hidden="true" tabindex="-1"></a>  <span class="at">pib_2021 =</span> <span class="fu">c</span>(<span class="dv">1200</span>, <span class="dv">700</span>),</span>
<span id="cb72-947"><a href="#cb72-947" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop_2020 =</span> <span class="fu">c</span>(<span class="dv">1100</span>, <span class="dv">110</span>),</span>
<span id="cb72-948"><a href="#cb72-948" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop_2021 =</span> <span class="fu">c</span>(<span class="dv">1200</span>, <span class="dv">120</span>)</span>
<span id="cb72-949"><a href="#cb72-949" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-950"><a href="#cb72-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-951"><a href="#cb72-951" aria-hidden="true" tabindex="-1"></a>dat4</span>
<span id="cb72-952"><a href="#cb72-952" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-953"><a href="#cb72-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-954"><a href="#cb72-954" aria-hidden="true" tabindex="-1"></a>Note que:</span>
<span id="cb72-955"><a href="#cb72-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-956"><a href="#cb72-956" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Há mais de uma variável por coluna: a coluna pib_2020 indica duas informações: o ano da observação e o que está sendo mensurado (PIB).</span>
<span id="cb72-957"><a href="#cb72-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-958"><a href="#cb72-958" aria-hidden="true" tabindex="-1"></a><span class="fu">### Casas e Apartamentos</span></span>
<span id="cb72-959"><a href="#cb72-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-960"><a href="#cb72-960" aria-hidden="true" tabindex="-1"></a>Nesta tabela o nome das colunas mistura variáveis e valores.</span>
<span id="cb72-961"><a href="#cb72-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-964"><a href="#cb72-964" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-965"><a href="#cb72-965" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-966"><a href="#cb72-966" aria-hidden="true" tabindex="-1"></a>  <span class="at">cidade =</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>),</span>
<span id="cb72-967"><a href="#cb72-967" aria-hidden="true" tabindex="-1"></a>  <span class="at">financiado_apto_2020 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb72-968"><a href="#cb72-968" aria-hidden="true" tabindex="-1"></a>  <span class="at">vista_apto_2020 =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</span>
<span id="cb72-969"><a href="#cb72-969" aria-hidden="true" tabindex="-1"></a>  <span class="at">permuta_casa_2020 =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb72-970"><a href="#cb72-970" aria-hidden="true" tabindex="-1"></a>  <span class="at">vista_casa_2020 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb72-971"><a href="#cb72-971" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-972"><a href="#cb72-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-973"><a href="#cb72-973" aria-hidden="true" tabindex="-1"></a>data</span>
<span id="cb72-974"><a href="#cb72-974" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-975"><a href="#cb72-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-976"><a href="#cb72-976" aria-hidden="true" tabindex="-1"></a><span class="fu">## Organizando</span></span>
<span id="cb72-977"><a href="#cb72-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-978"><a href="#cb72-978" aria-hidden="true" tabindex="-1"></a>Sendo bastante franco, acho difícil explicar a intuição por trás das funções <span class="in">`pivot_longer`</span> e <span class="in">`pivot_wider`</span>. No caso da primeira função tem-se:</span>
<span id="cb72-979"><a href="#cb72-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-982"><a href="#cb72-982" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-983"><a href="#cb72-983" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-984"><a href="#cb72-984" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb72-985"><a href="#cb72-985" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb72-986"><a href="#cb72-986" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> ...,</span>
<span id="cb72-987"><a href="#cb72-987" aria-hidden="true" tabindex="-1"></a>    <span class="co">#&gt; Argumentos opcionais</span></span>
<span id="cb72-988"><a href="#cb72-988" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"name"</span>,</span>
<span id="cb72-989"><a href="#cb72-989" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb72-990"><a href="#cb72-990" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-991"><a href="#cb72-991" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-992"><a href="#cb72-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-993"><a href="#cb72-993" aria-hidden="true" tabindex="-1"></a>onde <span class="in">`cols`</span> indica quais colunas devem ser convertidas em formato longitudinal. Este argumento é bastante flexível e segue as mesmas regras da função <span class="in">`select`</span>. Por exemplo:</span>
<span id="cb72-994"><a href="#cb72-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-997"><a href="#cb72-997" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-998"><a href="#cb72-998" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-999"><a href="#cb72-999" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>date)</span>
<span id="cb72-1000"><a href="#cb72-1000" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"pib"</span>))</span>
<span id="cb72-1001"><a href="#cb72-1001" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"x1"</span>, <span class="st">"x2"</span>))</span>
<span id="cb72-1002"><a href="#cb72-1002" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1003"><a href="#cb72-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1004"><a href="#cb72-1004" aria-hidden="true" tabindex="-1"></a>Já a função <span class="in">`pivot_wider`</span> é mais exigente:</span>
<span id="cb72-1005"><a href="#cb72-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1008"><a href="#cb72-1008" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1009"><a href="#cb72-1009" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb72-1010"><a href="#cb72-1010" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb72-1011"><a href="#cb72-1011" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb72-1012"><a href="#cb72-1012" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> ...,</span>
<span id="cb72-1013"><a href="#cb72-1013" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> ...,</span>
<span id="cb72-1014"><a href="#cb72-1014" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> ...</span>
<span id="cb72-1015"><a href="#cb72-1015" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-1016"><a href="#cb72-1016" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1017"><a href="#cb72-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1018"><a href="#cb72-1018" aria-hidden="true" tabindex="-1"></a>O primeiro argumento indica qual coluna identifica unicamente os valores; o segundo argumento indica quais valores devem ser convertidos em colunas (variáveis); o terceiro argumento indica quais valores devem ser convertido em valores (sim, é isto mesmo). A função "desfaz" o que a <span class="in">`pivot_longer`</span> "faz", mas também pode fazer novas tabelas e também condensar informação. Pra piorar a situação, ambas as funções tem vários argumentos opcionais, que muitas vezes são super úteis.</span>
<span id="cb72-1019"><a href="#cb72-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1020"><a href="#cb72-1020" aria-hidden="true" tabindex="-1"></a>Como num jogo, explicar as regras em voz-alta parece torná-lo mais complicado do que é. A melhor dica que posso dar é que se pratique bastante. Alternativamente, considere também as funções:</span>
<span id="cb72-1021"><a href="#cb72-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1022"><a href="#cb72-1022" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`data.table::melt`</span> ou <span class="in">`reshape2::melt`</span>. É preciso escolher as colunas "identificadoras" e as colunas de "mensuração". Eu penso no "id" como o que identifica unicamente cada linha e "measure" como o que identifica o que está sendo mensurado. Por exemplo: na tabela abaixo temos o preços de duas ações em dois dias distintos.</span>
<span id="cb72-1023"><a href="#cb72-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1026"><a href="#cb72-1026" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1027"><a href="#cb72-1027" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-1028"><a href="#cb72-1028" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">c</span>(<span class="fu">as.Date</span>(<span class="st">"2023-05-04"</span>), <span class="fu">as.Date</span>(<span class="st">"2023-05-05"</span>)),</span>
<span id="cb72-1029"><a href="#cb72-1029" aria-hidden="true" tabindex="-1"></a>  <span class="at">PETR4 =</span> <span class="fu">c</span>(<span class="fl">23.02</span>, <span class="dv">24</span>),</span>
<span id="cb72-1030"><a href="#cb72-1030" aria-hidden="true" tabindex="-1"></a>  <span class="at">CYRE3 =</span> <span class="fu">c</span>(<span class="fl">15.54</span>, <span class="fl">15.97</span>)</span>
<span id="cb72-1031"><a href="#cb72-1031" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-1032"><a href="#cb72-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1033"><a href="#cb72-1033" aria-hidden="true" tabindex="-1"></a>tab</span>
<span id="cb72-1034"><a href="#cb72-1034" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1035"><a href="#cb72-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1036"><a href="#cb72-1036" aria-hidden="true" tabindex="-1"></a>Para converter em formato "tidy" ou longitudinal, declara-se quais as colunas identificam a observação e quais as colunas indicam o que está sendo mensurado.</span>
<span id="cb72-1037"><a href="#cb72-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1040"><a href="#cb72-1040" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1041"><a href="#cb72-1041" aria-hidden="true" tabindex="-1"></a>reshape2<span class="sc">::</span><span class="fu">melt</span>(tab, <span class="at">id.vars =</span> <span class="st">"data"</span>, <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">"PETR4"</span>, <span class="st">"CYRE3"</span>))</span>
<span id="cb72-1042"><a href="#cb72-1042" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1043"><a href="#cb72-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1044"><a href="#cb72-1044" aria-hidden="true" tabindex="-1"></a>Neste caso particular, é útil saber que o argumento <span class="in">`measure.vars`</span> pode ser omitido</span>
<span id="cb72-1045"><a href="#cb72-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1048"><a href="#cb72-1048" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1049"><a href="#cb72-1049" aria-hidden="true" tabindex="-1"></a>reshape2<span class="sc">::</span><span class="fu">melt</span>(tab, <span class="at">id.vars =</span> <span class="st">"data"</span>)</span>
<span id="cb72-1050"><a href="#cb72-1050" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1051"><a href="#cb72-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1052"><a href="#cb72-1052" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>O contrário destas funções é <span class="in">`data.table::dcast`</span> ou <span class="in">`reshape2::dcast`</span>, cuja sintaxe é um pouco mais estranha, mas bastante intuitiva.</span>
<span id="cb72-1053"><a href="#cb72-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1056"><a href="#cb72-1056" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1057"><a href="#cb72-1057" aria-hidden="true" tabindex="-1"></a>long <span class="ot">&lt;-</span> reshape2<span class="sc">::</span><span class="fu">melt</span>(tab, <span class="at">id.vars =</span> <span class="st">"data"</span>)</span>
<span id="cb72-1058"><a href="#cb72-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1059"><a href="#cb72-1059" aria-hidden="true" tabindex="-1"></a>reshape2<span class="sc">::</span><span class="fu">dcast</span>(long, data <span class="sc">~</span> variable)</span>
<span id="cb72-1060"><a href="#cb72-1060" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1061"><a href="#cb72-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1062"><a href="#cb72-1062" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`tidyr::gather`</span> que é a versão antiga de <span class="in">`pivot_longer`</span>. Pessoalmente, sempre achei esta função bastante confusa, mas, ela talvez seja mais intuitiva para você.</span>
<span id="cb72-1063"><a href="#cb72-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1066"><a href="#cb72-1066" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1067"><a href="#cb72-1067" aria-hidden="true" tabindex="-1"></a><span class="fu">gather</span>(tab, <span class="st">"ticker"</span>, <span class="st">"price"</span>, <span class="sc">-</span>data)</span>
<span id="cb72-1068"><a href="#cb72-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1069"><a href="#cb72-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1072"><a href="#cb72-1072" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1073"><a href="#cb72-1073" aria-hidden="true" tabindex="-1"></a>long <span class="ot">&lt;-</span> <span class="fu">gather</span>(tab, <span class="st">"ticker"</span>, <span class="st">"price"</span>, <span class="sc">-</span>data)</span>
<span id="cb72-1074"><a href="#cb72-1074" aria-hidden="true" tabindex="-1"></a><span class="fu">spread</span>(long, <span class="st">"ticker"</span>, <span class="st">"price"</span>)</span>
<span id="cb72-1075"><a href="#cb72-1075" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1076"><a href="#cb72-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1077"><a href="#cb72-1077" aria-hidden="true" tabindex="-1"></a>Neste caso simples, o par <span class="in">`gather`</span>/<span class="in">`spread`</span> parece bastante conveniente, mas em casos mais complexos esta sintaxe limitada torna-se bastante problemática.</span>
<span id="cb72-1078"><a href="#cb72-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1079"><a href="#cb72-1079" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exemplo 1</span></span>
<span id="cb72-1080"><a href="#cb72-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1083"><a href="#cb72-1083" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1084"><a href="#cb72-1084" aria-hidden="true" tabindex="-1"></a>dat</span>
<span id="cb72-1085"><a href="#cb72-1085" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1086"><a href="#cb72-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1087"><a href="#cb72-1087" aria-hidden="true" tabindex="-1"></a>Este caso é bem simples, pois todas as colunas, exceto a primeira, são uma única variável (as datas do mês). A função <span class="in">`rename`</span> é usada somente para deixar mais evidente que a primeira coluna contém a tipologia do que foi vendido. O argumento <span class="in">`values_to`</span> também é opcional.</span>
<span id="cb72-1088"><a href="#cb72-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1091"><a href="#cb72-1091" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1092"><a href="#cb72-1092" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb72-1093"><a href="#cb72-1093" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tipologia =</span> nome) <span class="sc">|&gt;</span> </span>
<span id="cb72-1094"><a href="#cb72-1094" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>tipologia, <span class="at">names_to =</span> <span class="st">"data"</span>, <span class="at">values_to =</span> <span class="st">"unidades"</span>)</span>
<span id="cb72-1095"><a href="#cb72-1095" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1096"><a href="#cb72-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1097"><a href="#cb72-1097" aria-hidden="true" tabindex="-1"></a>Note que agora:</span>
<span id="cb72-1098"><a href="#cb72-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1099"><a href="#cb72-1099" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Cada linha é uma observação: 900 é o valor de apartamentos vendidos em 2022-01.</span>
<span id="cb72-1100"><a href="#cb72-1100" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Cada coluna é uma variável: a primeira coluna define a 'tipologia', a segunda coluna define a 'data' e a terceira coluna é o número de 'unidades'.</span>
<span id="cb72-1101"><a href="#cb72-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1102"><a href="#cb72-1102" aria-hidden="true" tabindex="-1"></a>Por fim, para ser mais completo pode-se converter a data num formato padrão.</span>
<span id="cb72-1103"><a href="#cb72-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1106"><a href="#cb72-1106" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1107"><a href="#cb72-1107" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb72-1108"><a href="#cb72-1108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tipologia =</span> nome) <span class="sc">|&gt;</span> </span>
<span id="cb72-1109"><a href="#cb72-1109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>tipologia, <span class="at">names_to =</span> <span class="st">"data"</span>, <span class="at">values_to =</span> <span class="st">"unidades"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-1110"><a href="#cb72-1110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> readr<span class="sc">::</span><span class="fu">parse_date</span>(data, <span class="at">format =</span> <span class="st">"%Y-%m"</span>))</span>
<span id="cb72-1111"><a href="#cb72-1111" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1112"><a href="#cb72-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1113"><a href="#cb72-1113" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exemplo 2</span></span>
<span id="cb72-1114"><a href="#cb72-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1117"><a href="#cb72-1117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1118"><a href="#cb72-1118" aria-hidden="true" tabindex="-1"></a>dat2</span>
<span id="cb72-1119"><a href="#cb72-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1120"><a href="#cb72-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1121"><a href="#cb72-1121" aria-hidden="true" tabindex="-1"></a>O segundo exemplo é quase idêntico ao primeiro.</span>
<span id="cb72-1122"><a href="#cb72-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1125"><a href="#cb72-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1126"><a href="#cb72-1126" aria-hidden="true" tabindex="-1"></a>dat2 <span class="sc">|&gt;</span> </span>
<span id="cb72-1127"><a href="#cb72-1127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tipologia =</span> nome, <span class="at">mercado =</span> tipo) <span class="sc">|&gt;</span> </span>
<span id="cb72-1128"><a href="#cb72-1128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb72-1129"><a href="#cb72-1129" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(tipologia, mercado),</span>
<span id="cb72-1130"><a href="#cb72-1130" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"data"</span>,</span>
<span id="cb72-1131"><a href="#cb72-1131" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"unidades"</span></span>
<span id="cb72-1132"><a href="#cb72-1132" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb72-1133"><a href="#cb72-1133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">24</span>)</span>
<span id="cb72-1134"><a href="#cb72-1134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1135"><a href="#cb72-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1136"><a href="#cb72-1136" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exemplo 3</span></span>
<span id="cb72-1137"><a href="#cb72-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1140"><a href="#cb72-1140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1141"><a href="#cb72-1141" aria-hidden="true" tabindex="-1"></a>dat3</span>
<span id="cb72-1142"><a href="#cb72-1142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1143"><a href="#cb72-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1146"><a href="#cb72-1146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1147"><a href="#cb72-1147" aria-hidden="true" tabindex="-1"></a>dat3 <span class="sc">|&gt;</span> </span>
<span id="cb72-1148"><a href="#cb72-1148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>id, <span class="at">names_to =</span> <span class="st">"grupo"</span>, <span class="at">values_to =</span> <span class="st">"valor"</span>)</span>
<span id="cb72-1149"><a href="#cb72-1149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1150"><a href="#cb72-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1151"><a href="#cb72-1151" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exemplo 4</span></span>
<span id="cb72-1152"><a href="#cb72-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1155"><a href="#cb72-1155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1156"><a href="#cb72-1156" aria-hidden="true" tabindex="-1"></a>dat4</span>
<span id="cb72-1157"><a href="#cb72-1157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1158"><a href="#cb72-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1159"><a href="#cb72-1159" aria-hidden="true" tabindex="-1"></a>Neste exemplo pode-se separar as colunas facilmente usando <span class="in">`names_sep`</span> e <span class="in">`names_to`</span>.</span>
<span id="cb72-1160"><a href="#cb72-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1163"><a href="#cb72-1163" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1164"><a href="#cb72-1164" aria-hidden="true" tabindex="-1"></a>dat4 <span class="sc">|&gt;</span> </span>
<span id="cb72-1165"><a href="#cb72-1165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb72-1166"><a href="#cb72-1166" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span>nome_cidade,</span>
<span id="cb72-1167"><a href="#cb72-1167" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">"_"</span>,</span>
<span id="cb72-1168"><a href="#cb72-1168" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"variavel"</span>, <span class="st">"ano"</span>),</span>
<span id="cb72-1169"><a href="#cb72-1169" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"valor"</span></span>
<span id="cb72-1170"><a href="#cb72-1170" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-1171"><a href="#cb72-1171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1172"><a href="#cb72-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1173"><a href="#cb72-1173" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exemplo 5</span></span>
<span id="cb72-1174"><a href="#cb72-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1177"><a href="#cb72-1177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1178"><a href="#cb72-1178" aria-hidden="true" tabindex="-1"></a>data</span>
<span id="cb72-1179"><a href="#cb72-1179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1180"><a href="#cb72-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1181"><a href="#cb72-1181" aria-hidden="true" tabindex="-1"></a>Confesso que só coloquei este exemplo aqui para mostrar que é possível usar dois <span class="in">`pivot_longer`</span> em sequência para chegar num resultado útil.</span>
<span id="cb72-1182"><a href="#cb72-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1185"><a href="#cb72-1185" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1186"><a href="#cb72-1186" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span> </span>
<span id="cb72-1187"><a href="#cb72-1187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb72-1188"><a href="#cb72-1188" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span>cidade,</span>
<span id="cb72-1189"><a href="#cb72-1189" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">"_"</span>,</span>
<span id="cb72-1190"><a href="#cb72-1190" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>, <span class="st">"tipologia"</span>, <span class="st">"ano"</span>)</span>
<span id="cb72-1191"><a href="#cb72-1191" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb72-1192"><a href="#cb72-1192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb72-1193"><a href="#cb72-1193" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> financiado<span class="sc">:</span>permuta,</span>
<span id="cb72-1194"><a href="#cb72-1194" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"forma_pagamento"</span>,</span>
<span id="cb72-1195"><a href="#cb72-1195" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"unidades"</span></span>
<span id="cb72-1196"><a href="#cb72-1196" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-1197"><a href="#cb72-1197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1198"><a href="#cb72-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1199"><a href="#cb72-1199" aria-hidden="true" tabindex="-1"></a><span class="fu"># Referências e Comentários</span></span>
<span id="cb72-1200"><a href="#cb72-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1201"><a href="#cb72-1201" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Wickham, H. Centinkaya-Rundel, M. Grolemund, G. R for Data Science. 2ed.</span><span class="co">](https://r4ds.hadley.nz)</span> - Uma introdução didática ao tidyverse com aplicações para ciências de dados.</span>
<span id="cb72-1202"><a href="#cb72-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1203"><a href="#cb72-1203" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Centinkaya-Rundel, M. Teaching the tidyverse in 2023</span><span class="co">](https://www.tidyverse.org/blog/2023/08/teach-tidyverse-23/)</span> - Uma visão geral de como ensinar o <span class="in">`tidyverse`</span> na sua versão mais atual. Discute um pouco dos desafios de ensinar tantos pacotes e funções.</span>
<span id="cb72-1204"><a href="#cb72-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1205"><a href="#cb72-1205" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Wickham, H. Tidy Data. Journal of Statistical Software. 2014.</span><span class="co">](https://www.jstatsoft.org/article/view/v059i10)</span> - Artigo seminal com o conceito de tidy. Este artigo foi acompanhado dos pacotes <span class="in">`plyr`</span> e <span class="in">`reshape2`</span> que foram os embriões do <span class="in">`dplyr`</span> e <span class="in">`tidyr`</span>.</span>
<span id="cb72-1206"><a href="#cb72-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1207"><a href="#cb72-1207" aria-hidden="true" tabindex="-1"></a>Como comentei no texto, a popularidade do <span class="in">`tidyverse`</span> criou um certo consenso de que esta é a melhor forma de começar a aprender R. Ainda assim, acho que vale a pena considerar alguns dos contra-argumentos:</span>
<span id="cb72-1208"><a href="#cb72-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1209"><a href="#cb72-1209" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Matloff, N. Teach Base-R, Not Just the Tidyverse</span><span class="co">](https://github.com/matloff/TidyverseSkeptic)</span> - Um famoso argumento contra o ensino do <span class="in">`tidyverse`</span>. Essencialmente, argumenta-se que o tidyverse além de ser bastante complexo, esconde alguns aspectos fundamentais do R como vetores e operadores <span class="in">`$`</span>, o que dificulta o aprendizado da linguagem.</span>
<span id="cb72-1210"><a href="#cb72-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1211"><a href="#cb72-1211" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Matloff, N. Greatly Revised Edition of Tidyverse Skeptic</span><span class="co">](https://matloff.wordpress.com/2022/04/02/greatly-revised-edition-of-tidyverse-skeptic/)</span> - Atualização do texto anterior.</span>
<span id="cb72-1212"><a href="#cb72-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1213"><a href="#cb72-1213" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Why I don't use the Tidyverse</span><span class="co">](https://blog.ephorie.de/why-i-dont-use-the-tidyverse)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>